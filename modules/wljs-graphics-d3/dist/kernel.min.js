var node={};Object.defineProperty(node,"__esModule",{value:!0});var default_1=node.default=void 0;const t1=6/29,t2=3*t1*t1,lrgb2rgb=e=>Math.round(255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055))||0,lab2xyz=e=>e>t1?e*e*e:t2*(e-4/29);var _default=({luminance:e,a:t,b:r})=>{const a=(e+16)/116,n=.96422*lab2xyz(a+t/500),o=Number(lab2xyz(a)),i=.82521*lab2xyz(a-r/200);return{red:lrgb2rgb(3.1338561*n-1.6168667*o-.4906146*i),green:lrgb2rgb(-.9787684*n+1.9161415*o+.033454*i),blue:lrgb2rgb(.0719453*n-.2289914*o+1.4052427*i)}};function arrdims(e){return 0===e.length?0:void 0===e[0].length?1:void 0===e[0][0].length?2:void 0===e[0][0][0].length?3:void 0}default_1=node.default=_default,core.PlotInteractivity=()=>"PlotInteractivity",core["System`Private`VertexInterpolants"]=()=>{},core["Charting`DateTicksFunction"]=()=>"DateTicksFunction",core["Charting`ScaledTicks"]=(e,t)=>({type:"ScaledTicks",args:e}),core["Charting`ScaledFrameTicks"]=(e,t)=>({type:"ScaledFrameTicks",args:e}),core.DateListPlot=()=>{},core["Graphics`DPR"]=()=>window.devicePixelRatio,core["Graphics`CaptureImage64"]=async(e,t)=>{const r=t.element,a=new Deferred,n=r.getBoundingClientRect();return electronAPI.requestScreenshot({x:Math.round(n.x),y:Math.round(n.y),width:Math.round(n.width),height:Math.round(n.height)},e=>{a.resolve(e.slice(22))}),a.promise};let d3=!1,interpolatePath=!1,g2d={name:"WebObjects/Graphics"};const g2dComplex={};async function processLabel(e,t,r,a,n){let o=e,i=!1,s=[0,0];if(console.warn(o),"None"!=o){if(Array.isArray(o))if("HoldForm"==o[0]){if(Array.isArray(o[1])&&"List"==o[1][0]){const e=await interpretate(o[1][2],r);o=["HoldForm",o[1][1]],Array.isArray(e)&&(s=e)}"string"==typeof o[1]&&"'"==o[1].charAt(0)?(i=!1,o=o[1]):i=!0}else if("List"==o[0]){const e=await interpretate(o[2],r);o=o[1],"HoldForm"==o[0]&&("string"==typeof o[1]&&"'"==o[1].charAt(0)?(i=!1,o=o[1]):i=!0),Array.isArray(e)&&(s=e)}if(!i)try{return void a(await interpretate(o,r),s)}catch(e){console.warn("Err:",e),i=!0}if(i){console.warn("x-label: fallback to EditorView");n(await interpretate(["Inset",o,["JSObject",[r.xAxis.invert(0),r.yAxis.invert(0)]]],{...r,context:g2d,svg:t}),s)}}}g2dComplex.name="GraphicsComplex 2D",g2d.Pane=async(e,t)=>{throw e},interpretate.contextExpand(g2d),["FaceForm","ImageSizeAction","ImageSizeRaw","Selectable","ViewMatrix","CurrentValue","FontColor","Tiny","VertexColors","Antialiasing","Small","Plot","ListCurvePathPlot","ListLinePlot","ListPlot","Automatic","Controls","All","TickLabels","FrameTicksStyle","AlignmentPoint","AspectRatio","Axes","AxesLabel","AxesOrigin","AxesStyle","Background","BaselinePosition","BaseStyle","ColorOutput","ContentSelectable","CoordinatesToolOptions","DisplayFunction","Epilog","FormatType","Frame","FrameLabel","FrameStyle","FrameTicks","FrameTicksStyle","GridLines","GridLinesStyle","ImageMargins","ImagePadding","ImageSize","Full","LabelStyle","Method","PlotLabel","PlotRange","PlotRangeClipping","PlotRangePadding","PlotRegion","PreserveImageOptions","Prolog","RotateLabel","Ticks","TicksStyle","TransitionDuration"].map(e=>{g2d[e]=()=>e,g2d[e].update=()=>e}),g2d.Spacer=()=>{},core.GoldenRatio=()=>1.618,g2d["Graphics`Canvas"]=async(e,t)=>{let r={k:1,x:0,y:0};t.onZoom.push(e=>{r=e});const a={xAxis:t.xAxis,yAxis:t.yAxis};return t.xAxis=e=>0,t.yAxis=e=>0,t.xAxis.invert=e=>{const n=(e-r.x-t.panZoomEntites.left)/r.k;return a.xAxis.invert(n)},t.yAxis.invert=e=>{const n=(e-r.y-t.panZoomEntites.top)/r.k;return a.yAxis.invert(n)},t.panZoomEntites.canvas},g2d.HoldForm=async(e,t)=>await interpretate(e[0],t),g2d.HoldForm.update=async(e,t)=>await interpretate(e[0],t),g2d.SVGGroup=async(e,t)=>{const r=t.svg.append("g");r.attr("opacity",t.opacity);const a={...t};return a.svg=r,a.offset={x:0,y:0},a.color="rgb(68, 68, 68)",a.stroke=void 0,a.opacity=1,a.fontsize=10,a.fontfamily="sans-serif",a.strokeWidth=1.5,a.pointSize=.023,a.arrowHead=1,delete a.opacityRefs,delete a.colorRefs,t.local.group=r,await interpretate(e[0],a),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),r},g2d.SVGGroup.virtual=!0,g2d.SVGGroup.update=async(e,t)=>{},g2d.SVGGroup.updateOpacity=(e,t)=>{t.local.group.attr("opacity",t.opacity)},g2d.SVGGroup.destroy=(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.group.remove()},g2d.Scale=async(e,t)=>{const r=await interpretate(e[1],t),a=t.svg.append("g");let n;e.length>2&&(n=await interpretate(e[2],t)),t.local.group=a,await interpretate(e[0],{...t,svg:a});let o,i=a.node().getBBox();return n?(i.x=t.xAxis(n[0]),i.y=t.yAxis(n[1])):(i.x=i.x+i.width/2,i.y=i.y+i.height/2),t.local.aligment=n,"number"==typeof r?o=`translate(${i.x}, ${i.y}) scale(${r}) translate(${-i.x}, ${-i.y})`:Array.isArray(r)&&(o=`translate(${i.x}, ${i.y}) scale(${r[0]}, ${r[1]}) translate(${-i.x}, ${-i.y})`),t.local.scale=o,o&&a.attr("transform",o),a},g2d.Scale.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());let a=t.local.aligment;let n,o;n=t.local.group.node().getBBox(),a?(n.x=t.xAxis(a[0]),n.y=t.yAxis(a[1])):(n.x=n.x+n.width/2,n.y=n.y+n.height/2),"number"==typeof r?o=`translate(${n.x}, ${n.y}) scale(${r}) translate(${-n.x}, ${-n.y})`:Array.isArray(r)&&(o=`translate(${n.x}, ${n.y}) scale(${r[0]}, ${r[1]}) translate(${-n.x}, ${-n.y})`);var i=d3.interpolateString(t.local.scale,o);return t.local.group.maybeTransitionTween(t.transitionType,t.transitionDuration,"transform",function(e,t,r){return i}),t.local.scale=o,t.local.group},g2d.Scale.virtual=!0,g2d.Scale.destroy=(e,t)=>{console.log("nothing to destroy")},g2d.NamespaceBox=async(e,t)=>await interpretate(e[1],t),g2d.DynamicModuleBox=async(e,t)=>await interpretate(e[1],t),g2d.TagBox=async(e,t)=>await interpretate(e[0],t),g2d.DynamicModule=async(e,t)=>await interpretate(e[1],t),g2d["Charting`DelayedClickEffect"]=async(e,t)=>await interpretate(e[0],t),g2d.ColorProfileData=()=>{},g2d.ParametricPlot=()=>{},g2d.TransitionDuration=()=>"TransitionDuration",g2d.TransitionType=()=>"TransitionType";var assignTransition=e=>{if("transitiontype"in e)switch(e.transitiontype){case"Linear":e.transitionType=d3.easeLinear;break;case"CubicInOut":e.transitionType=d3.easeCubicInOut;break;default:e.transitionType=!1}e.transitionduration&&(e.transitionDuration=e.transitionduration)};const makeEditorView=async(e,t={global:{}})=>{const r=String(interpretate.hash(e));let a,n;if(r in ObjectHashMap)a=ObjectHashMap[r];else{a=new ObjectStorage(r);try{n=await a.get()}catch(t){console.warn("Creating FE object by id "+r),await server.kernel.io.fetch("CoffeeLiqueur`Extensions`Graphics`Private`MakeExpressionBox",[JSON.stringify(e),r]),n=await a.get()}}n||(n=await a.get()),console.log("g2d: creating an object"),console.log("frontend executable");const o=t,i=new ExecutableObject("g2d-embeded-"+uuidv4(),o,n,!0);return i.assignScope(o),a.assign(i),await i.execute(),i};let assignProto;function niceNumber(e){if("string"==typeof e)return e;if("number"!=typeof e||!isFinite(e))return String(e);if(Number.isInteger(e))return String(e);const t=trimFixed(e.toFixed(2)),r=[];for(let t=0;t<=4;t++){const a=exponentialToSuperscript(e.toExponential(t));r.push(a)}const a=shortest(r);return a.length<t.length?a:t}function trimFixed(e){return/^-?0(?:\.0+)?$/.test(e)?"0":e=(e=e.replace(/(\.\d*?[1-9])0+$/,"$1")).replace(/\.0+$/,"")}function exponentialToSuperscript(e){const t=/^(-?\d+(?:\.\d+)?)[eE]([+\-]?\d+)$/.exec(e);if(!t)return e;let r=t[1],a=t[2];r=r.replace(/(\.\d*?[1-9])0+$/,"$1").replace(/\.0+$/,""),/^-?0(?:\.0+)?$/.test(r)&&(r="0");let n=a.startsWith("-")?"-":a.startsWith("+")?"+":"",o=a.replace(/^[+\-]?0+/,"");""===o&&(o="0");return`${r}×10${toSuperscript(n+o)}`}g2d.Offset=async(e,t)=>{if(e.length<2){const r=await interpretate(e[0],t);return[t.xAxis.invert(r[0])-t.xAxis.invert(0),t.yAxis.invert(r[1])-t.yAxis.invert(0)]}const r=await interpretate(e[1],t),a={x:r[0],y:r[1]},n=await interpretate(e[0],{...t,offset:a});if(Array.isArray(n)){return[t.xAxis.invert(n[0])-t.xAxis.invert(0)+a.x,t.xAxis.invert(n[1])+a.y-t.xAxis.invert(0)]}return n},g2d.Offset.update=g2d.Offset,g2d.Dashing=async(e,t)=>{const r=await interpretate(e[0],t);Array.isArray(r)&&0==r[0]?t.dasharray=[2,2]:t.dasharray=[2,0,0,0,2]},g2d.AbsoluteDashing=async(e,t)=>{const r=await interpretate(e[0],t);t.dasharray=r},assignProto=()=>{d3.selection.prototype.maybeTransition=function(e,t){return e?this.transition().ease(e).duration(t):this},d3.selection.prototype.maybeTransitionTween=function(e,t,r,a){return e?this.transition().ease(e).duration(t).attrTween(r,a):this.attr(r,a.apply(this.node(),this.data())(1))},assignProto=()=>{}};const SUP={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻"};function toSuperscript(e){return[...e].map(e=>SUP[e]??e).join("")}function shortest(e){return e.reduce((e,t)=>t.length<e.length?t:e)}function isMobile(){if(null!=navigator.userAgentData?.mobile)return navigator.userAgentData.mobile;const e=window.matchMedia?.("(pointer: coarse)").matches,t=window.matchMedia?.("(max-width: 768px)").matches,r=navigator.maxTouchPoints>0;return!(!e||!r&&!t)||/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)}g2d.Complex=async(e,t)=>{console.warn("Complex numbers are only supported as decoration");const r=await interpretate(e[0],t),a=await interpretate(e[1],t);return 0==r?1==a?"i":-1==a?"-i":a<0?"- i "+niceNumber(Math.abs(a)):"i "+niceNumber(a):1==a?niceNumber(r)+" + i":-1==a?niceNumber(r)+" - i":a<0?niceNumber(r)+" - i"+niceNumber(Math.abs(a)):niceNumber(r)+" + i"+niceNumber(a)},g2d.Graphics=async(args,env)=>{await interpretate.shared.d3.load(),d3||(d3=interpretate.shared.d3.d3),interpolatePath||(interpolatePath=interpretate.shared.d3["d3-interpolate-path"].interpolatePath),g2d.interpolatePath=interpolatePath,g2d.d3=d3,assignProto();let options=await core._getRulesReversed(args,{...env,context:g2d,hold:!0});if(0==Object.keys(options).length&&args.length>1)if("List"===args[1][0]){const e=args[1].slice(1);options="List"===e[0][0]?await core._getRulesReversed(e[0].slice(1),{...env,context:g2d,hold:!0}):await core._getRulesReversed(e,{...env,context:g2d,hold:!0})}else options=await core._getRulesReversed(await interpretate(args[1],{...env,context:g2d,hold:!0}),{...env,context:g2d,hold:!0});console.log(options);let label=options.PlotLabel;var container=env.element;let ImageSize=await interpretate(options.ImageSize,{...env,context:g2d});"number"==typeof ImageSize?ImageSize<1&&(ImageSize=1e4*ImageSize/2):"string"==typeof ImageSize&&(ImageSize=core.DefaultWidth),ImageSize||(ImageSize=env.imageSize?Array.isArray(env.imageSize)?env.imageSize:[env.imageSize,.618034*env.imageSize]:core.DefaultWidth);let rawImage=!1;const mobileDetected=isMobile();if(mobileDetected){console.warn("Mobile device detected!");const e=2/devicePixelRatio;"number"==typeof ImageSize?(ImageSize*=e,ImageSize>250&&(ImageSize=250)):"number"==typeof ImageSize[0]&&(ImageSize[0]=ImageSize[0]*e,ImageSize[0]>250&&(ImageSize[0]=250),ImageSize[1]=ImageSize[1]*e)}if(options.ImageSizeRaw){const e=await interpretate(options.ImageSizeRaw,env);Array.isArray(e)?"number"==typeof e[0]&&"number"==typeof e[1]&&(ImageSize=e.map(e=>e/window.devicePixelRatio),rawImage=!0):"number"==typeof e&&(ImageSize=[e/window.devicePixelRatio,.618034*e/window.devicePixelRatio],rawImage=!0)}let tinyGraph=!1,deviceFactor=devicePixelRatio;mobileDetected&&(deviceFactor=2),ImageSize instanceof Array?ImageSize[0]<100*deviceFactor&&!options.PaddingIsImportant&&(tinyGraph=!0):ImageSize<100*deviceFactor&&!options.PaddingIsImportant&&(tinyGraph=!0);let axis=[!1,!1],invertedTicks=!1,ticklengths=[5,5,5,5],tickLabels=[!0,!1,!0,!1],ticks,framed=!1,axesstyle,ticksstyle;if(options.Frame&&!tinyGraph&&(options.Frame=await interpretate(options.Frame,env),!0===options.Frame?framed=!0:(!0===options.Frame[0][0]&&(framed=!0),!0===options.Frame[0]&&(framed=!0),options.Frame[1]&&!0===options.Frame[1][0]&&(axis=[!0,!1]))),options.Axes&&!tinyGraph&&(options.Axes=await interpretate(options.Axes,env),!0===options.Axes?axis=[!0,!0]:Array.isArray(options.Axes)&&(axis=options.Axes)),framed&&(invertedTicks=!0,axis=[!0,!0,!0,!0]),options.Ticks){options.Ticks=await interpretate(options.Ticks,{...env,context:g2d}),Array.isArray(ticks)||(ticks=[!0,!1,!0,!1]);const e=e=>Array.isArray(e)&&"number"==typeof e[0],t=t=>Array.isArray(t)&&Array.isArray(t[0])&&e(t[0]),r=e=>Array.isArray(e)?0!==e.length&&e:e,a=e=>Array.isArray(e)&&0===e.length?[!1,!1]:t(e)||Array.isArray(e)||"function"==typeof e||e&&"object"==typeof e&&e.type||!0===e||!1===e||"string"==typeof e||"number"==typeof e?[e,e]:[!1,!1];if(Array.isArray(options.Ticks)&&2===options.Ticks.length){const[e,a]=options.Ticks,n=r(e),o=r(a),i=(t(n),n),s=(t(o),o);ticks[0]=i,ticks[1]=s,ticks[2]=i,ticks[3]=s}else if(Array.isArray(options.Ticks)&&1===options.Ticks.length){const e=options.Ticks[0],[t,r]=a(e);ticks=[t,r,t,r]}else if(Array.isArray(options.Ticks)&&options.Ticks.length>=3){const e=options.Ticks,t=(e,t)=>{Array.isArray(t)?ticks[e]=0!==t.length&&t:!1===t||null===t?ticks[e]=!1:void 0!==t&&(ticks[e]=t)};t(0,e[0]),t(1,e[1]),t(2,e[2]),t(3,e[3])}else!0===options.Ticks?ticks=[!0,!0,!0,!0]:!1===options.Ticks?ticks=[!1,!1,!1,!1]:("function"==typeof options.Ticks||options.Ticks&&"object"==typeof options.Ticks&&options.Ticks.type)&&(ticks=[options.Ticks,options.Ticks,options.Ticks,options.Ticks]);Array.isArray(options.Ticks)&&(options.Ticks[1]?.type&&!options.Ticks[0]?.type&&(ticks=[!0,options.Ticks[1],!0,!1]),options.Ticks[0]?.type&&!options.Ticks[1]?.type&&(ticks=[options.Ticks[0],!0,!1,!1]),options.Ticks[1]?.type&&options.Ticks[0]?.type&&(ticks=[options.Ticks[0],options.Ticks[1],!1,!1]))}if(options.FrameTicks&&framed&&!tinyGraph&&(options.FrameTicks=await interpretate(options.FrameTicks,{...env,context:g2d}),ticks=[!0,!0,!0,!0],Array.isArray(options.FrameTicks)&&(Array.isArray(options.FrameTicks[0])&&(Array.isArray(options.FrameTicks[0][0])?(Number.isInteger(options.FrameTicks[0][0][0])||"string"==typeof options.FrameTicks[0][0]||Array.isArray(options.FrameTicks[0][0][0]))&&(ticks[1]=options.FrameTicks[0][0],ticks[3]=options.FrameTicks[0][1]):(ticks[1]=options.FrameTicks[0][0],ticks[3]=options.FrameTicks[0][1])),Array.isArray(options.FrameTicks[1])&&(Array.isArray(options.FrameTicks[1][0])?((Number.isInteger(options.FrameTicks[1][0][0])||"string"==typeof options.FrameTicks[1][0]||Array.isArray(options.FrameTicks[1][0][0]))&&(ticks[0]=options.FrameTicks[1][0],ticks[2]=options.FrameTicks[1][1]),0==options.FrameTicks[1][0].length&&(ticks[0]=!1),0==options.FrameTicks[1][1].length&&(ticks[2]=!1)):(ticks[0]=options.FrameTicks[1][0],ticks[2]=options.FrameTicks[1][1])))),options.FrameTicks&&!tinyGraph&&options.FrameTicks[2]&&options.FrameTicks[2][1]){let e=options.FrameTicks[2][1];Array.isArray(e)&&(e=e[1],Array.isArray(e)&&"Charting`getDateTicks"==e[0]&&(framed=!1,axis=[!0,!1]))}if(options.TickDirection){const e=await interpretate(options.TickDirection,env);"Inward"===e&&(invertedTicks=!0),"Outward"===e&&(invertedTicks=!1)}options.TickLengths&&(options.TickLengths=await interpretate(options.TickLengths,env),Array.isArray(options.TickLengths)||(ticklengths=[options.TickLengths,options.TickLengths,options.TickLengths,options.TickLengths])),options.TickLabels&&!tinyGraph&&(options.TickLabels=await interpretate(options.TickLabels,env),tickLabels=Array.isArray(options.TickLabels)?options.TickLabels.flat():[!1,!1,!1,!1]);let margin={top:0,right:0,bottom:10,left:40},padding={top:0,right:0,bottom:15,left:0};axis[2]&&(margin.top=margin.bottom,margin.left=margin.right),options.AxesLabel&&(padding.bottom=10,margin.top=30,margin.right=50,padding.right=50),framed&&(padding.left=40,padding.left=30,margin.left=30,margin.right=40,margin.top=30,padding.bottom=10,margin.bottom=35),options.ImagePadding&&(console.log("padding: "),console.log(options.ImagePadding),options.ImagePadding=await interpretate(options.ImagePadding,env),console.log(options.ImagePadding),"None"===options.ImagePadding?(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0):Number.isInteger(options.ImagePadding)?(margin.top=options.ImagePadding,margin.bottom=options.ImagePadding,margin.left=options.ImagePadding,margin.right=options.ImagePadding):Array.isArray(options.ImagePadding)?(Array.isArray(options.ImagePadding[0])&&(Number.isInteger(options.ImagePadding[0][0])&&(margin.left=options.ImagePadding[0][0]),Number.isInteger(options.ImagePadding[0][1])&&(margin.right=options.ImagePadding[0][1])),Array.isArray(options.ImagePadding[1])&&(Number.isInteger(options.ImagePadding[1][0])&&(margin.bottom=options.ImagePadding[1][0]),Number.isInteger(options.ImagePadding[1][1])&&(margin.top=options.ImagePadding[1][1]))):"All"===options.ImagePadding||(!1===options.ImagePadding?(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0):console.error("given ImagePadding is not supported!"))),options.Axes||options.Frame||options.ImagePadding||options.AxesLabel||(console.warn("Axes are absent, removing padding..."),margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding.top=0,padding.bottom=0,padding.left=0,padding.right=0),tinyGraph&&(console.warn("too small, removing padding..."),margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding.top=0,padding.bottom=0,padding.left=0,padding.right=0);let aspectratio=await interpretate(options.AspectRatio,env)||env.aspectRatio||1;"number"!=typeof aspectratio&&(aspectratio=1),ImageSize instanceof Array||(aspectratio=(aspectratio*(ImageSize-margin.left-margin.right)+margin.top+margin.bottom)/ImageSize,ImageSize=[ImageSize,ImageSize*aspectratio]);let width=ImageSize[0]-margin.left-margin.right,height=ImageSize[1]-margin.top-margin.bottom,svg;if(rawImage&&(width=ImageSize[0],height=ImageSize[1]),(width<0||height<0)&&(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding={top:0,right:0,bottom:0,left:0},width=ImageSize[0],height=ImageSize[1]),svg=d3.select(container).append("svg"),"Background"in options&&(options.Background=await interpretate(options.Background,{...env,context:g2d}),options.Background&&(svg.node().style.backgroundColor=options.Background,console.log("Background color:"+options.Background))),"ViewBox"in options){let e=await interpretate(options.ViewBox,env);e instanceof Array||(e=[0,0,e,e*aspectratio]),svg.attr("viewBox",e),env.viewBox=e}else svg.attr("width",width+margin.left+margin.right+padding.left).attr("height",height+margin.top+margin.bottom+padding.bottom),env.svgWidth=width+margin.left+margin.right+padding.left,env.svgHeight=height+margin.top+margin.bottom+padding.bottom,env.clipWidth=width,env.clipHeight=height;let svgDefs=svg.append("svg:defs"),clipOffset=0,clipMargin=2,clipRangeZoom=1,clipRangeOffset=[0,0];framed&&(clipOffset=7,clipMargin=0),svg.attr("tabindex","0");const listenerSVG=svg;svg=svg.append("g").attr("transform","translate("+(margin.left+padding.left)+","+margin.top+")");const clipId="clp"+Math.random().toFixed(4).toString().replace(".","");svg.append("clipPath").attr("id",clipId).append("rect").attr("width",width-2*clipOffset+clipMargin).attr("height",height-2*clipOffset+clipMargin).attr("x",clipOffset-clipMargin).attr("y",clipOffset-clipMargin);let range=[[-1.15,1.15],[-1.15,1.15]],unknownRanges=!0;if(options.PlotRange||env.plotRange){const e=env.plotRange||await interpretate(options.PlotRange,env);Number.isFinite(e[0][0])&&(Number.isFinite(e[1][0])?(range=e,unknownRanges=!1):(range[0]=e[0],range[1]=[-1.15,1.15]))}framed&&(clipRangeOffset=[10*(range[0][1]-range[0][0])/width,10*(range[1][1]-range[1][0])/height]);{const e=(range[0][0]+range[0][1])/2,t=(range[1][0]+range[1][1])/2;rawImage||(range=[[e+(range[0][0]-e)*clipRangeZoom-clipRangeOffset[0],e+(range[0][1]-e)*clipRangeZoom+clipRangeOffset[0]],[t+(range[1][0]-t)*clipRangeZoom-clipRangeOffset[1],t+(range[1][1]-t)*clipRangeZoom+clipRangeOffset[1]]])}let transitionType=d3.easeLinear;if(options.TransitionType){const e=await interpretate(options.TransitionType,{...env,context:g2d});switch(e){case"Linear":transitionType=d3.easeLinear;break;case"CubicInOut":transitionType=d3.easeCubicInOut;break;default:transitionType=void 0}}let niceTicks=!1,gX,gY,gTX,gRY;options.NicerTicks&&(niceTicks=!0),console.log(range);let x=d3.scaleLinear().domain(range[0]).range([0,width]),xAxis=d3.axisBottom(x),txAxis=d3.axisTop(x);if(console.log(axis),ticks)if(ticks[0])if("string"==typeof ticks[0])switch(ticks[0]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":xAxis=xAxis.tickValues([]);break;case"DateTicksFunction":x=d3.scaleTime().domain(range[0].map(e=>1e3*e-2208996e6)).range([0,width]),txAxis=d3.axisTop(x),xAxis=d3.axisBottom(x);const e=x;x=t=>e(1e3*t-2208996e6),x.copy=e.copy,x.range=e.range,x.domain=e.domain,x.invert=e.invert}else if(ticks[0]?.type){if("ScaledTicks"===ticks[0].type){x=d3.scaleLinear().domain(range[0]).range([0,width]);const mathFunction=eval("Math."+ticks[0].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};xAxis=d3.axisBottom(x).tickFormat(tickFormat)}}else if(!0===ticks[0])console.log("Default ticks");else if(Array.isArray(ticks[0][0])){const e=ticks[0].map(e=>e[1]);xAxis=xAxis.tickValues(ticks[0].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else xAxis=xAxis.tickValues(ticks[0]);else xAxis=xAxis.tickValues([]);if(ticks)if(ticks[2])if("string"==typeof ticks[2])switch(ticks[2]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":txAxis=txAxis.tickValues([]);break;case"DateTicksFunction":x=d3.scaleTime().domain(range[0].map(e=>1e3*e-2208996e6)).range([0,width]),txAxis=d3.axisTop(x).ticks(4),xAxis=d3.axisBottom(x).ticks(4);const e=x;x=t=>e(1e3*t-2208996e6),x.copy=e.copy,x.range=e.range,x.domain=e.domain,x.invert=e.invert}else if(ticks[2]?.type){if("ScaledTicks"===ticks[2].type){x=d3.scaleLinear().domain(range[0]).range([0,width]);const mathFunction=eval("Math."+ticks[2].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};txAxis=d3.axisTop(x).tickFormat(tickFormat)}}else if(!0===ticks[2])console.log("Default ticks");else if(Array.isArray(ticks[2][0])){const e=ticks[2].map(e=>e[1]);txAxis=txAxis.tickValues(ticks[2].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else txAxis=txAxis.tickValues(ticks[2]);else txAxis=txAxis.tickValues([]);let gridLines=!1;options.GridLines&&options.GridLines[1]&&(gridLines="Automatic"==options.GridLines[1]);const customLocale=d3.formatLocale({decimal:".",thousands:" ",grouping:[3],currency:["",""]}),format=customLocale.format(",");tickLabels[0]?niceTicks&&(xAxis=xAxis.tickFormat(format)):xAxis=xAxis.tickFormat(e=>""),tickLabels[1]?niceTicks&&(txAxis=txAxis.tickFormat(format)):txAxis=txAxis.tickFormat(e=>""),invertedTicks?(xAxis=xAxis.tickSizeInner(-ticklengths[0]).tickSizeOuter(0),txAxis=txAxis.tickSizeInner(-ticklengths[2]).tickSizeOuter(0)):(xAxis=xAxis.tickSizeInner(ticklengths[0]).tickSizeOuter(0),txAxis=txAxis.tickSizeInner(ticklengths[2]).tickSizeOuter(0));let y=d3.scaleLinear().domain(range[1]).range([height,0]),yAxis=d3.axisLeft(y),ryAxis=d3.axisRight(y),xGrid,yGrid,gGX,gGY;if(ticks)if(ticks[1])if("string"==typeof ticks[1])switch(ticks[1]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":yAxis=yAxis.tickValues([]);break;case"DateTicksFunction":y=d3.scaleTime().domain(range[1].map(e=>1e3*e-2208996e6)).range([0,height]),ryAxis=d3.axisRight(y),yAxis=d3.axisLeft(y);const e=y;y=t=>e(1e3*t-2208996e6),y.copy=e.copy,y.range=e.range,y.domain=e.domain,y.invert=e.invert}else if(ticks[1]?.type){if("ScaledTicks"===ticks[1].type){y=d3.scaleLinear().domain(range[1]).range([height,0]);const mathFunction=eval("Math."+ticks[1].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};yAxis=d3.axisLeft(y).tickFormat(tickFormat)}}else if(!0===ticks[1])console.log("Default ticks");else if(Array.isArray(ticks[1][0])){const e=ticks[1].map(e=>e[1]);yAxis=yAxis.tickValues(ticks[1].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else yAxis=yAxis.tickValues(ticks[1]);else yAxis=yAxis.tickValues([]);if(ticks)if(ticks[3])if("string"==typeof ticks[3])switch(ticks[3]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":ryAxis=ryAxis.tickValues([]);break;case"DateTicksFunction":y=d3.scaleTime().domain(range[1].map(e=>1e3*e-2208996e6)).range([0,height]),ryAxis=d3.axisRight(y),yAxis=d3.axisLeft(y);const e=y;y=t=>e(1e3*t-2208996e6),y.copy=e.copy,y.range=e.range,y.domain=e.domain,y.invert=e.invert}else if(ticks[3]?.type){if("ScaledTicks"===ticks[3].type){y=d3.scaleLinear().domain(range[1]).range([height,0]);const mathFunction=eval("Math."+ticks[1].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};ryAxis=d3.axisRight(y).tickFormat(tickFormat)}}else if(!0===ticks[3])console.log("Default ticks");else if(Array.isArray(ticks[3][0])){const e=ticks[3].map(e=>e[1]);ryAxis=ryAxis.tickValues(ticks[3].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else ryAxis=ryAxis.tickValues(ticks[3]);else ryAxis=ryAxis.tickValues([]);if(tickLabels[2]?niceTicks&&(yAxis=yAxis.tickFormat(format)):yAxis=yAxis.tickFormat(e=>""),tickLabels[3]?niceTicks&&(ryAxis=ryAxis.tickFormat(format)):ryAxis=ryAxis.tickFormat(e=>""),invertedTicks?(yAxis=yAxis.tickSizeInner(-ticklengths[1]).tickSizeOuter(0),ryAxis=ryAxis.tickSizeInner(-ticklengths[3]).tickSizeOuter(0)):(yAxis=yAxis.tickSizeInner(ticklengths[1]).tickSizeOuter(0),ryAxis=ryAxis.tickSizeInner(ticklengths[3]).tickSizeOuter(0)),(ticks||axis[0])&&gridLines&&(axis[0]&&(xGrid=e=>t=>t.selectAll("line").data(e.ticks()).join("line").attr("x1",t=>e(t)).attr("x2",t=>e(t)).attr("y1",0).attr("y2",height)),axis[1]&&(yGrid=e=>t=>t.selectAll("line").data(e.ticks()).join("line").attr("x1",0).attr("x2",width).attr("y1",t=>e(t)).attr("y2",t=>e(t)))),env.context=g2d,env.svg=svg.append("g"),"PlotRangeClipping"in options){const e=await interpretate(options.PlotRangeClipping,env);env.svg=e?env.svg.attr("clip-path","url(#"+clipId+")").append("g"):env.svg.append("g")}else env.svg=env.svg.attr("clip-path","url(#"+clipId+")").append("g");env.rootSVG=env.svg,env.xAxis=x,env.yAxis=y,env.defs=svgDefs,env.xGrid=xGrid,env.yGrid=yGrid,env.numerical=!0,env.tostring=!1,env.offset={x:0,y:0},env.color="rgb(68, 68, 68)",env.stroke=void 0,env.opacity=1,env.fontsize=10,env.fontfamily="sans-serif",env.strokeWidth=1.5,env.pointSize=.023,env.arrowHead=1,env.onZoom=[],env.transitionDuration=50,env.transitionType=transitionType,env.plotRange=range,axesstyle={...env},ticksstyle={...env},options.AxesStyle&&await interpretate(options.AxesStyle,axesstyle),options.FrameStyle&&(console.warn("FrameStyle"),console.log(options.FrameStyle),await interpretate(options.FrameStyle,axesstyle),console.log(axesstyle)),options.FrameTicksStyle&&await interpretate(options.FrameTicksStyle,ticksstyle);let axesOrigin=[0,height];if(!framed){const e=await interpretate(options.AxesOrigin,{...env});Array.isArray(e)&&"number"==typeof e[0]&&"number"==typeof e[1]&&(0==e[0]&&0==e[1]||(axesOrigin[0]=x(e[0]),axesOrigin[1]=y(e[1])))}yGrid&&(gGY=svg.append("g").attr("stroke","#0000002e").attr("stroke-dasharray","4 2").call(yGrid(y))),xGrid&&(gGX=svg.append("g").attr("stroke","#0000002e").attr("stroke-dasharray","4 2").call(xGrid(x))),axis[0]&&(gX=svg.append("g").attr("transform","translate(0,"+axesOrigin[1]+")").call(xAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[2]&&(gTX=svg.append("g").attr("transform","translate(0,0)").call(txAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[1]&&(gY=svg.append("g").call(yAxis).attr("transform","translate("+axesOrigin[0]+",0)").attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[3]&&(gRY=svg.append("g").attr("transform","translate("+width+", 0)").call(ryAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color));let labelStyle={...axesstyle};if(options.LabelStyle&&await interpretate(options.LabelStyle,labelStyle),label){let e=!1;Array.isArray(label)&&"HoldForm"==label[0]&&(e=!0);try{e||(label=await interpretate(label,labelStyle))}catch(t){console.warn(t),e=!0}e?(console.warn("Fallback to Inset"),await interpretate(["Inset",options.PlotLabel,["JSObject",[x.invert(width/2+labelStyle.offset.x),y.invert(0-margin.top/2+labelStyle.offset.y)]],"Top"],{...env,context:g2d,svg:svg})):g2d.Text.PutText(svg.append("text").attr("x",width/2+labelStyle.offset.x).attr("y",0-margin.top/2+labelStyle.offset.y).attr("text-anchor","middle").attr("fill",labelStyle.color).style("font-size",labelStyle.fontsize).style("font-family",labelStyle.fontfamily),label,labelStyle)}if(options.AxesLabel&&!framed&&(options.AxesLabel=await interpretate(options.AxesLabel,{...env,hold:!0}),Array.isArray(options.AxesLabel)&&(gX&&options.AxesLabel[0]&&await processLabel(options.AxesLabel[0],gX,{...env},(e,t)=>{g2d.Text.PutText(gX.append("text").attr("x",width+15+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width+15+t[0]}, ${margin.bottom+t[1]-10})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start")}),gY&&options.AxesLabel[1]&&await processLabel(options.AxesLabel[1],gY,{...env},(e,t)=>{g2d.Text.PutText(gY.append("text").attr("x",0+t[0]).attr("y",-margin.top/2+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${0+t[0]}, ${-margin.top/2+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start")}))),options.FrameLabel&&framed&&(options.FrameLabel=await interpretate(options.FrameLabel,{...env,hold:!0}),Array.isArray(options.FrameLabel))){let e=options.FrameLabel[0],t=options.FrameLabel[1],r=!1;if(Array.isArray(e)?"List"!=e[0]?(e=["List",e,"None"],r=!0):Array.isArray(e[2])&&("List"==e[2][0]?3==e[2].length&&(e=["List",e,"None"],r=!0):"HoldForm"==e[2][0]&&Array.isArray(e[2][1])&&"List"==e[2][1][0]&&3==e[2][1].length&&(e=["List",["List",e[1],e[2][1]],"None"],r=!0)):(e=["List",e,"None"],r=!0),Array.isArray(t)?"List"!=t[0]?(t=["List",t,"None"],r=!0):Array.isArray(t[2])&&("List"==t[2][0]?3==t[2].length&&(t=["List",t,"None"],r=!0):"HoldForm"==t[2][0]&&Array.isArray(t[2][1])&&"List"==t[2][1][0]&&3==t[2][1].length&&(t=["List",["List",t[1],t[2][1]],"None"],r=!0)):(t=["List",t,"None"],r=!0),r&&([t,e]=[e,t]),"None"!=e[1]&&gY){let t=e[1];await processLabel(t,gY,{...env},(e,t)=>{g2d.Text.PutText(gY.append("text").attr("transform","rotate(-90)").attr("y",-margin.left+t[0]).attr("x",-height/2+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`rotate(-90) translate(${-height/2+t[1]}, ${-margin.left+t[0]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=e[2]&&gRY){let t=e[2];await processLabel(t,gRY,{...env},(e,t)=>{g2d.Text.PutText(gRY.append("text").attr("x",0+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=t[2]&&gTX){let e=t[2];await processLabel(e,gTX,{...env},(e,t)=>{g2d.Text.PutText(gTX.append("text").attr("x",width/2+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width/2+t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=t[1]&&gX){let e=t[1];await processLabel(e,gX,{...env},(e,t)=>{g2d.Text.PutText(gX.append("text").attr("x",width/2+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width/2+t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}}options.TransitionDuration&&(env.transitionDuration=await interpretate(options.TransitionDuration,env)),env.local.xAxis=x,env.local.yAxis=y;let GUIEnabled=!1;(options.Controls||void 0===options.Controls&&!tinyGraph&&!mobileDetected)&&(void 0===options.Controls||await interpretate(options.Controls,env))&&(GUIEnabled=!0,addPanZoom(listenerSVG,svg,env.svg,gX,gY,gTX,gRY,gGX,gGY,xAxis,yAxis,txAxis,ryAxis,xGrid,yGrid,x,y,env)),env.local.listenerSVG=listenerSVG,env.panZoomEntites={canvas:listenerSVG,svg:env.svg,left:margin.left+padding.left,top:margin.top,gX:gX,gY:gY,gTX:gTX,gRY:gRY,gGX:gGX,gGY:gGY,xGrid:xGrid,yGrid:yGrid,xAxis:xAxis,yAxis:yAxis,txAxis:txAxis,ryAxis:ryAxis,x:x,y:y},env.inset;const instancesKeys=Object.keys(env.global.stack);if(await interpretate(options.Prolog,env),await interpretate(args[0],env),interpretate(options.Epilog,env),unknownRanges){if(env.reRendered)return console.error("Something is wrong with ranges. We could not determine them properly"),void console.warn(env);svg.node().style.opacity=0,console.warn("d3.js autoscale! Requires double evaluation!!!");const e=ImageSize[0]-(margin.left+margin.right),t=ImageSize[1]-(margin.top+margin.bottom);let r=env.svg.node().getBBox();if(console.log([e,t]),console.log(r),0==r.width||0==r.height){for(let e=0;e<12&&(console.warn("Element is too small... Waiting for CSS reflow"),console.log([r.width,r.height]),await delay(300),r=env.svg.node().getBBox(),0==r.width&&0==r.height);++e);if(0==r.width&&0==r.height)throw svg.node().style.opacity=1,console.log(svg.node()),"Plot range has zero size. Content is hidden probably"}const a=[[x.invert(r.x),x.invert(r.x+r.width)],[y.invert(r.height+r.y),y.invert(r.height+r.y-r.height)]];let n=(a[1][1]-a[1][0])/(a[0][1]-a[0][0]);(!isFinite(n)||n<0||n>3||n<1/3)&&(n=void 0),console.warn("Kill all created instances");const o=Object.keys(env.global.stack).filter(e=>!instancesKeys.some(t=>t===e));for(const e of o)env.global.stack[e].dispose();return svg.remove(),container.replaceChildren(),await g2d.Graphics(args,{...env,plotRange:a,reRendered:!0,aspectRatio:n})}return env},g2d["Graphics`Serialize"]=async(e,t)=>{const r=await core._getRules(e,t);let a=t.element;r.TemporalDOM&&(a=document.createElement("div"),a.style.pointerEvents="none",a.style.opacity=0,a.style.position="absolute",document.body.appendChild(a));const n=await interpretate(e[0],{...t,element:a}),o=await serialize(n.element.firstChild).text();return Object.values(t.global.stack).forEach(e=>{e.dispose()}),r.TemporalDOM&&a.remove(),o},g2d.Graphics.update=(e,t)=>{console.error("root update method for Graphics is not supported")},g2d.Graphics.destroy=(e,t)=>{t.local.listenerSVG.remove(),delete t.panZoomEntites},g2d.JoinForm=(e,t)=>{t.joinform=interpretate(e[0],t),console.warn("JoinForm is not implemented!")};const curve={BezierCurve:async(e,t)=>{let r=await interpretate(e[0],t);var a=t.path;const n=t.xAxis,o=t.yAxis;r=r.map(e=>[n(e[0]),o(e[1])]);let i=r.length-1;if(t.startQ){a.moveTo(...r[0]);for(let e=1;e<r.length-2;e+=3)i-=3,a.bezierCurveTo(...r[e],...r[e+1],...r[e+2]);t.startQ=!1}else for(let e=0;e<r.length-2;e+=3)i-=3,a.bezierCurveTo(...r[e],...r[e+1],...r[e+2]);i>0&&a.quadraticCurveTo(...r[r.length-2],...r[r.length-1])}};g2d.Legended=async(e,t)=>{throw"Legended is not supported in the context of Graphics"},g2d.FaceForm=async(e,t)=>{const r={...t,hold:!0},a=await interpretate(e[0],r);if(Array.isArray(a)){r.hold=!1;for(const e of a)await interpretate(e,r)}t.thickness=r.thickness,t.width=r.width,t.opacity=r.opacity,t.color=r.color},curve.Line=async(e,t)=>{let r=await interpretate(e[0],t);var a=t.path;const n=t.xAxis,o=t.yAxis;if(r=r.map(e=>[n(e[0]),o(e[1])]),t.startQ){a.moveTo(...r[0]);for(let e=1;e<r.length;++e)a.lineTo(...r[e]);t.startQ=!1}else for(let e=0;e<r.length;++e)a.lineTo(...r[e])},g2d.RegularPolygon=async(e,t)=>{let r=3,a=1,[n,o]=[0,0],i=Math.PI/2;1==e.length&&(r=await interpretate(e[0],t)),2==e.length&&(r=await interpretate(e[1],t),a=await interpretate(e[0],t)),3==e.length&&([n,o]=await interpretate(e[0],t),r=await interpretate(e[2],t),a=await interpretate(e[1],t)),Array.isArray(a)&&(i+=a[1],a=a[0]);const s=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),l=2*Math.PI/r,c=d3.range(r).map(e=>{const t=i+e*l;return[n+a*Math.cos(t),o+a*Math.sin(t)]}),u=t.svg.append("path").datum(c).attr("d",s).attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color);return t.dasharray&&u.attr("stroke-dasharray",t.dasharray.join()),t.local.polygon=u,u},g2d.JoinedCurve=async(e,t)=>{const r=d3.path();return await interpretate(e[0],{...t,path:r,context:[curve,g2d],startQ:!0}),t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",r)},g2d.CapForm=()=>{},g2d.FilledCurve=async(e,t)=>{const r=d3.path();return await interpretate(e[0],{...t,path:r,context:[curve,g2d],startQ:!0}),t.svg.append("path").attr("fill",t.color).attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("fill-rule","evenodd").attr("stroke","none").attr("stroke-width",t.strokeWidth).attr("d",r)};const delay=e=>new Promise(t=>{setTimeout(t,e)});g2d.Inset=async(e,t)=>{let r,a=[0,0];const n=await core._getRules(e,t),o=Object.keys(n).length;let i;e.length-o>1&&(a=await interpretate(e[1],t)),a instanceof NumericArrayObject&&(a=a.normal()),e.length-o>2&&(i=await interpretate(e[2],t));const s=t.svg.append("g"),l=s.append("foreignObject"),c={};t.local.stack=c;const u={global:{...t.global,stack:c},inset:!0,element:l.node(),context:g2d};e.length-o>3&&await interpretate(e[3],t),n.ImageSizeRaw&&(r=n.ImageSizeRaw),r&&(l.attr("width",r[0]),l.attr("height",r[1]));let d=!1;"HoldForm"==e[0][0]&&(Array.isArray(e[0][1])&&"Offload"==e[0][1][0]||(d=!0)),"Legended"==e[0][0]&&(d=!0);try{d||await interpretate(e[0],u)}catch(e){console.warn(e),d=!0}d&&await makeEditorView(e[0],u);const p=l.node();await delay(100);if((p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height)<10)for(let e=0;e<20&&(await delay(300),!((p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height)>30));++e);let f={width:p.offsetWidth||p.firstChild?.offsetWidth||p.firstChild?.width,height:p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height};if(f.width instanceof SVGAnimatedLength&&(f.width=f.width.animVal.valueInSpecifiedUnits),f.height instanceof SVGAnimatedLength&&(f.height=f.height.animVal.valueInSpecifiedUnits),console.warn(f),(f.width<1||!f.width)&&f.height>1){console.warn("cm-scroller hack"),await delay(100);const e=p.getElementsByClassName("cm-scroller");if(e.length>0){f.width=e[0].firstChild.offsetWidth;const t=e[0].firstChild.offsetHeight;t&&(f.height=Math.max(t,f.height))}else f.width=1.66*f.height}if(r||(l.attr("width",f.width),l.attr("height",f.height)),"ViewMatrix"in n&&!n.ViewMatrix)return l.attr("x",0),l.attr("y",0),s;if(t.local.box=f,i&&"string"!=typeof i)l.attr("x",t.xAxis(a[0])-i[0]).attr("y",t.yAxis(a[1])+i[1]-f.height);else{switch(i){case"Top":i=[f.width/2,f.height];break;case"Bottom":i=[f.width/2,0];break;case"Left":i=[0,f.height/2];break;case"Right":i=[f.width,f.height/2];break;default:i=[f.width/2,f.height/2]}l.attr("x",t.xAxis(a[0])-i[0]).attr("y",t.yAxis(a[1])+i[1]-f.height)}return t.local.foreignObject=l,t.local.opos=i,s.attr("opacity",t.opacity),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.group=s,s},g2d.Inset.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());const a=t.local.opos,n=t.local.foreignObject;return n&&n.attr("x",t.xAxis(r[0])-a[0]).attr("y",t.yAxis(r[1])+a[1]-t.local.box.height),n},g2d.Inset.updateOpacity=(e,t)=>{t.local.group.attr("opacity",t.opacity)},g2d.Inset.destroy=async(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],Object.values(t.local.stack).forEach(e=>{e.dead||e.dispose()}),t.local.group.remove()},g2d.Inset.virtual=!0;const serialize=e=>{const t="http://www.w3.org/2000/xmlns/";e=e.cloneNode(!0);const r=window.location.href+"#",a=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT);for(;a.nextNode();)for(const e of a.currentNode.attributes)e.value.includes(r)&&(e.value=e.value.replace(r,"#"));e.setAttributeNS(t,"xmlns","http://www.w3.org/2000/svg"),e.setAttributeNS(t,"xmlns:xlink","http://www.w3.org/1999/xlink");const n=(new window.XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})},addPanZoom=(e,t,r,a,n,o,i,s,l,c,u,d,p,f,m,y,g,x)=>{console.log({listener:e,raw:t,view:r,gX:a,gY:n,gTX:o,gRY:i,xAxis:c,yAxis:u,txAxis:d,ryAxis:p,xGrid:f,yGrid:m,x:y,y:g,env:x});const A=d3.zoom().filter(function(e){return e.preventDefault(),!(e.ctrlKey&&"wheel"!==e.type||e.button)}).on("zoom",function({transform:e}){r.attr("transform",e);const t=e.rescaleX(y),A=e.rescaleY(g);a&&a.call(c.scale(t));n&&n.call(u.scale(A));o&&o.call(d.scale(t));i&&i.call(p.scale(A));s&&s.call(f(t));l&&l.call(m(A));x.onZoom.forEach(t=>t(e))});e.call(A),x._zoom=A;const T=()=>{const t=d3.zoomIdentity;e.call(A.transform,t),r.attr("transform",t),a&&a.call(c.scale(y)),n&&n.call(u.scale(g)),o&&o.call(d.scale(y)),i&&i.call(p.scale(g)),s&&s.call(f(y)),l&&l.call(m(g)),x.onZoom.forEach(e=>e(t))};x._resetZoom=T,e.node().addEventListener("contextmenu",async e=>{if(e.preventDefault(),e.stopPropagation(),window.electronAPI){"reset"===await window.electronAPI.createMenu([{label:"Reset axes",ref:"reset"}])&&T()}else T()})};let arrow1;g2d.Texture=async(e,t)=>{const r=await interpretate(e[0],{...t,offscreen:!0});console.log("got it!");const a=await createImageBitmap(r);r.remove();return t.local.img=a,t.exposed.texture={image:a,get:e=>(t.local.texture||(e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),t.local.texture=twgl.createTexture(e,{src:a,flipY:!1,minMag:e.LINEAR})),t.local.texture)},a},g2d.Texture.destroy=(e,t)=>{t.local.img.close()},g2d.Texture.virtual=!0,g2d.SVGAttribute=async(e,t)=>{const r=await core._getRules(e,t);let a=await interpretate(e[0],t);return Object.keys(r).forEach(e=>{a=a.attr(e,r[e])}),t.local.object=a,a},g2d.SVGAttribute.update=async(e,t)=>{const r=await core._getRules(e,t);let a=t.local.object.maybeTransition(t.transitionType,t.transitionDuration);return Object.keys(r).forEach(e=>{a=a.attr(e,r[e])}),a},g2d.SVGAttribute.destroy=async(e,t)=>{console.log("SVGAttribute: nothing to destroy")},g2d.SVGAttribute.virtual=!0,g2d.LABColor=async(e,t)=>{let r;r=e.length>1?[await interpretate(e[0],t),await interpretate(e[1],t),await interpretate(e[2],t)]:await interpretate(e[0],t);const a=default_1({luminance:100*r[0],a:100*r[1],b:100*r[2]});return t.color="rgb("+Math.floor(a.red)+","+Math.floor(a.green)+","+Math.floor(a.blue)+")",e.length>3&&(t.opacity=await interpretate(e[3],t)),t.color},g2d.LABColor.update=()=>{},g2d.arrowGenerator=void 0,g2dComplex.BezierCurve=async(e,t)=>(await interpretate(e[0],t)).filter(e=>!Array.isArray(e)),g2dComplex.Arrow=async(e,t)=>{await interpretate.shared.d3.load(),arrow1||(arrow1=(await interpretate.shared.d3["d3-arrow"]).arrow1);let r=await interpretate(e[0],t);if(!Array.isArray(r)){let e;const a=uuidv4(),n=arrow1().id(a).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);return t.svg.call(n),e=r.attr("marker-end","url(#"+a+")"),e}if(r[0][0]){console.log("Multiple isntances"),console.log(r);const e=t.svg.append("g");e.attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth);const a=uuidv4(),n=arrow1().id(a).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);return t.svg.call(n),r.forEach(r=>{e.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("vector-effect","non-scaling-stroke").attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]})).attr("marker-end","url(#"+a+")")}),e}{const e=uuidv4(),a=arrow1().id(e).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);t.svg.call(a);return t.svg.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]})).attr("marker-end","url(#"+e+")")}},g2d.Arrow=async(e,t)=>{await interpretate.shared.d3.load(),arrow1||(arrow1=(await interpretate.shared.d3["d3-arrow"]).arrow1);const r=t.xAxis,a=t.yAxis,n=uuidv4(),o=arrow1(1.5*-(t.strokeWidth-1.5)).id(n).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);t.local.marker=n,t.svg.call(o);let i=await interpretate(e[0],t);if(i instanceof NumericArrayObject&&(i=i.normal()),!Array.isArray(i)){let o,s=0;if(e.length>1){s=await interpretate(e[1],t),s=Math.max(Math.abs(r(s)-r(0)),Math.abs(a(s)-a(0)));const o=d3.select(document.getElementById(n));o.attr("refX",parseFloat(o.attr("refX"))+s)}return o=i.attr("marker-end","url(#"+n+")"),o}if(t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),i[0][0][0]||"number"==typeof i[0][0][0]){const e=[];return i.forEach(r=>{e.push(t.svg.append("path").datum(r).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",t.local.line).attr("marker-end","url(#"+n+")"))}),t.local.arrows=e,e}{const e=t.svg.append("path").datum(i).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",t.local.line).attr("marker-end","url(#"+n+")");return t.local.arrow=e,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),e}},g2d.Arrow.update=async(e,t)=>{t.xAxis,t.yAxis;let r=await interpretate(e[0],t);if(r instanceof NumericArrayObject&&(r=r.normal()),r[0][0][0])throw"Arrows update method does not support multiple traces";return t.local.arrow.datum(r).maybeTransitionTween(t.TransitionType,t.TransitionDuration,"d",function(e){var r=d3.select(this).attr("d"),a=t.local.line(e);return interpolatePath(r,a)})};const dynSpace={DynamicName:async(e,t)=>{const r=await interpretate(e[0],{...t,context:[g2d,dynSpace]}),a=await interpretate(e[1],t);return t.contextSpace.put(a,r),r},DynamicLocation:async(e,t)=>{const r=await interpretate(e[0],t),a=(await t.contextSpace.get(r)).node().getBBox(),n=[a.x+a.width/2,a.y+a.height/2];return n[0]=t.xAxis.invert(n[0]),n[1]=t.yAxis.invert(n[1]),n}};g2d.DynamicNamespace=async(e,t)=>{const r={names:{},que:{},get:async e=>{if(e in r.names)return r.names[e];const t=new Deferred;return e in r.que||(r.que[e]=[]),r.que[e].push(t),t.promise},put:(e,t)=>{r.names[e]=t,e in r.que&&r.que[e].forEach(e=>e.resolve(t))}},a={...t,contextSpace:r,context:[dynSpace,g2d],hold:!0},n=await interpretate(e[0],a),o=[],i=[];if(Array.isArray(n))for(const e of n.reverse()){const t=a.svg.append("g");i.push(t),o.push(interpretate(e,{...a,hold:!1,svg:t}))}else o.push(n);await Promise.all(o);for(const e of i)a.svg.node().prepend(e.node())},g2d.Arrow.updateColor=(e,t)=>{"string"==typeof t.local.marker&&(t.local.marker=d3.select(document.getElementById(t.local.marker).firstChild)),t.local.marker.attr("fill",t.color),Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.attr("stroke",t.color)):t.local.arrow.attr("stroke",t.color)},g2d.Arrow.updateOpacity=(e,t)=>{"string"==typeof t.local.marker&&(t.local.marker=d3.select(document.getElementById(t.local.marker).firstChild)),t.local.marker.attr("opacity",t.opacity),Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.attr("opacity",t.opacity)):t.local.arrow.attr("opacity",t.opacity)},g2d.Arrow.virtual=!0,g2d.Arrow.destroy=async(e,t)=>{if(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.remove):t.local?.arrow?.remove(),"string"==typeof t.local.marker){const e=document.getElementById(t.local.marker);t.local.marker=d3.select(e?.firstChild),t.local.marker?.remove(),e?.remove()}else t.local?.marker?.remove()},g2d.ImageScaled=async(e,t)=>{const r=await interpretate(e[0],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+t.plotRange[0][0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+t.plotRange[1][0]]},g2d.Arrowheads=async(e,t)=>{const r=await interpretate(e[0],t);Array.isArray(r)?t.arrowHead=10*r.flat()[0]:t.arrowHead=10*r};const textContext={Pane:(e,t)=>interpretate(e[0],t),Framed:(e,t)=>interpretate(e[0],t)};g2d.DirectedInfinity=()=>1/0,g2d.Infinity=()=>1/0,textContext.NumberForm=async(e,t)=>{const r=(e,t,r)=>{const a=((e,t)=>{try{const r=Number(e).toFixed(t);return 0===Number(r)&&1/Number(e)==-1/0?"-"+r:r}catch{return String(e)}})(e,r);if(t===1/0)return a;if(a.replace(/[^0-9]/g,"").length<=t)return a;const n=Math.max(0,t-1);let o;try{o=Number(e).toExponential(n)}catch{return a}return 0!==Number(o)||1/Number(e)!=-1/0||/^-/.test(o)||(o="-"+o),o},a=(e,t)=>{if(Array.isArray(e))return e.map(e=>a(e,t));if((r=e)&&"object"==typeof r&&!Array.isArray(r)){const r={};for(const n of Object.keys(e))r[n]=a(e[n],t);return r}var r;return t(e)},n=await interpretate(e[0],t);let o,i,s="default";if(e.length>=2){const r=await interpretate(e[1],t);if(Array.isArray(r)&&r.length>=2){const e=r[0],t=r[1],a=e===1/0||"Infinity"===e?1/0:Number(e),n=Number(t);(Number.isFinite(a)||a===1/0)&&Number.isFinite(n)&&(o=a,i=Math.max(0,Math.floor(n)),s="nf")}else(r===1/0||"Infinity"===r||Number.isFinite(Number(r)))&&(o=r===1/0||"Infinity"===r?1/0:Number(r),s="n")}return a(n,e=>{if("number"!=typeof(t=e)||!isFinite(t))return e;var t;switch(s){case"n":return o===1/0?e.toString():((e,t)=>{try{const r=Number(e).toPrecision(t);return Object.is(e,-0)?r.replace(/^0/,"-0"):r}catch{return String(e)}})(e,Math.max(1,Math.floor(o)));case"nf":{const t=o===1/0?1/0:Math.max(1,Math.floor(o));return r(e,t,i)}default:return e}})},g2d.Row=()=>{throw"Row inside Graphics context is not applicable"},textContext.Rotate=async(e,t)=>(t.rotation=await interpretate(e[1],t),await interpretate(e[0],t));const textContextSym={};function detectNumbers(e){return!!Array.isArray(e)&&("Rational"==e[0]||("Complex"==e[0]||("Times"==e[0]||("Sqrt"==e[0]||("Exp"==e[0]||("Log"==e[0]||("Power"==e[0]||("Plus"==e[0]||void 0))))))))}function replaceCanvasWithImage(e){const t=e.canvas,r=t.toDataURL("image/png"),a=new Image;a.src=r,a.width=t.width,a.height=t.height,a.style.padding=0;return t.parentNode.replaceChild(a,t),a}function cleanupWebGL(e){const t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()}textContextSym.E=async(e,t)=>"𝘦",textContextSym.E.update=textContextSym.E,textContextSym.Pi=async(e,t)=>"π",textContextSym.Pi.update=textContextSym.Pi,textContextSym.Infinity=async(e,t)=>"∞",textContextSym.Infinity.update=textContextSym.Infinity,textContextSym.Indeterminate=async(e,t)=>"?",textContextSym.Indeterminate.update=textContextSym.Indeterminate,textContextSym.DirectedInfinity=async(e,t)=>"∞",textContextSym.DirectedInfinity.update=textContextSym.DirectedInfinity,textContextSym.Plus=async(e,t)=>{const r=await Promise.all(e.map(e=>interpretate(e,t))),a=document.createElement("span");return a.style.textWrap="nowrap",r.forEach((e,t)=>{var r;t>0&&a.appendChild(document.createTextNode(" + ")),a.appendChild((r=e)instanceof Node?r:document.createTextNode(null==r?"":"object"==typeof r?(()=>{try{return JSON.stringify(r)}catch{return String(r)}})():String(r)))}),a},textContextSym.Plus.update=textContextSym.Plus,textContextSym.Times=async(e,t)=>{const r=await Promise.all(e.map(e=>interpretate(e,t))),a=document.createElement("span");return a.style.textWrap="nowrap",r.forEach((e,t)=>{var r;t>0&&a.appendChild(document.createTextNode(" × ")),a.appendChild((r=e)instanceof Node?r:document.createTextNode(null==r?"":"object"==typeof r?(()=>{try{return JSON.stringify(r)}catch{return String(r)}})():String(r)))}),a},textContextSym.Times.update=textContextSym.Times,textContextSym.Exp=async(e,t)=>{const[r]=await Promise.all(e.slice(0,1).map(e=>interpretate(e,t))),a=document.createElement("span");a.style.textWrap="nowrap";const n=document.createTextNode("e"),o=document.createElement("sup");var i;return o.appendChild((i=r)instanceof Node?i:document.createTextNode(null==i?"":"object"==typeof i?(()=>{try{return JSON.stringify(i)}catch{return String(i)}})():String(i))),a.appendChild(n),a.appendChild(o),a},textContextSym.Exp.update=textContextSym.Exp,textContextSym.Log=async(e,t)=>{const r=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),a=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),n=document.createElement("span");if(n.style.textWrap="nowrap",1===r.length)n.appendChild(document.createTextNode("ln(")),n.appendChild(a(r[0])),n.appendChild(document.createTextNode(")"));else{const[e,t]=r;n.appendChild(document.createTextNode("log"));const o=document.createElement("sub");o.appendChild(a(e)),n.appendChild(o),n.appendChild(document.createTextNode("(")),n.appendChild(a(t)),n.appendChild(document.createTextNode(")"))}return n},textContextSym.Log.update=textContextSym.Log,textContextSym.Sqrt=async(e,t)=>{const[r]=await Promise.all(e.slice(0,1).map(e=>interpretate(e,t))),a=document.createElement("span");a.style.textWrap="nowrap",a.classList.add("sqroot");const n=document.createElement("span");var o;return n.classList.add("radicant"),a.appendChild(n.appendChild((o=r)instanceof Node?o:document.createTextNode(null==o?"":"object"==typeof o?(()=>{try{return JSON.stringify(o)}catch{return String(o)}})():String(o)))),a},textContextSym.Sqrt.update=textContextSym.Sqrt,textContextSym.Power=async(e,t)=>{const r=await interpretate(e[1],{...t,compact:!0}),a=await interpretate(e[0],t),n=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),o=document.createElement("span");o.style.textWrap="nowrap",o.appendChild(n(a));const i=document.createElement("sup");return i.style.lineHeight="unset",i.style.top="-0.25rem",i.style.marginLeft="0.05rem",i.style.fontSize="50%",i.appendChild(n(r)),o.appendChild(i),o},textContextSym.Power.update=textContextSym.Power,textContextSym.Complex=async(e,t)=>{const[r,a]=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),n=document.createElement("span");return n.style.textWrap="nowrap",0!=r&&(r instanceof HTMLElement?n.appendChild(r):n.appendChild(document.createTextNode(r)),0!=a&&n.appendChild(document.createTextNode(" + "))),0!=a&&(1==a?n.appendChild(document.createTextNode("i")):(n.appendChild(document.createTextNode("i ")),a instanceof HTMLElement?n.appendChild(a):n.appendChild(document.createTextNode(a)))),n},textContextSym.Complex.update=textContextSym.Complex,textContextSym.Rational=async(e,t)=>{const[r,a]=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),n=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),o=document.createElement("span");if(t.compact)o.appendChild(n(r)),o.appendChild(document.createTextNode("/")),o.appendChild(n(a));else{o.className="fraction",o.innerHTML='\n        <table class="container" style="text-wrap: nowrap;">\n          <tbody>\n            <tr><td class="enumenator"></td></tr>\n            <tr><td></td></tr>\n          </tbody>\n        </table>';const[e,t]=o.querySelectorAll("td");e.appendChild(n(r)),t.appendChild(n(a))}return o},textContextSym.Rational.update=textContextSym.Rational,g2d.BaseStyle=()=>"BaseStyle",g2d.Text=async(e,t)=>{const r={...t};r.context=[textContext,g2d];let a=e[0];try{detectNumbers(a)?(r.context.unshift(textContextSym),a=await interpretate(e[0],r)):(a=await interpretate(e[0],r),t.local.text=a)}catch(r){return console.warn("Error in interpreting input argument of Text. Is it an undefined variable?"),t.local.object={remove:()=>{}},t.local.text="",await g2d.Inset([e[0],e[1]],{...t})}let n=await interpretate(e[1],t);const o=await core._getRules(e,{...t,hold:!0});n instanceof NumericArrayObject&&(n=n.normal());let i,s={x:0,y:0};if("'Graphics'"==o.BaseStyle&&(r.color="black"),a instanceof HTMLElement){t.local.htmlQ=!0;const e=d3.select(a).style("font-family",r.fontfamily).style("font-size",r.fontsize+"px").style("opacity",r.opacity).style("color",r.color);r.fontweight&&e.style("font-weight",r.fontweight),i=t.svg.append("foreignObject").attr("style","overflow: visible"),i.node().appendChild(a);const n=i.node(),o=n.offsetHeight||n.firstChild?.offsetHeight||n.firstChild?.height,l=n.offsetWidth||n.firstChild?.offsetWidth||n.firstChild?.width;i.attr("width",l).attr("height",o),s.x=-Math.round(l/2),s.y=-Math.round(o/2)}else i=t.svg.append("text").attr("font-family",r.fontfamily).attr("font-size",r.fontsize).attr("opacity",r.opacity).attr("fill",r.color),r.fontweight&&i.attr("font-weight",r.fontweight);if(e.length>2){let a=[0,0];"Rule"!=e[2][0]&&(a=(await interpretate(e[2],{...t,plotRange:[[-1,1],[-1,1]]})).map(e=>Math.round(e)));const o=t.xAxis(n[0])+s.x,l=t.yAxis(n[1])+s.y;if(i.attr("x",o).attr("y",l),r.rotation){const e=Math.round(180*r.rotation/Math.PI);i.attr("transform",`rotate(${e}, ${o}, ${l})`)}0===a[0]?i.attr("text-anchor","middle"):a[0]>0?i.attr("text-anchor","end"):a[0]<0&&i.attr("text-anchor","start"),0===a[1]?i.attr("alignment-baseline","middle"):a[1]>0?i.attr("alignment-baseline","hanging"):a[1]<0&&i.attr("alignment-baseline","text-after")}else{const e=t.xAxis(n[0])+s.x,a=t.yAxis(n[1])+s.y;if(i.attr("x",e).attr("y",a),r.rotation){const t=Math.round(180*r.rotation/Math.PI);i.attr("transform",`rotate(${t}, ${e}, ${a})`)}}return g2d.Text.PutText(i,a,t),t.local.object=i,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Text.PutText=(e,t,r)=>{if(!t)return;let a=t;if("number"==typeof t&&(a=t.toString()),"string"!=typeof a)return;const n=[g2d.Text.TokensSplit(a.replaceAll(/\\([a-zA-z]+)/g,g2d.Text.GreekReplacer),g2d.Text.TextOperators)].flat(1/0);let o;e.html(n.shift());let i=0;for(;null!=(o=n.shift());)"string"==typeof o?(e.append("tspan").html(o).attr("font-size",r.fontsize).attr("dy",-i),i=0):(i=-r.fontsize*o.ky,e.append("tspan").html(o.data).attr("font-size",Math.round(r.fontsize*o.kf)).attr("dy",i))},g2d.Text.TextOperators=[{type:"sup",handler:e=>e,regexp:/\^{([^{|}]*)}/,meta:{ky:.4,kf:.7}},{type:"sub",handler:e=>e,regexp:/\_{([^{|}]*)}/,meta:{ky:-.25,kf:.7}}],g2d.Text.GreekReplacer=(e,t,r)=>"&"+t.toLowerCase().replace("sqrt","radic").replace("degree","deg")+";",g2d.Text.TokensSplit=(e,t,r=0)=>{if(r===t.length||r<0)return e;const a=e.match(t[r].regexp);if(null===a)return g2d.Text.TokensSplit(e,t,r+1);const n={type:t[r].type,data:t[r].handler(a[1]),...t[r].meta};return[g2d.Text.TokensSplit(e.slice(0,a.index),t,r+1),n,g2d.Text.TokensSplit(e.slice(a.index+a[0].length),t,0)]},g2d.Text.virtual=!0,g2d.Text.updateColor=(e,t)=>{t.local.object.attr("fill",t.color)},g2d.Text.updateOpacity=(e,t)=>{t.local.object.attr("opacity",t.opacity)},g2d.Text.update=async(e,t)=>{let r,a=await interpretate(e[1],t);if(a instanceof NumericArrayObject&&(a=a.normal()),!t.local.htmlQ){let n;return r=await interpretate(e[0],t),n=t.local.text!=r?t.local.object.maybeTransition(t.transitionType,t.transitionDuration).text(r).attr("x",t.xAxis(a[0])).attr("y",t.yAxis(a[1])):t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("x",t.xAxis(a[0])).attr("y",t.yAxis(a[1])),n}console.error("Update method for symbol-like elements is not supported in Text[]")},g2d.Text.destroy=(e,t)=>{t.local.object.remove(),delete t.local.object,t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid]},g2d.Text.subcontext={},g2d.FontSize=()=>"FontSize",g2d.FontSize.update=g2d.FontSize,g2d.FontFamily=()=>"FontFamily",g2d.FontFamily.update=g2d.FontFamily,g2d.Bold=()=>"Bold",g2d.Bold.update=()=>"Bold",g2d.Style=async(e,t)=>{const r=t,a=await core._getRules(e,t);a.FontSize&&(r.fontsize=a.FontSize),a.FontColor&&(r.color=a.FontColor),a.FontFamily&&(r.fontfamily=a.FontFamily);for(let t=1;t<e.length-Object.keys(a).length;++t){"Bold"==await interpretate(e[t],r)&&(r.fontweight="bold")}return await interpretate(e[0],r)},g2d.Style.update=async(e,t)=>{const r=await core._getRules(e,t);return r.FontSize&&(t.fontsize=r.FontSize),r.FontFamily&&(t.fontfamily=r.FontFamily),await interpretate(e[0],t)},g2d.AnimationFrameListener=async(e,t)=>{await interpretate(e[0],t);const r=await core._getRules(e,{...t,hold:!0});t.local.event=await interpretate(r.Event,t),t.local.fire=()=>{server.kernel.io.poke(t.local.event),performance.now()},window.requestAnimationFrame(t.local.fire)},g2d.AnimationFrameListener.update=async(e,t)=>{window.requestAnimationFrame(t.local.fire)},g2d.AnimationFrameListener.destroy=async(e,t)=>{console.warn("AnimationFrameListener does not exist anymore"),t.timer&&clearInterval(t.timer)},g2d.AnimationFrameListener.virtual=!0;const vs="\n    attribute vec2 position;\n    uniform vec2 u_resolution;\n    uniform bool u_vertexColor;\n    uniform bool u_vertexTexture;\n    uniform float u_pointSize;\n    attribute vec4 color;\n    varying vec4 v_color;\n\n    attribute vec2 texcoord;\n    varying vec2 v_texcoord;\n    \n\n    void main() {\n        vec2 clipSpace = (position / u_resolution) * 2.0 - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        if (u_vertexColor) v_color = color;  // Pass color to fragment shader\n        if (u_vertexTexture) v_texcoord = texcoord; // Pass texture (if applicable)\n        gl_PointSize = u_pointSize;\n    }\n  ",fs="\n    precision mediump float;\n    uniform vec4 u_color;\n    uniform bool u_vertexColor;\n    uniform bool u_vertexTexture;\n    varying vec4 v_color;\n\n    uniform sampler2D u_texture;\n    varying vec2 v_texcoord;\n\n    void main() {\n        if (u_vertexColor) {\n          gl_FragColor = v_color;\n          return;\n        }\n\n        if (u_vertexTexture) {\n          gl_FragColor = texture2D(u_texture, v_texcoord);\n          return;\n        }    \n        \n        gl_FragColor = u_color;\n    }\n  ";var twgl;g2d.GraphicsComplex=async(e,t)=>{twgl||(twgl=await Promise.resolve().then(function(){return twgl_module}));const r=(await interpretate(e[0],t)).map(e=>[t.xAxis(e[0]),t.yAxis(e[1])]);let a=1/0,n=1/0,o=-1/0,i=-1/0;for(const[e,t]of r)e<a&&(a=e),t<n&&(n=t),e>o&&(o=e),t>i&&(i=t);t.local.rect=t.svg.append("rect").attr("x",a).attr("y",n).attr("width",o-a).attr("height",i-n).attr("opacity",0);const s=await core._getRules(e,t),l={...t,context:[g2dComplex,g2d]},c=t.svg.append("foreignObject").attr("width",t.clipWidth).attr("height",t.clipHeight).append("xhtml:canvas");c.attr("width",Math.round(1*t.clipWidth)).attr("height",Math.round(1*t.clipHeight));const u=c.node().getContext("webgl",{premultipliedAlpha:!1}),d=twgl.createProgramInfo(u,[vs,fs]);u.getExtension("OES_element_index_uint")||console.error("TWGL: need OES_element_index_uint"),twgl.addExtensionsToContext(u),l.wgl={gl:u,programInfo:d},l.wgl.fallbackVertices=r;const p=t.opacity,f={position:{numComponents:2,data:r.flat(1/0).map(e=>1*e)}};if(s.VertexColors){let e=[];switch(l.wgl.vertexColors=!0,l.wgl.fallbackColors=s.VertexColors,s.VertexColors[0].length){case 3:for(let t=0;t<s.VertexColors.length;++t){const r=s.VertexColors[t];e.push(...r,p)}break;case 4:e=s.VertexColors.flat(1/0);break;default:if("string"==typeof s.VertexColors[0]){console.warn("FIXME: This is the worst case");for(let t=0;t<s.VertexColors.length;++t){const r=d3.color(s.VertexColors[t]);e.push(r.r/255,r.g/255,r.b/255,p)}}}f.color={numComponents:4,data:e}}if(s.VertexTextureCoordinates){const e=s.VertexTextureCoordinates.flat(1/0);f.texcoord={numComponents:2,data:e},l.wgl.vertexTexture=!0}const m=twgl.createBufferInfoFromArrays(u,f);u.viewport(0,0,u.canvas.width,u.canvas.height),u.clearColor(0,0,0,0),u.clear(u.COLOR_BUFFER_BIT),u.useProgram(d.program),u.enable(u.BLEND),twgl.setBuffersAndAttributes(u,d,m),await interpretate(e[1],l);const y=replaceCanvasWithImage(u);return cleanupWebGL(u),y.style.opacity=t.opacity,t.local.img=y,t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),y},g2d.GraphicsComplex.update=()=>{throw"Updates of GraphicsComplex are not supported!"},g2d.GraphicsComplex.updateOpacity=(e,t)=>{t.local.img.style.opacity=t.opacity},g2d.GraphicsComplex.destroy=(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.img.remove(),t.local.rect.remove()},g2d.GraphicsComplex.virtual=!0,g2d.Medium=()=>.08,g2d.Large=()=>1.1/10,g2d.Small=()=>.05,g2d.Tiny=()=>.02,g2d.GraphicsGroup=async(e,t)=>await interpretate(e[0],t),g2d.Invisible=async(e,t)=>{const r=t.svg.append("g");return r.attr("style","visibility:hidden"),await interpretate(e[0],{...t,svg:r})},g2d.Thickness=async(e,t)=>{const r=await interpretate(e[0],t);"number"==typeof r&&(t.strokeWidth=30*r)},g2d.AbsoluteThickness=(e,t)=>{t.strokeWidth=interpretate(e[0],t)},g2d.PointSize=async(e,t)=>{t.pointSize=await interpretate(e[0],t)},g2d.Annotation=async(e,t)=>await interpretate(e[0],{...t}),g2d.ZoomAt=async(e,t)=>{let r=await interpretate(e[0],t);const a={width:t.xAxis((t.plotRange[0][0]+t.plotRange[0][1])/2),height:t.yAxis((t.plotRange[1][0]+t.plotRange[1][1])/2)};let n=[(t.plotRange[0][0]+t.plotRange[0][1])/2,-(t.plotRange[1][0]+t.plotRange[1][1])/2];e.length>1&&(n=await interpretate(e[1],t)),n=[t.xAxis(n[0]),t.yAxis(n[1])],console.log(n);const o=t.panZoomEntites;console.log(t.svg.attr("transform"));const i=d3.zoomIdentity.translate(a.width,a.height).scale(r).translate(-n[0],-n[1]);o.svg.maybeTransition(t.transitionType,t.transitionDuration).attr("transform",i),o.gX&&o.gX.maybeTransition(t.transitionType,t.transitionDuration).call(o.xAxis.scale(i.rescaleX(o.x))),o.gY&&o.gY.maybeTransition(t.transitionType,t.transitionDuration).call(o.yAxis.scale(i.rescaleY(o.y))),o.gGX&&o.gGX.maybeTransition(t.transitionType,t.transitionDuration).call(o.xGrid(i.rescaleY(o.x))),o.gGY&&o.gGY.maybeTransition(t.transitionType,t.transitionDuration).call(o.yGrid(i.rescaleY(o.y))),o.gTX&&o.gTX.maybeTransition(t.transitionType,t.transitionDuration).call(o.txAxis.scale(i.rescaleX(o.x))),o.gRY&&o.gRY.maybeTransition(t.transitionType,t.transitionDuration).call(o.ryAxis.scale(i.rescaleY(o.y)))};const rescaleRanges=(e,t,r,a)=>{throw"not implemented"};g2d.Directive=async(e,t)=>{const r=await core._getRules(e,t);for(const e of Object.keys(r))t[e.toLowerCase()]=r[e];if(assignTransition(t),"PlotRange"in r){const e=r.PlotRange;rescaleRanges(e,t.plotRange,t.panZoomEntites)}for(let a=0;a<e.length-Object.keys(r).length;++a)await interpretate(e[a],t)},g2d.EdgeForm=async(e,t)=>{const r={...t,hold:!0},a=await interpretate(e[0],r);if(Array.isArray(a)){r.hold=!1;for(const e of a)await interpretate(e,r)}t.strokeWidth=r.strokeWidth,t.strokeOpacity=r.opacity,"rgb(68, 68, 68)"!==r.color&&(t.stroke=r.color)},g2d.EdgeForm.update=async(e,t)=>{},g2d.Opacity=async(e,t)=>{if(t.opacity=await interpretate(e[0],t),t.exposed.opacity=t.opacity,t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.opacityRefs=e,t.local.refs=e}return t.opacity},g2d.Opacity.update=async(e,t)=>{const r=await interpretate(e[0],t),a=Object.values(t.local.refs);for(const e of a)e.execute({method:"updateOpacity",opacity:r})},g2d.Opacity.destroy=(e,t)=>{delete t.local.refs},g2d.Opacity.virtual=!0,g2d.GrayLevel=async(e,t)=>{let r=await interpretate(e[0],t);return r.length&&(r=r[0]),r=Math.floor(255*r),t.color=`rgb(${r},${r},${r})`,t.color},g2d.RGBColor=async(e,t)=>{let r;if(3==e.length||4==e.length)r="rgb(",r+=String(Math.floor(255*await interpretate(e[0],t)))+",",r+=String(Math.floor(255*await interpretate(e[1],t)))+",",r+=String(Math.floor(255*await interpretate(e[2],t)))+")";else{let a=await interpretate(e[0],t);a instanceof NumericArrayObject&&(a=a.normal()),r="rgb(",r+=String(Math.floor(255*a[0]))+",",r+=String(Math.floor(255*a[1]))+",",r+=String(Math.floor(255*a[2]))+")"}if(t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.colorRefs=e,t.local.refs=e}return t.exposed.color=r,r},g2d.RGBColor.update=async(e,t)=>{let r;if(3==e.length)r="rgb(",r+=String(Math.floor(255*await interpretate(e[0],t)))+",",r+=String(Math.floor(255*await interpretate(e[1],t)))+",",r+=String(Math.floor(255*await interpretate(e[2],t)))+")";else{let a=await interpretate(e[0],t);a instanceof NumericArrayObject&&(a=a.normal()),r="rgb(",r+=String(Math.floor(255*a[0]))+",",r+=String(Math.floor(255*a[1]))+",",r+=String(Math.floor(255*a[2]))+")"}const a=Object.values(t.local.refs);for(const e of a)e.execute({method:"updateColor",color:r})},g2d.RGBColor.destroy=(e,t)=>{delete t.local.refs},g2d.RGBColor.virtual=!0;let hsv2hsl=(e,t,r,a=r-r*t/2,n=Math.min(a,1-a))=>[e,n?(r-a)/n:0,a];var earcut$2;g2d.Hue=async(e,t)=>{let r=await Promise.all(e.map(e=>interpretate(e,t)));if(r.length<3&&(r=[r[0],1,1]),r=hsv2hsl(...r),r=[r[0],(100*r[1]).toFixed(2),(100*r[2]).toFixed(2)],t.color="hsl("+(314*r[0]).toFixed(2)+","+r[1]+"%,"+r[2]+"%)",t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.colorRefs=e,t.local.refs=e}return t.exposed.color=t.color,t.color},g2d.Hue.update=async(e,t)=>{let r=await Promise.all(e.map(e=>interpretate(e,t)));r.length<3&&(r=[r[0],1,1]),r=hsv2hsl(...r),r=[r[0],(100*r[1]).toFixed(2),(100*r[2]).toFixed(2)];const a="hsl("+(314*r[0]).toFixed(2)+","+r[1]+"%,"+r[2]+"%)",n=Object.values(t.local.refs);for(const e of n)e.execute({method:"updateColor",color:a})},g2d.Hue.destroy=(e,t)=>{delete t.local.refs},g2d.Hue.virtual=!0,g2d.CubicInOut=()=>"CubicInOut",g2d.Linear=()=>"Linear",g2dComplex.List=core.List,g2dComplex.Polygon=async(e,t)=>{let r=await interpretate(e[0],t),a=d3.color(t.color);a=[a.r/255,a.g/255,a.b/255,t.opacity],r[0][0]||(r=[r]);const{gl:n,programInfo:o}=t.wgl;let i;switch(r[0].length){case 3:i=twgl.createBufferInfoFromArrays(n,{indices:r.flat(1/0).map(e=>e-1)});break;case 4:{const e=[];for(let t=0;t<r.length;++t){const a=r[t];e.push(a[0]-1,a[1]-1,a[2]-1,a[0]-1,a[2]-1,a[3]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;case 5:{const e=[];for(let t=0;t<r.length;++t){const a=r[t];e.push(a[0]-1,a[1]-1,a[2]-1,a[0]-1,a[2]-1,a[3]-1,a[0]-1,a[3]-1,a[4]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;case 6:{const e=[];for(let t=0;t<r.length;++t){const a=r[t];e.push(a[0]-1,a[1]-1,a[2]-1,a[0]-1,a[2]-1,a[3]-1,a[0]-1,a[3]-1,a[4]-1,a[0]-1,a[4]-1,a[5]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;default:const e=t.wgl.fallbackVertices,a=[];earcut$2||(earcut$2=(await Promise.resolve().then(function(){return earcut$1})).default);for(let t of r){t=t.map(e=>e-1);const r=t.flatMap(t=>e[t]);a.push(earcut$2(r).map(e=>t[e]))}i=twgl.createBufferInfoFromArrays(n,{indices:a.flat()})}if(twgl.setBuffersAndAttributes(n,o,i),t.wgl.vertexTexture){if(!t.texture)throw"Texture is not provided!";const e=t.texture.get(n);return twgl.setUniforms(o,{u_resolution:[n.canvas.width,n.canvas.height],u_texture:e,u_vertexTexture:!0}),void(t.wgl.fallbackVertices.length>65535?n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_SHORT,0))}twgl.setUniforms(o,{u_resolution:[n.canvas.width,n.canvas.height],u_color:a,u_vertexColor:Boolean(t.wgl.vertexColors)}),t.wgl.fallbackVertices.length>65535?n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_SHORT,0)},g2d.Deploy=(e,t)=>interpretate(e[0],t),g2d.Polygon=async(e,t)=>{let r=await interpretate(e[0],t);if(r?.lhs){const e=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])});let a=r.rhs,n=r.lhs;Array.isArray(n[0][0])||1!=a.length||(n=[n],a=a[0]);const o=[e([...a,a[0]]),...n.map(t=>{const r=[...t].reverse();return e([...r,r[0]])})].join("");return t.local.area=t.svg.append("path").attr("d",o).attr("fill",t.color).attr("fill-rule","evenodd").attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color),t.local.area}if(r instanceof NumericArrayObject&&(r=data.normal()),t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),Array.isArray(r[0][0])){console.log("most likely there are many polygons");const e=t.svg.append("g").attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color);return t.texture&&t.local.area.attr("fill","url(#"+t.texture+")"),t.dasharray&&e.attr("stroke-dasharray",t.dasharray.join()),r.forEach(r=>{r.push(r[0]),e.append("path").datum(r).attr("d",t.local.line)}),t.local.polygons=e,e}return r.push(r[0]),t.local.area=t.svg.append("path").datum(r).attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color).attr("d",t.local.line),t.texture&&t.local.area.attr("fill","url(#"+t.texture+")"),t.dasharray&&t.local.area.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.area},g2d.Polygon.updateColor=(e,t)=>{if(t.local.polygons)for(const e of t.local.polygons)e.attr("fill",t.color);else t.local.area.attr("fill",t.color)},g2d.Polygon.updateOpacity=(e,t)=>{if(t.local.polygons)for(const e of t.local.polygons)e.attr("fill-opacity",t.opacity),e.attr("stroke-opacity",t.strokeOpacity||t.opacity);else t.local.area.attr("fill-opacity",t.opacity),t.local.area.attr("stroke-opacity",t.strokeOpacity||t.opacity)},g2d.Polygon.update=async(e,t)=>{let r=await interpretate(e[0],t);if(r instanceof NumericArrayObject&&(r=r.normal()),t.local.polygons)throw"update method for many polygons in not supported";t.xAxis,t.yAxis;return t.local.area.datum(r).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),a=t.local.line(e);return interpolatePath(r,a)})},g2d.Polygon.destroy=(e,t)=>{if(console.log("area destroyed"),t.local){if(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.area)return t.local.area.remove(),void delete t.local.area;t.local.polygons&&(t.local.polygons.remove(),delete t.local.polygons)}},g2d.Polygon.virtual=!0,g2d.IdentityFunction=async(e,t)=>await interpretate(e[0],t),g2d.StatusArea=g2d.IdentityFunction,g2d["Charting`DelayedMouseEffect"]=g2d.IdentityFunction,g2dComplex.Line=async(e,t)=>{const r=await interpretate(e[0],t);if(r[0][0]){const e=t.svg.append("g");return e.attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth),r.forEach(r=>{e.append("path").datum(r.map(e=>t.vertices[e-1])).attr("vector-effect","non-scaling-stroke").attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]}))}),e}{const e=t.svg.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]}));return t.dasharray&&e.attr("stroke-dasharray",t.dasharray.join()),e}},g2d.SplineKnots=()=>"SplineKnots",g2d.SplineDegree=()=>"SplineDegree",g2d.BSplineCurve=async(e,t)=>{const r=await core._getRules(e,t);let a=await interpretate(e[0],t);const n=t.xAxis,o=t.yAxis,i=a.map(e=>3===e.length?{x:e[0],y:e[1],w:e[2]}:{x:e[0],y:e[1],w:1});let s=r.SplineDegree;"number"!=typeof s&&(s=3);const l=i.length-1,c=s;let u=r.SplineKnots;function d(e,t,r,a){if(0===t)return a[e]<=r&&r<a[e+1]?1:0;const n=a[e+t]-a[e],o=a[e+t+1]-a[e+1];return(n?(r-a[e])/n*d(e,t-1,r,a):0)+(o?(a[e+t+1]-r)/o*d(e+1,t-1,r,a):0)}function p(e){let t={x:0,y:0},r=0;for(let a=0;a<=l;a++){const n=d(a,c,e,u)*i[a].w;t.x+=n*i[a].x,t.y+=n*i[a].y,r+=n}return[n(t.x/r),o(t.y/r)]}Array.isArray(u)||(u=(()=>{const e=l+c+1;let t=[];for(let r=0;r<=e;r++)r<=c?t.push(0):r>=e-c?t.push(1):t.push((r-c)/(e-2*c));return t})());const f=d3.path(),m=t.steps||100;for(let e=0;e<=m;e++){const t=p(u[c]+(u[l+1]-u[c])*e/m);0===e?f.moveTo(...t):f.lineTo(...t)}return t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",f)};const deCasteljau=(e,t)=>{let r=e.map(e=>[e[0],e[1]]);for(let a=1;a<e.length;a++)for(let n=0;n<e.length-a;n++)r[n][0]=(1-t)*r[n][0]+t*r[n+1][0],r[n][1]=(1-t)*r[n][1]+t*r[n+1][1];return r[0]},drawSampled=(e,t,r=48)=>{for(let a=1;a<=r;a++){const n=deCasteljau(t,a/r);e.lineTo(n[0],n[1])}};g2d.BezierCurve=async(e,t)=>{const r=await core._getRules(e,t);let a=await interpretate(e[0],t);const n=d3.path(),o=r&&Number.isInteger(r.SplineDegree)?r.SplineDegree:3,i=Math.max(1,o),s=t.xAxis,l=t.yAxis;if(a=a.map(e=>[s(e[0]),l(e[1])]),a.length<2)return null;n.moveTo(a[0][0],a[0][1]);let c=1;for(;c+i-1<a.length;){const e=a.length-c;if(3===i&&e>=3)n.bezierCurveTo(a[c][0],a[c][1],a[c+1][0],a[c+1][1],a[c+2][0],a[c+2][1]),c+=3;else if(2===i&&e>=2)n.quadraticCurveTo(a[c][0],a[c][1],a[c+1][0],a[c+1][1]),c+=2;else{const t=Math.min(i,e),r=[n._currentPoint||a[c-1]].concat(a.slice(c,c+t));drawSampled(n,r,Math.max(24,12*t));const o=r[r.length-1];n._currentPoint=[o[0],o[1]],c+=t}}const u=a.length-c;if(1===u)n.lineTo(a[c][0],a[c][1]);else if(2===u)n.quadraticCurveTo(a[c][0],a[c][1],a[c+1][0],a[c+1][1]);else if(u>2){const e=[n._currentPoint||a[c-1]].concat(a.slice(c));drawSampled(e,Math.max(24,12*u))}return t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",n)},g2d.Line=async(e,t)=>{t.offset;let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const a=t.xAxis,n=t.yAxis;let o;switch(arrdims(r)){case 0:o=t.svg.append("path").datum([]).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return a(e[0])}).y(function(e){return n(e[1])})),t.dasharray&&o.attr("stroke-dasharray",t.dasharray.join());break;case 2:if(t.returnPath)throw o=null,"Not implemented!";o=t.svg.append("path").datum(r).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return a(e[0])}).y(function(e){return n(e[1])})),t.dasharray&&o.attr("stroke-dasharray",t.dasharray.join());break;case 3:console.log(r),o=r.map(e=>{const r=t.svg.append("path").datum(e).join("path").attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return a(e[0])}).y(function(e){return n(e[1])}));return t.dasharray&&r.attr("stroke-dasharray",t.dasharray.join()),r})}return t.local.nsets=r.length,t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),t.local.object=o,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),Array.isArray(o)?o[0]:o},g2d.Line.updateColor=(e,t)=>{Array.isArray(t.local.object)?t.local.object.forEach(e=>e.style("stroke",t.color)):t.local.object.style("stroke",t.color)},g2d.Line.updateOpacity=(e,t)=>{Array.isArray(t.local.object)?t.local.object.forEach(e=>e.style("opacity",t.opacity)):t.local.object.style("opacity",t.opacity)},g2d.Line.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const a=t.xAxis,n=t.yAxis;let o,i=t.local.object;switch(arrdims(r)){case 0:o=i.datum([]).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),a=t.local.line(e);return interpolatePath(r,a)});break;case 2:o=i.datum(r).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),a=t.local.line(e);return interpolatePath(r,a)});break;case 3:for(let e=0;e<Math.min(r.length,t.local.nsets);++e)console.log("upd 1"),o=i[e].datum(r[e]).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),a=t.local.line(e);return interpolatePath(r,a)});if(r.length>t.local.nsets){console.log("upd 2");for(let e=t.local.nsets;e<r.length;++e)o=t.svg.append("path").datum(r[e]).attr("fill","none").attr("stroke",t.color).attr("stroke-width",t.strokeWidth).maybeTransition(t.transitionType,t.transitionDuration).attr("d",d3.line().x(function(e){return a(e[0])}).y(function(e){return n(e[1])})),i.push(o)}if(r.length<t.local.nsets){console.log("upd 3");for(let e=r.length;e<t.local.nsets;++e)o=i[e].datum(r[0]).join("path").maybeTransition(t.transitionType,t.transitionDuration).attr("d",t.local.line)}}return t.local.nsets=Math.max(r.length,t.local.nsets),o},g2d.Line.virtual=!0,g2d.Line.destroy=(e,t)=>{t.local&&t.local.object&&(Array.isArray(t.local.object)?t.local.object.forEach(e=>e.remove()):t.local.object.remove(),delete t.local.object)},g2d.Circle=async(e,t)=>{if(e.length>2)return t.local.arcQ=!0,await g2d._arc(e,t);let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let a=[1,1];e.length>1&&(a=await interpretate(e[1],t),Array.isArray(a)||(a=[a,a]));const n=t.xAxis,o=t.yAxis;t.local.coords=[n(r[0]),o(r[1])],t.local.r=[n(a[0])-n(0),Math.abs(o(a[1])-o(0))];const i=t.svg.append("ellipse").attr("vector-effect","non-scaling-stroke").attr("cx",n(r[0])).attr("cy",o(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]).style("stroke",t.color).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).style("fill","none").style("opacity",t.opacity);return t.local.object=i,t.dasharray&&i.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Circle.updateColor=(e,t)=>{t.local.object.style("stroke",t.color)},g2d.Circle.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Circle.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let a=1;e.length>1&&(a=await interpretate(e[1],t),Array.isArray(a)||(a=[a,a]));const n=t.xAxis,o=t.yAxis;return t.local.r=[n(a[0])-n(0),Math.abs(o(a[1])-o(0))],t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("cx",n(r[0])).attr("cy",o(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]),t.local.object},g2d.Circle.destroy=(e,t)=>{t.local.arcQ||(t.local.object.remove(),t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid])},g2d.Circle.virtual=!0;const deg=function(e){return 180*e/Math.PI},rad=function(e){return e*Math.PI/180};function getEllipsePointForAngle(e,t,r,a,n,o){const{abs:i,sin:s,cos:l}=Math,c=i(r)*l(o),u=i(a)*s(o);return[e+l(n)*c-s(n)*u,t+s(n)*c+l(n)*u]}function getEndpointParameters(e,t,r,a,n,o,i){const[s,l]=getEllipsePointForAngle(e,t,r,a,n,o),[c,u]=getEllipsePointForAngle(e,t,r,a,n,o+i);return{x1:s,y1:l,x2:c,y2:u,fa:Math.abs(i)>Math.PI?1:0,fs:i>0?1:0}}function getCenterParameters(e,t,r,a,n,o,i,s,l){const{abs:c,sin:u,cos:d,sqrt:p}=Math,f=e=>Math.pow(e,2),m=u(l),y=d(l),g=y*(e-r)/2+m*(t-a)/2,x=-m*(e-r)/2+y*(t-a)/2,A=f(g),T=f(x),h=f(i),E=f(s),b=A/h+T/E;b>1?(i=p(b)*c(i),s=p(b)*c(s)):(i=c(i),s=c(s));const _=n===o?-1:1,R=p((h*E-h*T-E*A)/(h*T+E*A))*_,S=R*(i*x)/s,v=R*(-s*g)/i,F=y*S-m*v+(e+r)/2,I=m*S+y*v+(t+a)/2,w=vectorAngle([1,0],[(g-S)/i,(x-v)/s]);let k=deg(vectorAngle([(g-S)/i,(x-v)/s],[(-g-S)/i,(-x-v)/s]))%360;return 0===o&&k>0&&(k-=360),1===o&&k<0&&(k+=360),{cx:F,cy:I,theta:w,dTheta:rad(k)}}function vectorAngle([e,t],[r,a]){const{acos:n,sqrt:o}=Math;return(e*a-t*r<0?-1:1)*n((e*r+t*a)/(o(e*e+t*t)*o(r*r+a*a)))}g2d.Annulus=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);Array.isArray(a)||(a=[a,a]);let n=(await interpretate(e[2],t)).map(e=>2*Math.PI-e);const o=t.xAxis,i=t.yAxis,[s,l]=a,c=o(s)-o(0),u=Math.abs(i(s)-i(0)),d=o(l)-o(0),p=Math.abs(i(l)-i(0)),f=o(r[0]),m=i(r[1]),[y,g]=n,x=g-y>Math.PI?0:1,A=[`M ${f+c*Math.cos(y)} ${m+u*Math.sin(y)}`,`A ${c} ${u} 0 ${x} 0 ${f+c*Math.cos(g)} ${m+u*Math.sin(g)}`,`L ${f+d*Math.cos(g)} ${m+p*Math.sin(g)}`,`A ${d} ${p} 0 ${x} 1 ${f+d*Math.cos(y)} ${m+p*Math.sin(y)}`,"Z"].join(" ");return t.svg.append("path").attr("vector-effect","non-scaling-stroke").style("fill",t.color).style("opacity",t.opacity).attr("d",A)},g2d._arc=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);Array.isArray(a)||(a=[a,a]);let n=(await interpretate(e[2],t)).map(e=>2*Math.PI-e);const o=t.xAxis,i=t.yAxis,s={cx:o(r[0]),cy:i(r[1]),phi:0,rx:o(a[0])-o(0),ry:Math.abs(i(a[1])-i(0)),start:n[0],delta:n[1]-n[0]},{x1:l,y1:c,x2:u,y2:d,fa:p,fs:f}=getEndpointParameters(s.cx,s.cy,s.rx,s.ry,s.phi,s.start,s.delta),{cx:m,cy:y,theta:g,dTheta:x}=getCenterParameters(l,c,u,d,p,f,s.rx,s.ry,s.phi),A=t.svg.append("path").attr("vector-effect","non-scaling-stroke").style("stroke",t.stroke||t.color).style("stroke-width",t.strokeWidth).style("opacity",t.opacity).attr("d",`M ${m} ${y}\n         L ${l} ${c}\n         A ${s.rx} ${s.ry} ${deg(s.phi)} ${p} ${f} ${u} ${d}\n         Z`);return A.style("fill",t.filled?t.color:"none"),A},g2dComplex.Disk=async(e,t)=>{if(e.length>2)throw"Graphics complex with arcs is not supported";let r=await interpretate(e[0],t),a=1;e.length>1&&(a=await interpretate(e[1],t),Array.isArray(a)&&(a=(a[0]+a[1])/2));const n=t.xAxis;if(t.yAxis,r[0]){const e=[],o=n(a)-n(0);return r.map(e=>t.wgl.fallbackVertices[e-1]).map(r=>{e.push(t.svg.append("circle").attr("vector-effect","non-scaling-stroke").attr("cx",r[0]).attr("cy",r[1]).attr("r",o).style("stroke","none").style("fill",t.color).style("opacity",t.opacity))}),e}{const e=t.wgl.fallbackVertices[r-1],o=[e[0],e[1]],i=n(a)-n(0);return t.svg.append("circle").attr("vector-effect","non-scaling-stroke").attr("cx",o[0]).attr("cy",o[1]).attr("r",i).style("stroke","none").style("fill",t.color).style("opacity",t.opacity)}},g2d.Disk=async(e,t)=>{if(e.length>2)return await g2d._arc(e,{...t,filled:!0});let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let a=[1,1];e.length>1&&(a=await interpretate(e[1],t),Array.isArray(a)||(a=[a,a]));const n=t.xAxis,o=t.yAxis;t.local.coords=[n(r[0]),o(r[1])],t.local.r=[n(a[0])-n(0),Math.abs(o(a[1])-o(0))];const i=t.svg.append("ellipse").attr("vector-effect","non-scaling-stroke").attr("cx",n(r[0])).attr("cy",o(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]).style("stroke",t.stroke).attr("stroke-width",t.strokeWidth).style("fill",t.color).style("opacity",t.opacity);return t.local.object=i,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Disk.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let a=t.local.r;e.length>1&&(a=await interpretate(e[1],t),Array.isArray(a)||(a=[a,a]));const n=t.xAxis,o=t.yAxis;t.local.coords=[n(r[0]),o(r[1])],t.local.r=[n(a[0])-n(0),Math.abs(o(a[1])-o(0))],t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("cx",t.local.coords[0]).attr("cy",t.local.coords[1]).attr("rx",t.local.r[0]).attr("ry",t.local.r[1])},g2d.Disk.updateColor=(e,t)=>{t.local.object.style("fill",t.color)},g2d.Disk.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Disk.virtual=!0,g2d.Disk.destroy=(e,t)=>{t.local&&t.local.object&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.object.remove(),delete t.local.object)},g2dComplex.Point=async(e,t)=>{let r=await interpretate(e[0],t),a=d3.color(t.color);if(a=[a.r/255,a.g/255,a.b/255,t.opacity],r[0][0])return;const{gl:n,programInfo:o}=t.wgl;let i,s=r.flat(1/0).map(e=>e-1);t.wgl.fallbackVertices.length>65535?(console.warn("Vertex buffer is too large and may not be indexed correctly"),i=twgl.createBufferInfoFromArrays(n,{indices:new Uint32Array(s)})):i=twgl.createBufferInfoFromArrays(n,{indices:new Uint16Array(s)}),twgl.setBuffersAndAttributes(n,o,i),twgl.setUniforms(o,{u_resolution:[n.canvas.width,n.canvas.height],u_color:a,u_pointSize:t.pointSize*window.devicePixelRatio*100*2,u_vertexColor:Boolean(t.wgl.vertexColors)}),t.wgl.fallbackVertices.length>65535?n.drawElements(n.POINTS,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.POINTS,i.numElements,n.UNSIGNED_SHORT,0)},g2d.Point=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const a=t.xAxis,n=t.yAxis,o=arrdims(r);0===o?r=[]:o<2&&(r=[r]);const i=t.svg.append("g").style("stroke-width",100*t.pointSize*2).style("stroke-linecap","round").style("stroke",t.color).style("opacity",t.opacity);t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root);const s=[];return r.forEach((e,t)=>{s.push(i.append("path").attr("d",`M ${a(e[0])} ${n(e[1])} l 0.0001 0`).attr("vector-effect","non-scaling-stroke"))}),t.local.points=s,t.local.object=i,i},g2d.Point.updateColor=(e,t)=>{t.local.object.style("stroke",t.color)},g2d.Point.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Point.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const a=arrdims(r);0===a?r=[]:a<2&&(r=[r]);const n=t.xAxis,o=t.yAxis;let i;const s=t.local.object,l=Math.min(t.local.points.length,r.length);let c=[0,0];for(let e=t.local.points.length;e<r.length;e++)e-1>=0&&(c=r[e-1]),i=s.append("path").attr("d",`M ${n(c[0])} ${o(c[1])} l 0.0001 0`).attr("vector-effect","non-scaling-stroke"),t.local.points.push(i),i=i.maybeTransition(t.transitionType,t.transitionDuration).attr("d",`M ${n(r[e][0])} ${o(r[e][1])} l 0.0001 0`);for(let e=t.local.points.length;e>r.length;e--)i=t.local.points.pop(),i.remove();for(let e=0;e<l;e++)i=t.local.points[e].maybeTransition(t.transitionType,t.transitionDuration).attr("d",`M ${n(r[e][0])} ${o(r[e][1])} l 0.0001 0`);return i},g2d.Point.virtual=!0,g2d.Point.destroy=(e,t)=>{t.local&&t.local.object&&(t.colorRefs&&delete t.colorRefs[t.root.uid],Array.isArray(t.local.object)?t.local.object.forEach(e=>e.remove()):t.local.object.remove(),delete t.local.object)};const getCanvas=e=>{let t={k:1,x:0,y:0};e.onZoom.push(e=>{t=e});const r={xAxis:e.xAxis,yAxis:e.yAxis};return e.xAxis=e=>0,e.yAxis=e=>0,e.xAxis.invert=a=>{const n=(a-t.x-e.panZoomEntites.left)/t.k;return r.xAxis.invert(n)},e.yAxis.invert=a=>{const n=(a-t.y-e.panZoomEntites.top)/t.k;return r.yAxis.invert(n)},e.panZoomEntites.canvas};function makeStadiumPath(e,t,r){const a=e[0],n=e[1],o=t[0],i=t[1];if(0===r||a===o&&n===i){if(0===r)return`M ${a} ${n} Z`;const e=a-r;return[`M ${e} ${n}`,`A ${r} ${r} 0 1 0 ${a+r} ${n}`,`A ${r} ${r} 0 1 0 ${e} ${n}`,"Z"].join(" ")}const s=o-a,l=i-n,c=Math.sqrt(s*s+l*l),u=s/c,d=-(l/c);return["M",a+d*r,n+u*r,"A",r,r,0,0,1,a-d*r,n-u*r,"L",o-d*r,i-u*r,"A",r,r,0,0,1,o+d*r,i+u*r,"Z"].join(" ")}async function _triangle__normalizeInput(e,t){let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const a=e=>e instanceof NumericArrayObject?e.normal():Array.isArray(e)?e:[e[0],e[1]];return(Array.isArray(r)&&3===r.length&&r.every(e=>Array.isArray(e)&&e.length>=2&&"number"==typeof e[0]&&"number"==typeof e[1])?[r]:r).map(e=>e.map(a))}g2d.EventListener=async(e,t)=>{const r=await interpretate(e[1],t),a={...t};let n=await interpretate(e[0],a);return n?Array.isArray(n)&&(n=n[0]):n=getCanvas(a),n.on_list||(n.on_list={}),r.forEach(e=>{g2d.EventListener[e.lhs](e.rhs,n,a)}),null},g2d.EventListener.update=async(e,t)=>{console.log("EventListener does not support updates")},g2d.EventListener.onload=(e,t,r)=>{console.log("onload event generator"),server.kernel.emitt(e,"True","onload")},g2d.MiddlewareListener=async(e,t)=>{const r=await core._getRules(e,t),a=await interpretate(e[1],t),n=await interpretate(e[2],t);return console.log(e),t.local.middleware=g2d.MiddlewareListener[a](n,r,t),await interpretate(e[0],t)},g2d.MiddlewareListener.update=(e,t)=>interpretate(e[0],t),g2d.MiddlewareListener.end=(e,t,r)=>{const a=t.Threshold||1;return server.kernel.emitt(e,"True","end"),console.log("pre Fire"),t=>{let r=!1;return t.then(t=>t.tween(e,function(t){return function(t){t>=a&&!r&&(server.kernel.emitt(e,"True","end"),r=!0)}}))}},g2d.MiddlewareListener.endtransition=g2d.MiddlewareListener.end,g2d.EventListener.drag=(e,t,r)=>{const a=r.xAxis,n=r.yAxis;let o=null;t.classed("cursor-pointer",!0);const i=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"drag")});t.call(d3.drag().on("start",function(e,t){o=this.getBBox()}).on("drag",function(e,t){if(!o)return;const r=e.x-o.width/2-o.x,s=e.y-o.height/2-o.y;d3.select(this).raise().attr("transform",`translate(${r},${s})`),i(a.invert(e.x),n.invert(e.y))}).on("end",function(e,t){}))},g2d.EventListener.dragsignal=(e,t,r)=>{console.log("dragsignal event generator"),console.log(r.local),t.classed("cursor-pointer",!0);let a={k:1,x:0,y:0};r.onZoom.push(e=>{a=e});const n=e=>{const t=(e-a.x-r.panZoomEntites.left)/a.k;return r.xAxis.invert(t)},o=e=>{const t=(e-a.y-r.panZoomEntites.top)/a.k;return r.yAxis.invert(t)},i=r.panZoomEntites.canvas.node();let s=[0,0];const l=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"dragsignal")});function c(e){const t=d3.pointer(e,i),r=t[0]+0*s[0],a=t[1]+0*s[1];l(n(r),o(a))}function u(){i.removeEventListener("mousemove",c),i.removeEventListener("mouseup",u)}t.on("mousedown",function(e){e.stopPropagation(),e.preventDefault();const t=e.target.getBBox(),r=[t.x+t.width/2,t.y+t.height/2],a=d3.pointer(e,i);s=[r[0]-a[0],r[1]-a[1]];const d=a[0],p=a[1];l(n(d),o(p)),i.addEventListener("mousemove",c),i.addEventListener("mouseup",u)})},g2d.EventListener.dragall=(e,t,r)=>{console.log("drag event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis;const o=throttle((t,r,a)=>{server.kernel.io.fire(e,[String(a),[t,r]],"dragall")});t.call(d3.drag().on("start",function(e,t){o(a.invert(e.x),n.invert(e.y),"dragstarted")}).on("drag",function(e,t){o(a.invert(e.x),n.invert(e.y),"dragged")}).on("end",function(e,t){o(a.invert(e.x),n.invert(e.y),"dragended")}))},g2d.EventListener.click=(e,t,r)=>{console.log("click event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"click")});function i(e,t){e.altKey||o(a.invert(t[0]),n.invert(t[1]))}t.classed("cursor-pointer",!0),"click"in t.on_list?t.on_list.click.push(e=>i(e,d3.pointer(e))):(t.on_list.click=[e=>i(e,d3.pointer(e))],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)}))},g2d.EventListener.mousedown=(e,t,r)=>{console.log("mousedown event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousedown")});t.on("mousedown",e=>{return t=d3.pointer(e),void o(a.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.mouseup=(e,t,r)=>{console.log("mouseup event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseup")});t.on("mouseup",e=>{return t=d3.pointer(e),void o(a.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.altclick=(e,t,r)=>{console.log("click event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"altclick")});function i(e,t){e.altKey&&o(a.invert(t[0]),n.invert(t[1]))}"click"in t.on_list?t.on_list.click.push(e=>i(e,d3.pointer(e))):(t.on_list.click=[e=>i(e,d3.pointer(e))],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)}))},g2d.EventListener.capturekeydown=(e,t,r)=>{let a,n=!0;const o=t;a=()=>{n&&(o.node().focus(),n=!1)};var i;i=a,"click"in t.on_list?t.on_list.click.push(i):(t.on_list.click=[i],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)})),o.on("blur",()=>{n=!0}),o.node().addEventListener("keydown",t=>{server.kernel.emitt(e,'"'+t.code+'"',"capturekeydown"),t.preventDefault()})},g2d.EventListener.keydown=(e,t,r)=>{let a,n=!0;const o=t;a=()=>{n&&(o.node().focus(),n=!1)};var i;i=a,"click"in t.on_list?t.on_list.click.push(i):(t.on_list.click=[i],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)})),o.on("blur",()=>{n=!0}),o.addEventListener("keydown",t=>{server.kernel.emitt(e,'"'+t.code+'"',"keydown")})},g2d.EventListener.mousemove=(e,t,r)=>{console.log("mouse event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousemove")});t.on("mousemove",e=>{return t=d3.pointer(e),void o(a.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.mouseover=(e,t,r)=>{console.log("mouse event generator"),console.log(r.local);const a=r.xAxis,n=r.yAxis,o=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseover")});t.on("mouseover",e=>{return t=d3.pointer(e),void o(a.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.zoom=(e,t,r)=>{console.log("zoom event generator"),console.log(r.local);const a=throttle(t=>{server.kernel.io.fire(e,t,"zoom")});t.call(d3.zoom().on("zoom",function(e){console.log(),a(e.transform.k)}))},g2d.Rotate=async(e,t)=>{const r=await interpretate(e[1],t);let a;if(e.length>2&&(a=await interpretate(e[2],t),t.local.aligment=a),!t.svg)return await interpretate(e[0],{});const n=t.svg.append("g");t.local.group=n,await interpretate(e[0],{...t,svg:n});let o=n.node().getBBox();a?(o.x=t.xAxis(a[0]),o.y=t.yAxis(a[1])):(o.x=o.x+o.width/2,o.y=o.y+o.height/2);const i="rotate("+-r/Math.PI*180+", "+o.x+", "+o.y+")";n.attr("transform",i),t.local.rotation=i},g2d.Rotate.update=async(e,t)=>{const r=await interpretate(e[1],t);let a;a=t.local.group.node().getBBox(),t.local.aligment?(a.x=t.xAxis(t.local.aligment[0]),a.y=t.yAxis(t.local.aligment[1])):(a.x=a.x+a.width/2,a.y=a.y+a.height/2);const n="rotate("+-r/Math.PI*180+", "+a.x+", "+a.y+")";var o=d3.interpolateString(t.local.rotation,n);t.local.group.maybeTransitionTween(t.transitionType,t.transitionDuration,"transform",function(e,t,r){return o}),t.local.rotation=n},g2d.Rotate.virtual=!0,g2d.Rotate.destroy=(e,t)=>{console.log("nothing to destroy")},g2d.GraphicsBoxOptions=()=>{},g2d.StrokeForm=()=>{},g2d.FontOpacity=()=>{},g2d.GeometricTransformation=async(e,t)=>{let r=await interpretate(e[1],t);const a=t.svg.append("g");t.local.group=a;const n=t.xAxis,o=t.yAxis;if(r.length>3){for(let i of r){if(!Array.isArray(i))continue;const r=a.append("g");i=i[0],"number"==typeof i[0]&&("number"==typeof i[1]&&(i=[n(i[0])-n(0),o(i[1])-o(0)],r.attr("transform",`translate(${i.join(",")})`),await interpretate(e[0],{...t,svg:r})))}return a}return await interpretate(e[0],{...t,svg:a}),console.warn(r),2==r.length?(r[0][0][1]=-r[0][0][1],r[0][1][0]=-r[0][1][0],r[0]=r[0].flat(1/0),r[1]=[n(r[1][0])-n(0),o(r[1][1])-o(0)],a.attr("transform",`matrix(${r[0].join(",")},${r[1].join(",")})`)):(r[0][1]=-r[0][1],r[1][0]=-r[1][0],r=r.flat(1/0),a.attr("transform",`matrix(${r.join(",")})`))},g2d.Translate=async(e,t)=>{let r=await interpretate(e[1],t);const a=t.svg.append("g");t.local.group=a;const n=t.xAxis,o=t.yAxis;if(r instanceof NumericArrayObject&&(r=r.normal()),Array.isArray(r[0])){const i=a.append("g"),s=[i];t.local.subgroups=s,i.attr("transform",`translate(${n(r[0][0])-n(0)}, ${o(r[0][1])-o(0)})`);const l=i.append("g");await interpretate(e[0],{...t,svg:l});for(let e=1;e<r.length;++e){const t=a.append("g"),i=r[e];s.push(t),t.attr("transform",`translate(${n(i[0])-n(0)}, ${o(i[1])-o(0)})`),t.append(()=>l.clone(!0).node())}return a}return a.attr("transform",`translate(${n(r[0])-n(0)}, ${o(r[1])-o(0)})`),await interpretate(e[0],{...t,svg:a}),a},g2d.Translate.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());const a=t.xAxis,n=t.yAxis;if(!t.local.subgroups)return t.local.group.maybeTransition(t.transitionType,t.transitionDuration).attr("transform",`translate(${a(r[0])-a(0)}, ${n(r[1])-n(0)})`);for(let e=0;e<t.local.subgroups.length;++e){const o=r[e];t.local.subgroups[e].maybeTransition(t.transitionType,t.transitionDuration).attr("transform",`translate(${a(o[0])-a(0)}, ${n(o[1])-n(0)})`)}},g2d.Translate.virtual=!0,g2d.Translate.destroy=(e,t)=>{t.local.group.remove()},g2d.Center=()=>"Center",g2d.Center.update=g2d.Center,g2d.Top=()=>"Top",g2d.Top.update=g2d.Top,g2d.Bottom=()=>"Bottom",g2d.Bottom.update=g2d.Bottom,g2d.Left=()=>"Left",g2d.Left.update=g2d.Left,g2d.Right=()=>"Right",g2d.Right.update=g2d.Right,g2d.Degree=()=>Math.PI/180,g2d.Degree.update=g2d.Degree,g2d.RoundingRadius=()=>"RoundingRadius",g2d.RoundingRadius.update=()=>"RoundingRadius",g2d.Rectangle=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);const n=await core._getRules(e,t);if(r instanceof NumericArrayObject&&(r=r.normal()),a instanceof NumericArrayObject&&(a=a.normal()),r[1]>a[1]){const e=r[1];r[1]=a[1],a[1]=e}if(r[0]>a[0]){const e=r[0];r[0]=a[0],a[0]=e}const o=t.xAxis,i=t.yAxis;r[0]=o(r[0]),r[1]=i(r[1]),a[0]=o(a[0]),a[1]=i(a[1]);const s=[Math.abs(a[0]-r[0]),Math.abs(a[1]-r[1])];return t.local.rect=t.svg.append("rect").attr("x",r[0]).attr("y",r[1]-s[1]).attr("width",s[0]).attr("height",s[1]).attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color),n.RoundingRadius&&("number"==typeof n.RoundingRadius?t.local.rect.attr("rx",50*n.RoundingRadius/.75):Array.isArray(n.RoundingRadius)&&(t.local.rect.attr("rx",50*n.RoundingRadius[0]/.75),t.local.rect.attr("ry",50*n.RoundingRadius[1]/.75))),t.dasharray&&t.local.rect.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.rect},g2d.Rectangle.updateColor=(e,t)=>{t.local.rect.attr("fill",t.color)},g2d.Rectangle.updateOpacity=(e,t)=>{t.local.rect.attr("opacity",t.opacity)},g2d.Rectangle.update=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);const n=await core._getRules(e,t);if(r instanceof NumericArrayObject&&(r=r.normal()),a instanceof NumericArrayObject&&(a=a.normal()),r[1]>a[1]){const e=r[1];r[1]=a[1],a[1]=e}if(r[0]>a[0]){const e=r[0];r[0]=a[0],a[0]=e}const o=t.xAxis,i=t.yAxis;r[0]=o(r[0]),r[1]=i(r[1]),a[0]=o(a[0]),a[1]=i(a[1]);const s=[Math.abs(a[0]-r[0]),Math.abs(a[1]-r[1])];t.local.rect.maybeTransition(t.transitionType,t.transitionDuration).attr("x",r[0]).attr("y",r[1]-s[1]).attr("width",s[0]).attr("height",s[1]),n.RoundingRadius&&("number"==typeof n.RoundingRadius?t.local.rect.attr("rx",50*n.RoundingRadius/.75):Array.isArray(n.RoundingRadius)&&(t.local.rect.attr("rx",50*n.RoundingRadius[0]/.75),t.local.rect.attr("ry",50*n.RoundingRadius[1]/.75)))},g2d.Rectangle.virtual=!0,g2d.Rectangle.destroy=(e,t)=>{console.log("nothing to destroy"),t.local&&t.local.rect&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.rect.remove(),delete t.local.rect)},g2d.StadiumShape=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);await core._getRules(e,t),r instanceof NumericArrayObject&&(r=r.normal()),a instanceof NumericArrayObject&&(a=a.normal()),Array.isArray(a)&&(a=a[0]);let n=r[0],o=r[1];n instanceof NumericArrayObject&&(n=n.normal()),o instanceof NumericArrayObject&&(o=o.normal());const i=t.xAxis,s=t.yAxis,l=[i(n[0]),s(n[1])],c=[i(o[0]),s(o[1])];let u=0;"number"==typeof a&&(u=Math.abs(i(n[0]+a)-i(n[0])));const d=makeStadiumPath(l,c,u);return t.local.stadium=t.svg.append("path").attr("d",d).attr("vector-effect","non-scaling-stroke").attr("fill",t.color).attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity),t.dasharray&&t.local.stadium.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.stadium},g2d.StadiumShape.updateColor=(e,t)=>{t.local&&t.local.stadium&&t.local.stadium.attr("fill",t.color)},g2d.StadiumShape.updateOpacity=(e,t)=>{t.local&&t.local.stadium&&t.local.stadium.attr("opacity",t.opacity)},g2d.StadiumShape.update=async(e,t)=>{let r=await interpretate(e[0],t),a=await interpretate(e[1],t);await core._getRules(e,t),r instanceof NumericArrayObject&&(r=r.normal()),a instanceof NumericArrayObject&&(a=a.normal()),Array.isArray(a)&&(a=a[0]);let n=r[0],o=r[1];n instanceof NumericArrayObject&&(n=n.normal()),o instanceof NumericArrayObject&&(o=o.normal());const i=t.xAxis,s=t.yAxis,l=[i(n[0]),s(n[1])],c=[i(o[0]),s(o[1])];let u=0;"number"==typeof a&&(u=Math.abs(i(n[0]+a)-i(n[0])));const d=makeStadiumPath(l,c,u);t.local.stadium.maybeTransition(t.transitionType,t.transitionDuration).attr("d",d)},g2d.StadiumShape.virtual=!0,g2d.StadiumShape.destroy=(e,t)=>{console.log("StadiumShape destroy"),t.local&&t.local.stadium&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.stadium.remove(),delete t.local.stadium)},g2d.Triangle=async(e,t)=>{const r=await _triangle__normalizeInput(e,t),a=t.xAxis,n=t.yAxis;t.local||(t.local={}),t.local.triGroup=t.svg.append("g");const o=r.map(e=>e.map(([e,t])=>[a(e),n(t)]));let i=t.local.triGroup.selectAll("polygon").data(o);const s=i.enter().append("polygon").attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color).attr("points",e=>e.map(([e,t])=>`${e},${t}`).join(" "));return t.dasharray&&s.attr("stroke-dasharray",t.dasharray.join()),t.local.triangles=s.merge(i),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.triGroup},g2d.Tooltip=async(e,t)=>{try{await interpretate(e[0],t)}catch(e){console.error(e)}},g2d.Tooltip.update=g2d.Tooltip,g2d.Triangle.updateColor=(e,t)=>{t.local?.triGroup&&t.local.triGroup.selectAll("polygon").attr("fill",t.color)},g2d.Triangle.updateOpacity=(e,t)=>{t.local?.triGroup&&t.local.triGroup.selectAll("polygon").attr("opacity",t.opacity)},g2d.Triangle.update=async(e,t)=>{const r=await _triangle__normalizeInput(e,t),a=t.xAxis,n=t.yAxis,o=r.map(e=>e.map(([e,t])=>[a(e),n(t)]));let i=t.local.triGroup.selectAll("polygon").data(o);i.exit().remove();const s=i.enter().append("polygon").attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color);t.dasharray&&s.attr("stroke-dasharray",t.dasharray.join()),i=s.merge(i),i.maybeTransition(t.transitionType,t.transitionDuration).attr("points",e=>e.map(([e,t])=>`${e},${t}`).join(" "))},g2d.Triangle.virtual=!0,g2d.Triangle.destroy=(e,t)=>{t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local?.triGroup&&(t.local.triGroup.remove(),delete t.local.triGroup),t.local?.triangles&&delete t.local.triangles},g2d.Void=(e,t)=>{},g2d.Identity=g2d.Void,g2d.Scaled=async(e,t)=>{if(1==e.length){const r=await interpretate(e[0],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+t.plotRange[0][0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+t.plotRange[1][0]]}{const r=await interpretate(e[0],t),a=await interpretate(e[1],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+a[0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+a[1]]}},g2d.Scaled.update=g2d.Scaled,g2d.GoldenRatio=g2d.Void,g2d.None=()=>!1,g2d.AbsolutePointSize=g2d.Void,g2d.CopiedValueFunction=g2d.Void,g2d.Raster=async(e,t)=>{if(t.image)return await interpretate(e[0],t);const r=await interpretate(e[0],{...t,context:g2d,nfast:!0,numeric:!0});console.log(e);const a=r.length,n=r[0].length,o=r[0][0].length,i=t.xAxis,s=t.yAxis;let l=[[0,n],[0,a]];if(e.length>1){const r=await interpretate(e[1],t);l[0][0]=r[0][0],l[0][1]=r[1][0],l[1][0]=r[0][1],l[1][1]=r[1][1]}e.length>2&&(await interpretate(e[2],t),console.warn("scaling is not implemented!"));const c=Math.abs((i(l[0][1])-i(l[0][0]))/n),u=Math.abs((s(l[1][1])-s(l[1][0]))/a),d=(l[0][1]-l[0][0])/n,p=(l[1][1]-l[1][0])/a,f=t.svg;if(o)if(2!==o)if(3!==o)if(4!==o);else for(let e=0;e<a;++e)for(let t=0;t<n;++t)f.append("rect").attr("x",i(d*t+l[0][0])).attr("y",s(p*e+l[1][0])-u).attr("width",c).attr("height",u).attr("opacity",r[e][t][3]).attr("fill",`rgb(${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][1])}, ${Math.floor(255*r[e][t][2])})`);else for(let e=0;e<a;++e)for(let a=0;a<n;++a)f.append("rect").attr("x",i(d*a+l[0][0])).attr("y",s(p*e+l[1][0])-u).attr("width",c).attr("height",u).attr("opacity",t.opacity).attr("fill",`rgb(${Math.floor(255*r[e][a][0])}, ${Math.floor(255*r[e][a][1])}, ${Math.floor(255*r[e][a][2])})`);else for(let e=0;e<a;++e)for(let t=0;t<n;++t)f.append("rect").attr("x",i(d*t+l[0][0])).attr("y",s(p*e+l[1][0])-u).attr("width",c).attr("height",u).attr("opacity",r[e][t][1]).attr("fill",`rgb(${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][0])})`);else for(let e=0;e<a;++e)for(let a=0;a<n;++a)f.append("rect").attr("x",i(d*a+l[0][0])).attr("y",s(p*e+l[1][0])-u).attr("width",c).attr("height",u).attr("opacity",t.opacity).attr("fill",`rgb(${Math.floor(255*r[e][a])}, ${Math.floor(255*r[e][a])}, ${Math.floor(255*r[e][a])})`)},g2d.Magnification=()=>"Magnification",g2d.ColorSpace=()=>"ColorSpace",g2d.Interleaving=()=>"Interleaving",g2d.MetaInformation=()=>"MetaInformation",g2d.ImageResolution=()=>"ImageResolution",g2d.DateObject=()=>{console.warn("Date Object is not supported for now")};const numericAccelerator={TypeReal:{},TypeInteger:{}},types={Real64:{context:numericAccelerator.TypeReal,constructor:Float64Array},Real32:{context:numericAccelerator.TypeReal,constructor:Float32Array},Integer32:{context:numericAccelerator.TypeInteger,constructor:Int32Array},Integer64:{context:numericAccelerator.TypeInteger,constructor:BigInt64Array},Integer16:{context:numericAccelerator.TypeInteger,constructor:Int16Array},Integer8:{context:numericAccelerator.TypeInteger,constructor:Int8Array},UnsignedInteger32:{context:numericAccelerator.TypeInteger,constructor:Uint32Array},UnsignedInteger64:{context:numericAccelerator.TypeInteger,constructor:BigUint64Array},UnsignedInteger16:{context:numericAccelerator.TypeInteger,constructor:Uint16Array},UnsignedInteger8:{context:numericAccelerator.TypeInteger,constructor:Uint8Array}};function checkdims(e,t=[]){return Array.isArray(e)?(t.push(e.length),checkdims(e[0],t)):t}const WLNumber=new RegExp(/^(-?\d+)(.?\d*)(\*\^)?(\d*)/),isInteger=window.isNumeric;function readArray(e,t){if(Array.isArray(e[1]))for(let r=1;r<e.length;++r)readArray(e[r],t);else t.array.set(e.slice(1).map(e=>{if("string"==typeof e){if(isInteger(e))return parseInt(e);if(WLNumber.test(e)){let[t,r,a,n,o]=e.split(WLNumber);return r+="."===a?a+"0":a,n&&(r+="E"+o),parseFloat(r)}}return e}),t.index),t.index+=e.length-1}function moveRGBAReal(e,t,r){var a,n=0;for(a=0;a<r<<2;)t[a++]=255*e[n++]>>>0,t[a++]=255*e[n++]>>>0,t[a++]=255*e[n++]>>>0,t[a++]=255*e[n++]>>>0}function moveRGBReal(e,t,r){var a,n=0;const o=new Uint32Array(t.buffer);for(a=0;a<r;a++)o[a]=4278190080+(255*e[n++]>>>0)+(255*e[n++]>>>0<<8)+(255*e[n++]>>>0<<16)}function moveRGBReal2(e,t,r){var a,n=0;const o=new Uint32Array(t.buffer);for(a=0;a<r;a++)o[a]=4278190080+(255*e[n++]>>>0)+(255*e[n++]>>>0<<8)}function moveRGBRealTransposed(e,t,r){const a=new Uint32Array(t.buffer),n=r,o=2*r;for(let t=0;t<r;t++){const r=255*e[t]>>>0,i=255*e[n+t]>>>0,s=255*e[o+t]>>>0;a[t]=4278190080+r+(i<<8)+(s<<16)}}function moveGrayReal(e,t,r){var a;const n=new Uint32Array(t.buffer);for(a=0;a<r;a++){const t=255*e[a]>>>0;n[a]=4278190080+(t<<16)+(t<<8)+t}}function moveRGB(e,t,r){var a,n=0;const o=new Uint32Array(t.buffer);for(a=0;a<r;a++)o[a]=4278190080+e[n++]+(e[n++]<<8)+(e[n++]<<16)}function moveRGBTransposed(e,t,r){const a=new Uint32Array(t.buffer),n=r,o=2*r;for(let t=0;t<r;t++){const r=e[t],i=e[n+t],s=e[o+t];a[t]=4278190080+r+(i<<8)+(s<<16)}}function moveRGBATransposed(e,t,r){const a=new Uint32Array(t.buffer),n=r,o=2*r,i=3*r;for(let t=0;t<r;t++){const r=e[t],s=e[n+t],l=e[o+t],c=e[i+t];a[t]=(c<<24)+r+(s<<8)+(l<<16)}}function moveRGB2(e,t,r){var a,n=0;const o=new Uint32Array(t.buffer);for(a=0;a<r;a++)o[a]=4278190080+e[n++]+(e[n++]<<8)}function moveGray(e,t,r){var a;const n=new Uint32Array(t.buffer);for(a=0;a<r;a++){const t=e[a];n[a]=4278190080+(t<<16)+(t<<8)+t}}function moveGrayBits(e,t,r){var a;const n=new Uint32Array(t.buffer);for(a=0;a<r;a++){const t=e[a]<<8;n[a]=4278190080+(t<<16)+(t<<8)+t}}numericAccelerator.NumericArray=(e,t)=>{const r=types[interpretate(e[1])],a=[];let n=e[0].length-1;a.push(n),"List"===e[0][1][0]&&(n*=e[0][1].length-1,a.push(e[0][1].length-1),"List"===e[0][1][1][0]&&(n*=e[0][1][1].length-1,a.push(e[0][1][1].length-1)));const o=new r.constructor(n);return readArray(e[0],{index:0,array:o}),{buffer:o,dims:a}},numericAccelerator.NumericArray.update=numericAccelerator.NumericArray;const imageTypes={Byte:{constructor:Uint8Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){return new Uint8ClampedArray(e.buffer)}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGB(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGB2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA or RG!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGray(e.buffer,r,t),r}throw"This is not an image data!"},convert_nonInterleaved:e=>{const t=e.dims[0];if(3===t||4===t){const r=e.dims[2]*e.dims[1],a=new Uint8ClampedArray(r<<2);return 3===t?moveRGBTransposed(e.buffer,a,r):moveRGBATransposed(e.buffer,a,r),a}throw console.error(e),"convert_nonInterleaved has limited support"}},Bit:{constructor:Uint8Array,convert:e=>{const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayBits(e.buffer,r,t),r}},Real32:{constructor:Float32Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBAReal(e.buffer,r,t),r}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA or RG!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayReal(e.buffer,r,t),r}throw"This is not an image data!"},convert_nonInterleaved:e=>{if(3===e.dims[0]){const t=e.dims[2]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBRealTransposed(e.buffer,r,t),r}throw"convert_nonInterleaved has a limited support"}},Real64:{contructor:Float64Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBAReal(e.buffer,r,t),r}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayReal(e.buffer,r,t),r}throw"This is not an image data!"}}};g2d.Antialiasing=()=>"Antialiasing";var imageContext={};let runOptcodes$1;imageContext.EventListener=async(e,t)=>{const r=await interpretate(e[1],t),a={...t},n=t.local.canvas;return r.forEach(e=>{imageContext.EventListener[e.lhs](e.rhs,n,a)}),null},imageContext.EventListener.click=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"click")});t.addEventListener("click",function(e){e.altKey||n(e.offsetX*a,e.offsetY*a)})},imageContext.EventListener.altclick=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"altclick")});t.addEventListener("click",function(e){e.altKey&&n(e.offsetX*a,e.offsetY*a)})},imageContext.EventListener.mouseup=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseup")});t.addEventListener("mouseup",function(e){n(e.offsetX*a,e.offsetY*a)})},imageContext.EventListener.mousedown=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousedown")});t.addEventListener("mousedown",function(e){n(e.offsetX*a,e.offsetY*a)})},imageContext.EventListener.mousemove=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousemove")});t.addEventListener("mousemove",function(e){n(e.offsetX*a,e.offsetY*a)})},imageContext.EventListener.mouseover=(e,t,r)=>{const a=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseover")});t.addEventListener("mouseover",function(e){n(e.offsetX*a,e.offsetY*a)})},g2d.Image=async(e,t)=>{const r=await core._getRules(e,{...t,context:g2d,hold:!0});let a=await interpretate(e[0],{...t,context:[numericAccelerator,g2d]});if(a instanceof HTMLCanvasElement)return t.offscreen||t.element.appendChild(a),t.local.canvas=a,a;let n,o="Real32";e.length-Object.keys(r).length>1&&(o=interpretate(e[1])),o=imageTypes[o];let i,s,l=!0;"Interleaving"in r&&(l=interpretate(r.Interleaving,{})),Array.isArray(a)&&(console.warn("Will be slow. Not a typed array"),a={buffer:a.flat(1/0),dims:checkdims(a)}),l?(console.warn(o),n=o.convert(a)):n=o.convert_nonInterleaved(a),t.local.type=o,console.log("ImageSize"),console.log(a.dims),l?(s=a.dims[0],i=a.dims[1]):(s=a.dims[1],i=a.dims[2]),t.local.interleaving=l,t.local.dims=a.dims,n=new ImageData(new Uint8ClampedArray(n),i,s);let c=r.ImageSize;if(c=await interpretate(r.ImageSize,{...t,context:g2d}),r.Magnification){const e=await interpretate(r.Magnification,{...t,context:g2d});c=Math.floor(i*e)}c||(c=t.imageSize?t.imageSize:i),Array.isArray(c)?"number"!=typeof c[0]&&(c=[i,s]):"number"!=typeof c&&(c=i),Array.isArray(c)&&(c=c[0]);const u=Math.floor(c),d=Math.floor(s/i*c);let p;console.warn("ImageSize"),console.warn({target_width:u,target_height:d}),t.local.targetDims=[d,u];const f=window.devicePixelRatio;var m=document.createElement("canvas");return m.width=u,m.height=d,t.offscreen||t.element.appendChild(m),m.style.width=u/f+"px",m.style.height=d/f+"px",p=m.getContext("2d"),t.local.ctx=p,t.local.canvas=m,"Antialiasing"in r&&(p.imageSmoothingEnabled=await interpretate(r.Antialiasing,{...t,context:g2d})),u!=i||d!=s?(t.local.resized=!0,console.warn("Resizing might be slow"),n=await createImageBitmap(n),p.drawImage(n,0,0,u,d)):p.putImageData(n,0,0),r.Epilog&&interpretate(r.Epilog,{...t,context:[imageContext,g2d]}),m},g2d.Image.update=async(e,t)=>{let r=await interpretate(e[0],{...t,context:[numericAccelerator,g2d]});if(Array.isArray(r)&&(console.warn("Image:update: not a typed array. It will be slow..."),r={buffer:r.flat(1/0),dims:checkdims(r)}),!t.local.interleaving)throw"Update with no interleaving is not supported!";let a=t.local.type.convert(r);a=new ImageData(new Uint8ClampedArray(a),t.local.dims[1],t.local.dims[0]),t.local.resized?(a=await createImageBitmap(a),t.local.ctx.clearRect(0,0,t.local.targetDims[1],t.local.targetDims[0]),t.local.ctx.drawImage(a,0,0,t.local.targetDims[1],t.local.targetDims[0])):t.local.ctx.putImageData(a,0,0)},g2d.Image.destroy=(e,t)=>{t.local?.canvas?.remove()},core["Canvas2D`Private`ctx"]=async(e,t)=>{if(!t.root.parent)throw"ctx cannot be executed without parent node";if("Image"!=t.root.parent.firstName)throw console.error(t.root.parent),"parent node is not Image";const r=await core._getRules(t.root.parent.virtual.slice(1),{...t,hold:!0,context:[g2d,imageContext]}),a=await interpretate(e[1],t);runOptcodes$1||(runOptcodes$1=(await Promise.resolve().then(function(){return canvas2d})).runOptcodes);const n=document.createElement("canvas");r.ImageResolution=await interpretate(r.ImageResolution,t),"number"!=typeof r.ImageResolution[0]&&(r.ImageResolution=[500,500]),n.width=r.ImageResolution[0],n.height=r.ImageResolution[1];const o=n.getContext("2d");t.local.ctx=o,t.local.canvas=n,r.Prolog&&await interpretate(r.Prolog,{...t,context:[imageContext,g2d]});const i=window.devicePixelRatio||1;return n.style.width=r.ImageResolution[0]/i+"px",n.style.height=r.ImageResolution[1]/i+"px",t.local.refmap=new Map,await runOptcodes$1(t.local.ctx,a,t.local.refmap),r.Epilog&&await interpretate(r.Epilog,{...t,context:[imageContext,g2d]}),n},core["Canvas2D`Private`ctx"].virtual=!0,core["Canvas2D`Private`ctx"].update=async(e,t)=>{const r=await interpretate(e[1],t);await runOptcodes$1(t.local.ctx,r,t.local.refmap)},core["Canvas2D`Private`ctx"].destroy=(e,t)=>{t.local.canvas.remove(),t.local.refmap.clear()},g2d.Image.virtual=!0,g2d.Graphics.virtual=!0,g2d.GraphicsGroupBox=g2d.GraphicsGroup,g2d.GraphicsComplexBox=g2d.GraphicsComplex,g2d.DiskBox=g2d.Disk,g2d.LineBox=g2d.Line;
/* @license twgl.js 5.5.3 Copyright (c) 2015, Gregg Tavares All Rights Reserved.
Available via the MIT license.
see: http://github.com/greggman/twgl.js for details */
const BYTE$2=5120,UNSIGNED_BYTE$3=5121,SHORT$2=5122,UNSIGNED_SHORT$3=5123,INT$3=5124,UNSIGNED_INT$3=5125,FLOAT$3=5126,UNSIGNED_SHORT_4_4_4_4$1=32819,UNSIGNED_SHORT_5_5_5_1$1=32820,UNSIGNED_SHORT_5_6_5$1=33635,HALF_FLOAT$1=5131,UNSIGNED_INT_2_10_10_10_REV$1=33640,UNSIGNED_INT_10F_11F_11F_REV$1=35899,UNSIGNED_INT_5_9_9_9_REV$1=35902,FLOAT_32_UNSIGNED_INT_24_8_REV$1=36269,UNSIGNED_INT_24_8$1=34042,glTypeToTypedArray={};{const e=glTypeToTypedArray;e[BYTE$2]=Int8Array,e[UNSIGNED_BYTE$3]=Uint8Array,e[SHORT$2]=Int16Array,e[UNSIGNED_SHORT$3]=Uint16Array,e[INT$3]=Int32Array,e[UNSIGNED_INT$3]=Uint32Array,e[FLOAT$3]=Float32Array,e[UNSIGNED_SHORT_4_4_4_4$1]=Uint16Array,e[UNSIGNED_SHORT_5_5_5_1$1]=Uint16Array,e[UNSIGNED_SHORT_5_6_5$1]=Uint16Array,e[HALF_FLOAT$1]=Uint16Array,e[UNSIGNED_INT_2_10_10_10_REV$1]=Uint32Array,e[UNSIGNED_INT_10F_11F_11F_REV$1]=Uint32Array,e[UNSIGNED_INT_5_9_9_9_REV$1]=Uint32Array,e[FLOAT_32_UNSIGNED_INT_24_8_REV$1]=Uint32Array,e[UNSIGNED_INT_24_8$1]=Uint32Array}function getGLTypeForTypedArray(e){if(e instanceof Int8Array)return BYTE$2;if(e instanceof Uint8Array)return UNSIGNED_BYTE$3;if(e instanceof Uint8ClampedArray)return UNSIGNED_BYTE$3;if(e instanceof Int16Array)return SHORT$2;if(e instanceof Uint16Array)return UNSIGNED_SHORT$3;if(e instanceof Int32Array)return INT$3;if(e instanceof Uint32Array)return UNSIGNED_INT$3;if(e instanceof Float32Array)return FLOAT$3;throw new Error("unsupported typed array type")}function getGLTypeForTypedArrayType(e){if(e===Int8Array)return BYTE$2;if(e===Uint8Array)return UNSIGNED_BYTE$3;if(e===Uint8ClampedArray)return UNSIGNED_BYTE$3;if(e===Int16Array)return SHORT$2;if(e===Uint16Array)return UNSIGNED_SHORT$3;if(e===Int32Array)return INT$3;if(e===Uint32Array)return UNSIGNED_INT$3;if(e===Float32Array)return FLOAT$3;throw new Error("unsupported typed array type")}function getTypedArrayTypeForGLType(e){const t=glTypeToTypedArray[e];if(!t)throw new Error("unknown gl type");return t}const isArrayBuffer$1="undefined"!=typeof SharedArrayBuffer?function(e){return e&&e.buffer&&(e.buffer instanceof ArrayBuffer||e.buffer instanceof SharedArrayBuffer)}:function(e){return e&&e.buffer&&e.buffer instanceof ArrayBuffer};var typedarrays=Object.freeze({__proto__:null,getGLTypeForTypedArray:getGLTypeForTypedArray,getGLTypeForTypedArrayType:getGLTypeForTypedArrayType,getTypedArrayTypeForGLType:getTypedArrayTypeForGLType,isArrayBuffer:isArrayBuffer$1});function copyExistingProperties(e,t){Object.keys(t).forEach(function(r){t.hasOwnProperty(r)&&e.hasOwnProperty(r)&&(t[r]=e[r])})}function error$1(...e){console.error(...e)}function warn$1(...e){console.warn(...e)}const isTypeWeakMaps=new Map;function isType(e,t){if(!e||"object"!=typeof e)return!1;let r=isTypeWeakMaps.get(t);r||(r=new WeakMap,isTypeWeakMaps.set(t,r));let a=r.get(e);if(void 0===a){const n=Object.prototype.toString.call(e);a=n.substring(8,n.length-1)===t,r.set(e,a)}return a}function isBuffer(e,t){return"undefined"!=typeof WebGLBuffer&&isType(t,"WebGLBuffer")}function isRenderbuffer(e,t){return"undefined"!=typeof WebGLRenderbuffer&&isType(t,"WebGLRenderbuffer")}function isTexture(e,t){return"undefined"!=typeof WebGLTexture&&isType(t,"WebGLTexture")}function isSampler(e,t){return"undefined"!=typeof WebGLSampler&&isType(t,"WebGLSampler")}const STATIC_DRAW=35044,ARRAY_BUFFER$1=34962,ELEMENT_ARRAY_BUFFER$2=34963,BUFFER_SIZE=34660,BYTE$1=5120,UNSIGNED_BYTE$2=5121,SHORT$1=5122,UNSIGNED_SHORT$2=5123,INT$2=5124,UNSIGNED_INT$2=5125,FLOAT$2=5126,defaults$2={attribPrefix:""};function setAttributePrefix(e){defaults$2.attribPrefix=e}function setDefaults$2(e){copyExistingProperties(e,defaults$2)}function setBufferFromTypedArray(e,t,r,a,n){e.bindBuffer(t,r),e.bufferData(t,a,n||STATIC_DRAW)}function createBufferFromTypedArray(e,t,r,a){if(isBuffer(e,t))return t;r=r||ARRAY_BUFFER$1;const n=e.createBuffer();return setBufferFromTypedArray(e,r,n,t,a),n}function isIndices(e){return"indices"===e}function getNormalizationForTypedArrayType(e){return e===Int8Array||e===Uint8Array}function getArray(e){return e.length?e:e.data}const texcoordRE=/coord|texture/i,colorRE=/color|colour/i;function guessNumComponentsFromName(e,t){let r;if(r=texcoordRE.test(e)?2:colorRE.test(e)?4:3,t%r>0)throw new Error(`Can not guess numComponents for attribute '${e}'. Tried ${r} but ${t} values is not evenly divisible by ${r}. You should specify it.`);return r}function getNumComponents(e,t,r){return e.numComponents||e.size||guessNumComponentsFromName(t,r||getArray(e).length)}function makeTypedArray(e,t){if(isArrayBuffer$1(e))return e;if(isArrayBuffer$1(e.data))return e.data;Array.isArray(e)&&(e={data:e});let r=e.type?typedArrayTypeFromGLTypeOrTypedArrayCtor(e.type):void 0;return r||(r=isIndices(t)?Uint16Array:Float32Array),new r(e.data)}function glTypeFromGLTypeOrTypedArrayType(e){return"number"==typeof e?e:e?getGLTypeForTypedArrayType(e):FLOAT$2}function typedArrayTypeFromGLTypeOrTypedArrayCtor(e){return"number"==typeof e?getTypedArrayTypeForGLType(e):e||Float32Array}function attribBufferFromBuffer(e,t){return{buffer:t.buffer,numValues:24,type:glTypeFromGLTypeOrTypedArrayType(t.type),arrayType:typedArrayTypeFromGLTypeOrTypedArrayCtor(t.type)}}function attribBufferFromSize(e,t){const r=t.data||t,a=typedArrayTypeFromGLTypeOrTypedArrayCtor(t.type),n=r*a.BYTES_PER_ELEMENT,o=e.createBuffer();return e.bindBuffer(ARRAY_BUFFER$1,o),e.bufferData(ARRAY_BUFFER$1,n,t.drawType||STATIC_DRAW),{buffer:o,numValues:r,type:getGLTypeForTypedArrayType(a),arrayType:a}}function attribBufferFromArrayLike(e,t,r){const a=makeTypedArray(t,r);return{arrayType:a.constructor,buffer:createBufferFromTypedArray(e,a,void 0,t.drawType),type:getGLTypeForTypedArray(a),numValues:0}}function createAttribsFromArrays(e,t){const r={};return Object.keys(t).forEach(function(a){if(!isIndices(a)){const n=t[a],o=n.attrib||n.name||n.attribName||defaults$2.attribPrefix+a;if(n.value){if(!Array.isArray(n.value)&&!isArrayBuffer$1(n.value))throw new Error("array.value is not array or typedarray");r[o]={value:n.value}}else{let t;t=n.buffer&&n.buffer instanceof WebGLBuffer?attribBufferFromBuffer:"number"==typeof n||"number"==typeof n.data?attribBufferFromSize:attribBufferFromArrayLike;const{buffer:i,type:s,numValues:l,arrayType:c}=t(e,n,a),u=void 0!==n.normalize?n.normalize:getNormalizationForTypedArrayType(c),d=getNumComponents(n,a,l);r[o]={buffer:i,numComponents:d,type:s,normalize:u,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}}),e.bindBuffer(ARRAY_BUFFER$1,null),r}function setAttribInfoBufferFromArray(e,t,r,a){r=makeTypedArray(r),void 0!==a?(e.bindBuffer(ARRAY_BUFFER$1,t.buffer),e.bufferSubData(ARRAY_BUFFER$1,a,r)):setBufferFromTypedArray(e,ARRAY_BUFFER$1,t.buffer,r,t.drawType)}function getBytesPerValueForGLType(e,t){return t===BYTE$1||t===UNSIGNED_BYTE$2?1:t===SHORT$1||t===UNSIGNED_SHORT$2?2:t===INT$2||t===UNSIGNED_INT$2||t===FLOAT$2?4:0}const positionKeys=["position","positions","a_position"];function getNumElementsFromNonIndexedArrays(e){let t,r;for(r=0;r<positionKeys.length&&(t=positionKeys[r],!(t in e));++r);r===positionKeys.length&&(t=Object.keys(e)[0]);const a=e[t],n=getArray(a).length;if(void 0===n)return 1;const o=getNumComponents(a,t),i=n/o;if(n%o>0)throw new Error(`numComponents ${o} not correct for length ${n}`);return i}function getNumElementsFromAttributes(e,t){let r,a;for(a=0;a<positionKeys.length&&(r=positionKeys[a],!(r in t))&&(r=defaults$2.attribPrefix+r,!(r in t));++a);a===positionKeys.length&&(r=Object.keys(t)[0]);const n=t[r];if(!n.buffer)return 1;e.bindBuffer(ARRAY_BUFFER$1,n.buffer);const o=e.getBufferParameter(ARRAY_BUFFER$1,BUFFER_SIZE);e.bindBuffer(ARRAY_BUFFER$1,null);const i=o/getBytesPerValueForGLType(e,n.type),s=n.numComponents||n.size,l=i/s;if(l%1!=0)throw new Error(`numComponents ${s} not correct for length ${length}`);return l}function createBufferInfoFromArrays(e,t,r){const a=createAttribsFromArrays(e,t),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},a);const o=t.indices;if(o){const t=makeTypedArray(o,"indices");n.indices=createBufferFromTypedArray(e,t,ELEMENT_ARRAY_BUFFER$2),n.numElements=t.length,n.elementType=getGLTypeForTypedArray(t)}else n.numElements||(n.numElements=getNumElementsFromAttributes(e,n.attribs));return n}function createBufferFromArray(e,t,r){const a="indices"===r?ELEMENT_ARRAY_BUFFER$2:ARRAY_BUFFER$1;return createBufferFromTypedArray(e,makeTypedArray(t,r),a)}function createBuffersFromArrays(e,t){const r={};return Object.keys(t).forEach(function(a){r[a]=createBufferFromArray(e,t[a],a)}),t.indices?(r.numElements=t.indices.length,r.elementType=getGLTypeForTypedArray(makeTypedArray(t.indices))):r.numElements=getNumElementsFromNonIndexedArrays(t),r}var attributes=Object.freeze({__proto__:null,createAttribsFromArrays:createAttribsFromArrays,createBuffersFromArrays:createBuffersFromArrays,createBufferFromArray:createBufferFromArray,createBufferFromTypedArray:createBufferFromTypedArray,createBufferInfoFromArrays:createBufferInfoFromArrays,setAttribInfoBufferFromArray:setAttribInfoBufferFromArray,setAttributePrefix:setAttributePrefix,setAttributeDefaults_:setDefaults$2,getNumComponents_:getNumComponents,getArray_:getArray});function isWebGL2(e){return!!e.texStorage2D}function isWebGL1(e){return!e.texStorage2D}const glEnumToString=function(){const e={},t={};return function(r,a){return function(r){const a=r.constructor.name;if(!e[a]){for(const e in r)if("number"==typeof r[e]){const a=t[r[e]];t[r[e]]=a?`${a} | ${e}`:e}e[a]=!0}}(r),t[a]||("number"==typeof a?`0x${a.toString(16)}`:a)}}();var utils=Object.freeze({__proto__:null,glEnumToString:glEnumToString,isWebGL1:isWebGL1,isWebGL2:isWebGL2});const defaults$1={textureColor:new Uint8Array([128,192,255,255]),textureOptions:{},crossOrigin:void 0},isArrayBuffer=isArrayBuffer$1,getShared2DContext=function(){let e;return function(){return e=e||("undefined"!=typeof document&&document.createElement?document.createElement("canvas").getContext("2d"):null),e}}(),ALPHA=6406,RGB=6407,RGBA$1=6408,LUMINANCE=6409,LUMINANCE_ALPHA=6410,DEPTH_COMPONENT$1=6402,DEPTH_STENCIL$1=34041,CLAMP_TO_EDGE$1=33071,NEAREST=9728,LINEAR$1=9729,TEXTURE_2D$2=3553,TEXTURE_CUBE_MAP$1=34067,TEXTURE_3D$1=32879,TEXTURE_2D_ARRAY$1=35866,TEXTURE_CUBE_MAP_POSITIVE_X=34069,TEXTURE_CUBE_MAP_NEGATIVE_X=34070,TEXTURE_CUBE_MAP_POSITIVE_Y=34071,TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,TEXTURE_CUBE_MAP_POSITIVE_Z=34073,TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,TEXTURE_MIN_FILTER=10241,TEXTURE_MAG_FILTER=10240,TEXTURE_WRAP_S=10242,TEXTURE_WRAP_T=10243,TEXTURE_WRAP_R=32882,TEXTURE_MIN_LOD=33082,TEXTURE_MAX_LOD=33083,TEXTURE_BASE_LEVEL=33084,TEXTURE_MAX_LEVEL=33085,TEXTURE_COMPARE_MODE=34892,TEXTURE_COMPARE_FUNC=34893,UNPACK_ALIGNMENT=3317,UNPACK_ROW_LENGTH=3314,UNPACK_IMAGE_HEIGHT=32878,UNPACK_SKIP_PIXELS=3316,UNPACK_SKIP_ROWS=3315,UNPACK_SKIP_IMAGES=32877,UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,UNPACK_FLIP_Y_WEBGL=37440,R8=33321,R8_SNORM=36756,R16F=33325,R32F=33326,R8UI=33330,R8I=33329,RG16UI=33338,RG16I=33337,RG32UI=33340,RG32I=33339,RG8=33323,RG8_SNORM=36757,RG16F=33327,RG32F=33328,RG8UI=33336,RG8I=33335,R16UI=33332,R16I=33331,R32UI=33334,R32I=33333,RGB8=32849,SRGB8=35905,RGB565$1=36194,RGB8_SNORM=36758,R11F_G11F_B10F=35898,RGB9_E5=35901,RGB16F=34843,RGB32F=34837,RGB8UI=36221,RGB8I=36239,RGB16UI=36215,RGB16I=36233,RGB32UI=36209,RGB32I=36227,RGBA8=32856,SRGB8_ALPHA8=35907,RGBA8_SNORM=36759,RGB5_A1$1=32855,RGBA4$1=32854,RGB10_A2=32857,RGBA16F=34842,RGBA32F=34836,RGBA8UI=36220,RGBA8I=36238,RGB10_A2UI=36975,RGBA16UI=36214,RGBA16I=36232,RGBA32I=36226,RGBA32UI=36208,DEPTH_COMPONENT16$1=33189,DEPTH_COMPONENT24$1=33190,DEPTH_COMPONENT32F$1=36012,DEPTH32F_STENCIL8$1=36013,DEPTH24_STENCIL8$1=35056,BYTE=5120,UNSIGNED_BYTE$1=5121,SHORT=5122,UNSIGNED_SHORT$1=5123,INT$1=5124,UNSIGNED_INT$1=5125,FLOAT$1=5126,UNSIGNED_SHORT_4_4_4_4=32819,UNSIGNED_SHORT_5_5_5_1=32820,UNSIGNED_SHORT_5_6_5=33635,HALF_FLOAT=5131,HALF_FLOAT_OES=36193,UNSIGNED_INT_2_10_10_10_REV=33640,UNSIGNED_INT_10F_11F_11F_REV=35899,UNSIGNED_INT_5_9_9_9_REV=35902,FLOAT_32_UNSIGNED_INT_24_8_REV=36269,UNSIGNED_INT_24_8=34042,RG=33319,RG_INTEGER=33320,RED=6403,RED_INTEGER=36244,RGB_INTEGER=36248,RGBA_INTEGER=36249,formatInfo={};{const e=formatInfo;e[ALPHA]={numColorComponents:1},e[LUMINANCE]={numColorComponents:1},e[LUMINANCE_ALPHA]={numColorComponents:2},e[RGB]={numColorComponents:3},e[RGBA$1]={numColorComponents:4},e[RED]={numColorComponents:1},e[RED_INTEGER]={numColorComponents:1},e[RG]={numColorComponents:2},e[RG_INTEGER]={numColorComponents:2},e[RGB]={numColorComponents:3},e[RGB_INTEGER]={numColorComponents:3},e[RGBA$1]={numColorComponents:4},e[RGBA_INTEGER]={numColorComponents:4},e[DEPTH_COMPONENT$1]={numColorComponents:1},e[DEPTH_STENCIL$1]={numColorComponents:2}}let s_textureInternalFormatInfo;function getTextureInternalFormatInfo(e){if(!s_textureInternalFormatInfo){const e={};e[ALPHA]={textureFormat:ALPHA,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[LUMINANCE]={textureFormat:LUMINANCE,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[LUMINANCE_ALPHA]={textureFormat:LUMINANCE_ALPHA,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2,4,4,8],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[RGB]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,6,6,12,2],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1,UNSIGNED_SHORT_5_6_5]},e[RGBA$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,8,8,16,2,2],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1,UNSIGNED_SHORT_4_4_4_4,UNSIGNED_SHORT_5_5_5_1]},e[DEPTH_COMPONENT$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[UNSIGNED_INT$1,UNSIGNED_SHORT$1]},e[R8]={textureFormat:RED,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1],type:[UNSIGNED_BYTE$1]},e[R8_SNORM]={textureFormat:RED,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[1],type:[BYTE]},e[R16F]={textureFormat:RED,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4,2],type:[FLOAT$1,HALF_FLOAT]},e[R32F]={textureFormat:RED,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT$1]},e[R8UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[UNSIGNED_BYTE$1]},e[R8I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[BYTE]},e[R16UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[UNSIGNED_SHORT$1]},e[R16I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[SHORT]},e[R32UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT$1]},e[R32I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[INT$1]},e[RG8]={textureFormat:RG,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2],type:[UNSIGNED_BYTE$1]},e[RG8_SNORM]={textureFormat:RG,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[2],type:[BYTE]},e[RG16F]={textureFormat:RG,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[8,4],type:[FLOAT$1,HALF_FLOAT]},e[RG32F]={textureFormat:RG,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[8],type:[FLOAT$1]},e[RG8UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[UNSIGNED_BYTE$1]},e[RG8I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[BYTE]},e[RG16UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_SHORT$1]},e[RG16I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[SHORT]},e[RG32UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[UNSIGNED_INT$1]},e[RG32I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[INT$1]},e[RGB8]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[SRGB8]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[RGB565$1]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,2],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_5_6_5]},e[RGB8_SNORM]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[BYTE]},e[R11F_G11F_B10F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[FLOAT$1,HALF_FLOAT,UNSIGNED_INT_10F_11F_11F_REV]},e[RGB9_E5]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[FLOAT$1,HALF_FLOAT,UNSIGNED_INT_5_9_9_9_REV]},e[RGB16F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6],type:[FLOAT$1,HALF_FLOAT]},e[RGB32F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[FLOAT$1]},e[RGB8UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[RGB8I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[BYTE]},e[RGB16UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[UNSIGNED_SHORT$1]},e[RGB16I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[SHORT]},e[RGB32UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[UNSIGNED_INT$1]},e[RGB32I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[INT$1]},e[RGBA8]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[SRGB8_ALPHA8]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[RGBA8_SNORM]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4],type:[BYTE]},e[RGB5_A1$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2,4],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_5_5_5_1,UNSIGNED_INT_2_10_10_10_REV]},e[RGBA4$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_4_4_4_4]},e[RGB10_A2]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_INT_2_10_10_10_REV]},e[RGBA16F]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[16,8],type:[FLOAT$1,HALF_FLOAT]},e[RGBA32F]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[16],type:[FLOAT$1]},e[RGBA8UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[RGBA8I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[BYTE]},e[RGB10_A2UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT_2_10_10_10_REV]},e[RGBA16UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[UNSIGNED_SHORT$1]},e[RGBA16I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[SHORT]},e[RGBA32I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[INT$1]},e[RGBA32UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[UNSIGNED_INT$1]},e[DEPTH_COMPONENT16$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[UNSIGNED_SHORT$1,UNSIGNED_INT$1]},e[DEPTH_COMPONENT24$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT$1]},e[DEPTH_COMPONENT32F$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT$1]},e[DEPTH24_STENCIL8$1]={textureFormat:DEPTH_STENCIL$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT_24_8]},e[DEPTH32F_STENCIL8$1]={textureFormat:DEPTH_STENCIL$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT_32_UNSIGNED_INT_24_8_REV]},Object.keys(e).forEach(function(t){const r=e[t];r.bytesPerElementMap={},r.bytesPerElement.forEach(function(e,t){const a=r.type[t];r.bytesPerElementMap[a]=e})}),s_textureInternalFormatInfo=e}return s_textureInternalFormatInfo[e]}function getBytesPerElementForInternalFormat(e,t){const r=getTextureInternalFormatInfo(e);if(!r)throw"unknown internal format";const a=r.bytesPerElementMap[t];if(void 0===a)throw"unknown internal format";return a}function getFormatAndTypeForInternalFormat(e){const t=getTextureInternalFormatInfo(e);if(!t)throw"unknown internal format";return{format:t.textureFormat,type:t.type[0]}}function isPowerOf2(e){return!(e&e-1)}function canGenerateMipmap(e,t,r,a){if(!isWebGL2(e))return isPowerOf2(t)&&isPowerOf2(r);const n=getTextureInternalFormatInfo(a);if(!n)throw"unknown internal format";return n.colorRenderable&&n.textureFilterable}function canFilter(e){const t=getTextureInternalFormatInfo(e);if(!t)throw"unknown internal format";return t.textureFilterable}function getNumComponentsForFormat(e){const t=formatInfo[e];if(!t)throw"unknown format: "+e;return t.numColorComponents}function getTextureTypeForArrayType(e,t,r){return isArrayBuffer(t)?getGLTypeForTypedArray(t):r||UNSIGNED_BYTE$1}function guessDimensions(e,t,r,a,n){if(n%1!=0)throw"can't guess dimensions";if(r||a){if(a){if(!r&&(r=n/a)%1)throw"can't guess dimensions"}else if((a=n/r)%1)throw"can't guess dimensions"}else{const e=Math.sqrt(n/(t===TEXTURE_CUBE_MAP$1?6:1));e%1==0?(r=e,a=e):(r=n,a=1)}return{width:r,height:a}}function setDefaultTextureColor(e){defaults$1.textureColor=new Uint8Array([255*e[0],255*e[1],255*e[2],255*e[3]])}function setDefaults$1(e){copyExistingProperties(e,defaults$1),e.textureColor&&setDefaultTextureColor(e.textureColor)}function setPackState(e,t){void 0!==t.colorspaceConversion&&e.pixelStorei(UNPACK_COLORSPACE_CONVERSION_WEBGL,t.colorspaceConversion),void 0!==t.premultiplyAlpha&&e.pixelStorei(UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),void 0!==t.flipY&&e.pixelStorei(UNPACK_FLIP_Y_WEBGL,t.flipY)}function setSkipStateToDefault(e){e.pixelStorei(UNPACK_ALIGNMENT,4),isWebGL2(e)&&(e.pixelStorei(UNPACK_ROW_LENGTH,0),e.pixelStorei(UNPACK_IMAGE_HEIGHT,0),e.pixelStorei(UNPACK_SKIP_PIXELS,0),e.pixelStorei(UNPACK_SKIP_ROWS,0),e.pixelStorei(UNPACK_SKIP_IMAGES,0))}function setTextureSamplerParameters(e,t,r,a){a.minMag&&(r.call(e,t,TEXTURE_MIN_FILTER,a.minMag),r.call(e,t,TEXTURE_MAG_FILTER,a.minMag)),a.min&&r.call(e,t,TEXTURE_MIN_FILTER,a.min),a.mag&&r.call(e,t,TEXTURE_MAG_FILTER,a.mag),a.wrap&&(r.call(e,t,TEXTURE_WRAP_S,a.wrap),r.call(e,t,TEXTURE_WRAP_T,a.wrap),(t===TEXTURE_3D$1||isSampler(e,t))&&r.call(e,t,TEXTURE_WRAP_R,a.wrap)),a.wrapR&&r.call(e,t,TEXTURE_WRAP_R,a.wrapR),a.wrapS&&r.call(e,t,TEXTURE_WRAP_S,a.wrapS),a.wrapT&&r.call(e,t,TEXTURE_WRAP_T,a.wrapT),void 0!==a.minLod&&r.call(e,t,TEXTURE_MIN_LOD,a.minLod),void 0!==a.maxLod&&r.call(e,t,TEXTURE_MAX_LOD,a.maxLod),void 0!==a.baseLevel&&r.call(e,t,TEXTURE_BASE_LEVEL,a.baseLevel),void 0!==a.maxLevel&&r.call(e,t,TEXTURE_MAX_LEVEL,a.maxLevel),void 0!==a.compareFunc&&r.call(e,t,TEXTURE_COMPARE_FUNC,a.compareFunc),void 0!==a.compareMode&&r.call(e,t,TEXTURE_COMPARE_MODE,a.compareMode)}function setTextureParameters(e,t,r){const a=r.target||TEXTURE_2D$2;e.bindTexture(a,t),setTextureSamplerParameters(e,a,e.texParameteri,r)}function setSamplerParameters(e,t,r){setTextureSamplerParameters(e,t,e.samplerParameteri,r)}function createSampler(e,t){const r=e.createSampler();return setSamplerParameters(e,r,t),r}function createSamplers(e,t){const r={};return Object.keys(t).forEach(function(a){r[a]=createSampler(e,t[a])}),r}function make1Pixel(e){return e=e||defaults$1.textureColor,isArrayBuffer(e)?e:new Uint8Array([255*e[0],255*e[1],255*e[2],255*e[3]])}function setTextureFilteringForSize(e,t,r,a,n,o){r=r||defaults$1.textureOptions,o=o||RGBA$1;const i=r.target||TEXTURE_2D$2;if(a=a||r.width,n=n||r.height,e.bindTexture(i,t),canGenerateMipmap(e,a,n,o))e.generateMipmap(i);else{const t=canFilter(o)?LINEAR$1:NEAREST;e.texParameteri(i,TEXTURE_MIN_FILTER,t),e.texParameteri(i,TEXTURE_MAG_FILTER,t),e.texParameteri(i,TEXTURE_WRAP_S,CLAMP_TO_EDGE$1),e.texParameteri(i,TEXTURE_WRAP_T,CLAMP_TO_EDGE$1)}}function shouldAutomaticallySetTextureFilteringForSize(e){return!0===e.auto||void 0===e.auto&&void 0===e.level}function getCubeFaceOrder(e,t){return(t=t||{}).cubeFaceOrder||[TEXTURE_CUBE_MAP_POSITIVE_X,TEXTURE_CUBE_MAP_NEGATIVE_X,TEXTURE_CUBE_MAP_POSITIVE_Y,TEXTURE_CUBE_MAP_NEGATIVE_Y,TEXTURE_CUBE_MAP_POSITIVE_Z,TEXTURE_CUBE_MAP_NEGATIVE_Z]}function getCubeFacesWithNdx(e,t){const r=getCubeFaceOrder(e,t).map(function(e,t){return{face:e,ndx:t}});return r.sort(function(e,t){return e.face-t.face}),r}function setTextureFromElement(e,t,r,a){const n=(a=a||defaults$1.textureOptions).target||TEXTURE_2D$2,o=a.level||0;let i=r.width,s=r.height;const l=a.internalFormat||a.format||RGBA$1,c=getFormatAndTypeForInternalFormat(l),u=a.format||c.format,d=a.type||c.type;if(setPackState(e,a),e.bindTexture(n,t),n===TEXTURE_CUBE_MAP$1){const c=r.width,p=r.height;let f,m;if(c/6===p)f=p,m=[0,0,1,0,2,0,3,0,4,0,5,0];else if(p/6===c)f=c,m=[0,0,0,1,0,2,0,3,0,4,0,5];else if(c/3==p/2)f=c/3,m=[0,0,1,0,2,0,0,1,1,1,2,1];else{if(c/2!=p/3)throw"can't figure out cube map from element: "+(r.src?r.src:r.nodeName);f=c/2,m=[0,0,1,0,0,1,1,1,0,2,1,2]}const y=getShared2DContext();y?(y.canvas.width=f,y.canvas.height=f,i=f,s=f,getCubeFacesWithNdx(e,a).forEach(function(t){const a=m[2*t.ndx+0]*f,n=m[2*t.ndx+1]*f;y.drawImage(r,a,n,f,f,0,0,f,f),e.texImage2D(t.face,o,l,u,d,y.canvas)}),y.canvas.width=1,y.canvas.height=1):"undefined"!=typeof createImageBitmap&&(i=f,s=f,getCubeFacesWithNdx(e,a).forEach(function(c){const p=m[2*c.ndx+0]*f,y=m[2*c.ndx+1]*f;e.texImage2D(c.face,o,l,f,f,0,u,d,null),createImageBitmap(r,p,y,f,f,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(function(r){setPackState(e,a),e.bindTexture(n,t),e.texImage2D(c.face,o,l,u,d,r),shouldAutomaticallySetTextureFilteringForSize(a)&&setTextureFilteringForSize(e,t,a,i,s,l)})}))}else if(n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1){const t=Math.min(r.width,r.height),a=Math.max(r.width,r.height),i=a/t;if(i%1!=0)throw"can not compute 3D dimensions of element";const s=r.width===a?1:0,c=r.height===a?1:0;e.pixelStorei(UNPACK_ALIGNMENT,1),e.pixelStorei(UNPACK_ROW_LENGTH,r.width),e.pixelStorei(UNPACK_IMAGE_HEIGHT,0),e.pixelStorei(UNPACK_SKIP_IMAGES,0),e.texImage3D(n,o,l,t,t,t,0,u,d,null);for(let a=0;a<i;++a){const i=a*t*s,l=a*t*c;e.pixelStorei(UNPACK_SKIP_PIXELS,i),e.pixelStorei(UNPACK_SKIP_ROWS,l),e.texSubImage3D(n,o,0,0,a,t,t,1,u,d,r)}setSkipStateToDefault(e)}else e.texImage2D(n,o,l,u,d,r);shouldAutomaticallySetTextureFilteringForSize(a)&&setTextureFilteringForSize(e,t,a,i,s,l),setTextureParameters(e,t,a)}function noop(){}function urlIsSameOrigin(e){if("undefined"!=typeof document){const t=document.createElement("a");return t.href=e,t.hostname===location.hostname&&t.port===location.port&&t.protocol===location.protocol}{const t=new URL(location.href).origin;return new URL(e,location.href).origin===t}}function setToAnonymousIfUndefinedAndURLIsNotSameOrigin(e,t){return void 0!==t||urlIsSameOrigin(e)?t:"anonymous"}function loadImage$1(e,t,r){let a;if(r=r||noop,t=void 0!==t?t:defaults$1.crossOrigin,t=setToAnonymousIfUndefinedAndURLIsNotSameOrigin(e,t),"undefined"!=typeof Image){a=new Image,void 0!==t&&(a.crossOrigin=t);const n=function(){a.removeEventListener("error",o),a.removeEventListener("load",i),a=null},o=function(){const t="couldn't load image: "+e;error$1(t),r(t,a),n()},i=function(){r(null,a),n()};return a.addEventListener("error",o),a.addEventListener("load",i),a.src=e,a}if("undefined"!=typeof ImageBitmap){let n,o;const i=function(){r(n,o)},s={};t&&(s.mode="cors"),fetch(e,s).then(function(e){if(!e.ok)throw e;return e.blob()}).then(function(e){return createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"})}).then(function(e){o=e,setTimeout(i)}).catch(function(e){n=e,setTimeout(i)}),a=null}return a}function isTexImageSource(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof HTMLElement&&e instanceof HTMLElement}function loadAndUseImage(e,t,r){return isTexImageSource(e)?(setTimeout(function(){r(null,e)}),e):loadImage$1(e,t,r)}function setTextureTo1PixelColor(e,t,r){const a=(r=r||defaults$1.textureOptions).target||TEXTURE_2D$2;if(e.bindTexture(a,t),!1===r.color)return;const n=make1Pixel(r.color);if(a===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,0,RGBA$1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n);else a===TEXTURE_3D$1||a===TEXTURE_2D_ARRAY$1?e.texImage3D(a,0,RGBA$1,1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n):e.texImage2D(a,0,RGBA$1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n)}function loadTextureFromUrl(e,t,r,a){a=a||noop,r=r||defaults$1.textureOptions,setTextureTo1PixelColor(e,t,r);return loadAndUseImage((r=Object.assign({},r)).src,r.crossOrigin,function(n,o){n?a(n,t,o):(setTextureFromElement(e,t,o,r),a(null,t,o))})}function loadCubemapFromUrls(e,t,r,a){a=a||noop;const n=r.src;if(6!==n.length)throw"there must be 6 urls for a cubemap";const o=r.level||0,i=r.internalFormat||r.format||RGBA$1,s=getFormatAndTypeForInternalFormat(i),l=r.format||s.format,c=r.type||UNSIGNED_BYTE$1,u=r.target||TEXTURE_2D$2;if(u!==TEXTURE_CUBE_MAP$1)throw"target must be TEXTURE_CUBE_MAP";setTextureTo1PixelColor(e,t,r),r=Object.assign({},r);let d=6;const p=[],f=getCubeFaceOrder(e,r);let m;m=n.map(function(n,s){return loadAndUseImage(n,r.crossOrigin,(y=f[s],function(n,s){--d,n?p.push(n):s.width!==s.height?p.push("cubemap face img is not a square: "+s.src):(setPackState(e,r),e.bindTexture(u,t),5===d?getCubeFaceOrder().forEach(function(t){e.texImage2D(t,o,i,l,c,s)}):e.texImage2D(y,o,i,l,c,s),shouldAutomaticallySetTextureFilteringForSize(r)&&e.generateMipmap(u)),0===d&&a(p.length?p:void 0,t,m)}));var y})}function loadSlicesFromUrls(e,t,r,a){a=a||noop;const n=r.src,o=r.internalFormat||r.format||RGBA$1,i=getFormatAndTypeForInternalFormat(o),s=r.format||i.format,l=r.type||UNSIGNED_BYTE$1,c=r.target||TEXTURE_2D_ARRAY$1;if(c!==TEXTURE_3D$1&&c!==TEXTURE_2D_ARRAY$1)throw"target must be TEXTURE_3D or TEXTURE_2D_ARRAY";setTextureTo1PixelColor(e,t,r),r=Object.assign({},r);let u=n.length;const d=[];let p;const f=r.level||0;let m=r.width,y=r.height;const g=n.length;let x=!0;p=n.map(function(n,i){return loadAndUseImage(n,r.crossOrigin,(A=i,function(n,i){if(--u,n)d.push(n);else{if(setPackState(e,r),e.bindTexture(c,t),x){x=!1,m=r.width||i.width,y=r.height||i.height,e.texImage3D(c,f,o,m,y,g,0,s,l,null);for(let t=0;t<g;++t)e.texSubImage3D(c,f,0,0,t,m,y,1,s,l,i)}else{let t,r=i;i.width===m&&i.height===y||(t=getShared2DContext(),r=t.canvas,t.canvas.width=m,t.canvas.height=y,t.drawImage(i,0,0,m,y)),e.texSubImage3D(c,f,0,0,A,m,y,1,s,l,r),t&&r===t.canvas&&(t.canvas.width=0,t.canvas.height=0)}shouldAutomaticallySetTextureFilteringForSize(r)&&e.generateMipmap(c)}0===u&&a(d.length?d:void 0,t,p)}));var A})}function setTextureFromArray(e,t,r,a){const n=(a=a||defaults$1.textureOptions).target||TEXTURE_2D$2;e.bindTexture(n,t);let o=a.width,i=a.height,s=a.depth;const l=a.level||0,c=a.internalFormat||a.format||RGBA$1,u=getFormatAndTypeForInternalFormat(c),d=a.format||u.format,p=a.type||getTextureTypeForArrayType(e,r,u.type);if(isArrayBuffer(r))r instanceof Uint8ClampedArray&&(r=new Uint8Array(r.buffer));else{const e=getTypedArrayTypeForGLType(p);r=new e(r)}const f=getBytesPerElementForInternalFormat(c,p),m=r.byteLength/f;if(m%1)throw"length wrong size for format: "+glEnumToString(e,d);let y;if(n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1)if(o||i||s)!o||i&&s?!i||o&&s?(y=guessDimensions(e,n,o,i,m/s),o=y.width,i=y.height):(y=guessDimensions(e,n,o,s,m/i),o=y.width,s=y.height):(y=guessDimensions(e,n,i,s,m/o),i=y.width,s=y.height);else{const e=Math.cbrt(m);if(e%1!=0)throw"can't guess cube size of array of numElements: "+m;o=e,i=e,s=e}else y=guessDimensions(e,n,o,i,m),o=y.width,i=y.height;if(setSkipStateToDefault(e),e.pixelStorei(UNPACK_ALIGNMENT,a.unpackAlignment||1),setPackState(e,a),n===TEXTURE_CUBE_MAP$1){const t=m/6*(f/r.BYTES_PER_ELEMENT);getCubeFacesWithNdx(e,a).forEach(a=>{const n=t*a.ndx,s=r.subarray(n,n+t);e.texImage2D(a.face,l,c,o,i,0,d,p,s)})}else n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1?e.texImage3D(n,l,c,o,i,s,0,d,p,r):e.texImage2D(n,l,c,o,i,0,d,p,r);return{width:o,height:i,depth:s,type:p}}function setEmptyTexture(e,t,r){const a=r.target||TEXTURE_2D$2;e.bindTexture(a,t);const n=r.level||0,o=r.internalFormat||r.format||RGBA$1,i=getFormatAndTypeForInternalFormat(o),s=r.format||i.format,l=r.type||i.type;if(setPackState(e,r),a===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,n,o,r.width,r.height,0,s,l,null);else a===TEXTURE_3D$1||a===TEXTURE_2D_ARRAY$1?e.texImage3D(a,n,o,r.width,r.height,r.depth,0,s,l,null):e.texImage2D(a,n,o,r.width,r.height,0,s,l,null)}function createTexture(e,t,r){r=r||noop,t=t||defaults$1.textureOptions;const a=e.createTexture(),n=t.target||TEXTURE_2D$2;let o=t.width||1,i=t.height||1;const s=t.internalFormat||RGBA$1;e.bindTexture(n,a),n===TEXTURE_CUBE_MAP$1&&(e.texParameteri(n,TEXTURE_WRAP_S,CLAMP_TO_EDGE$1),e.texParameteri(n,TEXTURE_WRAP_T,CLAMP_TO_EDGE$1));let l=t.src;if(l)if("function"==typeof l&&(l=l(e,t)),"string"==typeof l)loadTextureFromUrl(e,a,t,r);else if(isArrayBuffer(l)||Array.isArray(l)&&("number"==typeof l[0]||Array.isArray(l[0])||isArrayBuffer(l[0]))){const r=setTextureFromArray(e,a,l,t);o=r.width,i=r.height}else Array.isArray(l)&&("string"==typeof l[0]||isTexImageSource(l[0]))?n===TEXTURE_CUBE_MAP$1?loadCubemapFromUrls(e,a,t,r):loadSlicesFromUrls(e,a,t,r):(setTextureFromElement(e,a,l,t),o=l.width,i=l.height);else setEmptyTexture(e,a,t);return shouldAutomaticallySetTextureFilteringForSize(t)&&setTextureFilteringForSize(e,a,t,o,i,s),setTextureParameters(e,a,t),a}function resizeTexture(e,t,r,a,n,o){a=a||r.width,n=n||r.height,o=o||r.depth;const i=r.target||TEXTURE_2D$2;e.bindTexture(i,t);const s=r.level||0,l=r.internalFormat||r.format||RGBA$1,c=getFormatAndTypeForInternalFormat(l),u=r.format||c.format;let d;const p=r.src;if(d=p&&(isArrayBuffer(p)||Array.isArray(p)&&"number"==typeof p[0])?r.type||getTextureTypeForArrayType(e,p,c.type):r.type||c.type,i===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,s,l,a,n,0,u,d,null);else i===TEXTURE_3D$1||i===TEXTURE_2D_ARRAY$1?e.texImage3D(i,s,l,a,n,o,0,u,d,null):e.texImage2D(i,s,l,a,n,0,u,d,null)}function isAsyncSrc(e){return"string"==typeof e||Array.isArray(e)&&"string"==typeof e[0]}function createTextures(e,t,r){r=r||noop;let a=0;const n=[],o={},i={};function s(){0===a&&setTimeout(function(){r(n.length?n:void 0,o,i)},0)}return Object.keys(t).forEach(function(r){const l=t[r];let c;isAsyncSrc(l.src)&&(c=function(e,t,o){i[r]=o,--a,e&&n.push(e),s()},++a),o[r]=createTexture(e,l,c)}),s(),o}var textures=Object.freeze({__proto__:null,setTextureDefaults_:setDefaults$1,createSampler:createSampler,createSamplers:createSamplers,setSamplerParameters:setSamplerParameters,createTexture:createTexture,setEmptyTexture:setEmptyTexture,setTextureFromArray:setTextureFromArray,loadTextureFromUrl:loadTextureFromUrl,setTextureFromElement:setTextureFromElement,setTextureFilteringForSize:setTextureFilteringForSize,setTextureParameters:setTextureParameters,setDefaultTextureColor:setDefaultTextureColor,createTextures:createTextures,resizeTexture:resizeTexture,canGenerateMipmap:canGenerateMipmap,canFilter:canFilter,getNumComponentsForFormat:getNumComponentsForFormat,getBytesPerElementForInternalFormat:getBytesPerElementForInternalFormat,getFormatAndTypeForInternalFormat:getFormatAndTypeForInternalFormat});const error=error$1,warn=warn$1;function getElementById(e){return"undefined"!=typeof document&&document.getElementById?document.getElementById(e):null}const TEXTURE0=33984,DYNAMIC_DRAW=35048,ARRAY_BUFFER=34962,ELEMENT_ARRAY_BUFFER$1=34963,UNIFORM_BUFFER=35345,TRANSFORM_FEEDBACK_BUFFER=35982,TRANSFORM_FEEDBACK=36386,COMPILE_STATUS=35713,LINK_STATUS=35714,FRAGMENT_SHADER=35632,VERTEX_SHADER=35633,SEPARATE_ATTRIBS=35981,ACTIVE_UNIFORMS=35718,ACTIVE_ATTRIBUTES=35721,TRANSFORM_FEEDBACK_VARYINGS=35971,ACTIVE_UNIFORM_BLOCKS=35382,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398,UNIFORM_BLOCK_DATA_SIZE=35392,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395,FLOAT=5126,FLOAT_VEC2=35664,FLOAT_VEC3=35665,FLOAT_VEC4=35666,INT=5124,INT_VEC2=35667,INT_VEC3=35668,INT_VEC4=35669,BOOL=35670,BOOL_VEC2=35671,BOOL_VEC3=35672,BOOL_VEC4=35673,FLOAT_MAT2=35674,FLOAT_MAT3=35675,FLOAT_MAT4=35676,SAMPLER_2D=35678,SAMPLER_CUBE=35680,SAMPLER_3D=35679,SAMPLER_2D_SHADOW=35682,FLOAT_MAT2x3=35685,FLOAT_MAT2x4=35686,FLOAT_MAT3x2=35687,FLOAT_MAT3x4=35688,FLOAT_MAT4x2=35689,FLOAT_MAT4x3=35690,SAMPLER_2D_ARRAY=36289,SAMPLER_2D_ARRAY_SHADOW=36292,SAMPLER_CUBE_SHADOW=36293,UNSIGNED_INT=5125,UNSIGNED_INT_VEC2=36294,UNSIGNED_INT_VEC3=36295,UNSIGNED_INT_VEC4=36296,INT_SAMPLER_2D=36298,INT_SAMPLER_3D=36299,INT_SAMPLER_CUBE=36300,INT_SAMPLER_2D_ARRAY=36303,UNSIGNED_INT_SAMPLER_2D=36306,UNSIGNED_INT_SAMPLER_3D=36307,UNSIGNED_INT_SAMPLER_CUBE=36308,UNSIGNED_INT_SAMPLER_2D_ARRAY=36311,TEXTURE_2D$1=3553,TEXTURE_CUBE_MAP=34067,TEXTURE_3D=32879,TEXTURE_2D_ARRAY=35866,typeMap={};function getBindPointForSamplerType(e,t){return typeMap[t].bindPoint}function floatSetter(e,t){return function(r){e.uniform1f(t,r)}}function floatArraySetter(e,t){return function(r){e.uniform1fv(t,r)}}function floatVec2Setter(e,t){return function(r){e.uniform2fv(t,r)}}function floatVec3Setter(e,t){return function(r){e.uniform3fv(t,r)}}function floatVec4Setter(e,t){return function(r){e.uniform4fv(t,r)}}function intSetter(e,t){return function(r){e.uniform1i(t,r)}}function intArraySetter(e,t){return function(r){e.uniform1iv(t,r)}}function intVec2Setter(e,t){return function(r){e.uniform2iv(t,r)}}function intVec3Setter(e,t){return function(r){e.uniform3iv(t,r)}}function intVec4Setter(e,t){return function(r){e.uniform4iv(t,r)}}function uintSetter(e,t){return function(r){e.uniform1ui(t,r)}}function uintArraySetter(e,t){return function(r){e.uniform1uiv(t,r)}}function uintVec2Setter(e,t){return function(r){e.uniform2uiv(t,r)}}function uintVec3Setter(e,t){return function(r){e.uniform3uiv(t,r)}}function uintVec4Setter(e,t){return function(r){e.uniform4uiv(t,r)}}function floatMat2Setter(e,t){return function(r){e.uniformMatrix2fv(t,!1,r)}}function floatMat3Setter(e,t){return function(r){e.uniformMatrix3fv(t,!1,r)}}function floatMat4Setter(e,t){return function(r){e.uniformMatrix4fv(t,!1,r)}}function floatMat23Setter(e,t){return function(r){e.uniformMatrix2x3fv(t,!1,r)}}function floatMat32Setter(e,t){return function(r){e.uniformMatrix3x2fv(t,!1,r)}}function floatMat24Setter(e,t){return function(r){e.uniformMatrix2x4fv(t,!1,r)}}function floatMat42Setter(e,t){return function(r){e.uniformMatrix4x2fv(t,!1,r)}}function floatMat34Setter(e,t){return function(r){e.uniformMatrix3x4fv(t,!1,r)}}function floatMat43Setter(e,t){return function(r){e.uniformMatrix4x3fv(t,!1,r)}}function samplerSetter(e,t,r,a){const n=getBindPointForSamplerType(e,t);return isWebGL2(e)?function(t){let o,i;!t||isTexture(e,t)?(o=t,i=null):(o=t.texture,i=t.sampler),e.uniform1i(a,r),e.activeTexture(TEXTURE0+r),e.bindTexture(n,o),e.bindSampler(r,i)}:function(t){e.uniform1i(a,r),e.activeTexture(TEXTURE0+r),e.bindTexture(n,t)}}function samplerArraySetter(e,t,r,a,n){const o=getBindPointForSamplerType(e,t),i=new Int32Array(n);for(let e=0;e<n;++e)i[e]=r+e;return isWebGL2(e)?function(t){e.uniform1iv(a,i),t.forEach(function(t,a){let n,s;e.activeTexture(TEXTURE0+i[a]),!t||isTexture(e,t)?(n=t,s=null):(n=t.texture,s=t.sampler),e.bindSampler(r,s),e.bindTexture(o,n)})}:function(t){e.uniform1iv(a,i),t.forEach(function(t,r){e.activeTexture(TEXTURE0+i[r]),e.bindTexture(o,t)})}}function floatAttribSetter(e,t){return function(r){if(r.value)switch(e.disableVertexAttribArray(t),r.value.length){case 4:e.vertexAttrib4fv(t,r.value);break;case 3:e.vertexAttrib3fv(t,r.value);break;case 2:e.vertexAttrib2fv(t,r.value);break;case 1:e.vertexAttrib1fv(t,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,r.numComponents||r.size,r.type||FLOAT,r.normalize||!1,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function intAttribSetter(e,t){return function(r){if(r.value){if(e.disableVertexAttribArray(t),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");e.vertexAttrib4iv(t,r.value)}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribIPointer(t,r.numComponents||r.size,r.type||INT,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function uintAttribSetter(e,t){return function(r){if(r.value){if(e.disableVertexAttribArray(t),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");e.vertexAttrib4uiv(t,r.value)}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribIPointer(t,r.numComponents||r.size,r.type||UNSIGNED_INT,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function matAttribSetter(e,t,r){const a=r.size,n=r.count;return function(r){e.bindBuffer(ARRAY_BUFFER,r.buffer);const o=r.size||r.numComponents||a,i=o/n,s=r.type||FLOAT,l=typeMap[s].size*o,c=r.normalize||!1,u=r.offset||0,d=l/n;for(let a=0;a<n;++a)e.enableVertexAttribArray(t+a),e.vertexAttribPointer(t+a,i,s,c,l,u+d*a),e.vertexAttribDivisor&&e.vertexAttribDivisor(t+a,r.divisor||0)}}typeMap[FLOAT]={Type:Float32Array,size:4,setter:floatSetter,arraySetter:floatArraySetter},typeMap[FLOAT_VEC2]={Type:Float32Array,size:8,setter:floatVec2Setter,cols:2},typeMap[FLOAT_VEC3]={Type:Float32Array,size:12,setter:floatVec3Setter,cols:3},typeMap[FLOAT_VEC4]={Type:Float32Array,size:16,setter:floatVec4Setter,cols:4},typeMap[INT]={Type:Int32Array,size:4,setter:intSetter,arraySetter:intArraySetter},typeMap[INT_VEC2]={Type:Int32Array,size:8,setter:intVec2Setter,cols:2},typeMap[INT_VEC3]={Type:Int32Array,size:12,setter:intVec3Setter,cols:3},typeMap[INT_VEC4]={Type:Int32Array,size:16,setter:intVec4Setter,cols:4},typeMap[UNSIGNED_INT]={Type:Uint32Array,size:4,setter:uintSetter,arraySetter:uintArraySetter},typeMap[UNSIGNED_INT_VEC2]={Type:Uint32Array,size:8,setter:uintVec2Setter,cols:2},typeMap[UNSIGNED_INT_VEC3]={Type:Uint32Array,size:12,setter:uintVec3Setter,cols:3},typeMap[UNSIGNED_INT_VEC4]={Type:Uint32Array,size:16,setter:uintVec4Setter,cols:4},typeMap[BOOL]={Type:Uint32Array,size:4,setter:intSetter,arraySetter:intArraySetter},typeMap[BOOL_VEC2]={Type:Uint32Array,size:8,setter:intVec2Setter,cols:2},typeMap[BOOL_VEC3]={Type:Uint32Array,size:12,setter:intVec3Setter,cols:3},typeMap[BOOL_VEC4]={Type:Uint32Array,size:16,setter:intVec4Setter,cols:4},typeMap[FLOAT_MAT2]={Type:Float32Array,size:32,setter:floatMat2Setter,rows:2,cols:2},typeMap[FLOAT_MAT3]={Type:Float32Array,size:48,setter:floatMat3Setter,rows:3,cols:3},typeMap[FLOAT_MAT4]={Type:Float32Array,size:64,setter:floatMat4Setter,rows:4,cols:4},typeMap[FLOAT_MAT2x3]={Type:Float32Array,size:32,setter:floatMat23Setter,rows:2,cols:3},typeMap[FLOAT_MAT2x4]={Type:Float32Array,size:32,setter:floatMat24Setter,rows:2,cols:4},typeMap[FLOAT_MAT3x2]={Type:Float32Array,size:48,setter:floatMat32Setter,rows:3,cols:2},typeMap[FLOAT_MAT3x4]={Type:Float32Array,size:48,setter:floatMat34Setter,rows:3,cols:4},typeMap[FLOAT_MAT4x2]={Type:Float32Array,size:64,setter:floatMat42Setter,rows:4,cols:2},typeMap[FLOAT_MAT4x3]={Type:Float32Array,size:64,setter:floatMat43Setter,rows:4,cols:3},typeMap[SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[SAMPLER_2D_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[SAMPLER_2D_ARRAY_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[SAMPLER_CUBE_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[INT_SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[INT_SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[INT_SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[UNSIGNED_INT_SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[UNSIGNED_INT_SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[UNSIGNED_INT_SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[UNSIGNED_INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY};const attrTypeMap={};attrTypeMap[FLOAT]={size:4,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC2]={size:8,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC3]={size:12,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC4]={size:16,setter:floatAttribSetter},attrTypeMap[INT]={size:4,setter:intAttribSetter},attrTypeMap[INT_VEC2]={size:8,setter:intAttribSetter},attrTypeMap[INT_VEC3]={size:12,setter:intAttribSetter},attrTypeMap[INT_VEC4]={size:16,setter:intAttribSetter},attrTypeMap[UNSIGNED_INT]={size:4,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC2]={size:8,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC3]={size:12,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC4]={size:16,setter:uintAttribSetter},attrTypeMap[BOOL]={size:4,setter:intAttribSetter},attrTypeMap[BOOL_VEC2]={size:8,setter:intAttribSetter},attrTypeMap[BOOL_VEC3]={size:12,setter:intAttribSetter},attrTypeMap[BOOL_VEC4]={size:16,setter:intAttribSetter},attrTypeMap[FLOAT_MAT2]={size:4,setter:matAttribSetter,count:2},attrTypeMap[FLOAT_MAT3]={size:9,setter:matAttribSetter,count:3},attrTypeMap[FLOAT_MAT4]={size:16,setter:matAttribSetter,count:4};const errorRE=/ERROR:\s*\d+:(\d+)/gi;function addLineNumbersWithError(e,t="",r=0){const a=[...t.matchAll(errorRE)],n=new Map(a.map((e,r)=>{const n=parseInt(e[1]),o=a[r+1],i=o?o.index:t.length;return[n-1,t.substring(e.index,i)]}));return e.split("\n").map((e,t)=>{const a=n.get(t);return`${t+1+r}: ${e}${a?`\n\n^^^ ${a}`:""}`}).join("\n")}const spaceRE=/^[ \t]*\n/;function prepShaderSource(e){let t=0;return spaceRE.test(e)&&(t=1,e=e.replace(spaceRE,"")),{lineOffset:t,shaderSource:e}}function reportError(e,t){return e.errorCallback(t),e.callback&&setTimeout(()=>{e.callback(`${t}\n${e.errors.join("\n")}`)}),null}function checkShaderStatus(e,t,r,a){a=a||error;if(!e.getShaderParameter(r,COMPILE_STATUS)){const n=e.getShaderInfoLog(r),{lineOffset:o,shaderSource:i}=prepShaderSource(e.getShaderSource(r)),s=`${addLineNumbersWithError(i,n,o)}\nError compiling ${glEnumToString(e,t)}: ${n}`;return a(s),s}return""}function getProgramOptions(e,t,r){let a,n,o;if("function"==typeof t&&(r=t,t=void 0),"function"==typeof e)r=e,e=void 0;else if(e&&!Array.isArray(e)){const t=e;r=t.errorCallback,e=t.attribLocations,a=t.transformFeedbackVaryings,n=t.transformFeedbackMode,o=t.callback}const i=r||error,s=[],l={errorCallback(e,...t){s.push(e),i(e,...t)},transformFeedbackVaryings:a,transformFeedbackMode:n,callback:o,errors:s};{let r={};Array.isArray(e)?e.forEach(function(e,a){r[e]=t?t[a]:a}):r=e||{},l.attribLocations=r}return l}const defaultShaderType=["VERTEX_SHADER","FRAGMENT_SHADER"];function getShaderTypeFromScriptType(e,t){return t.indexOf("frag")>=0?FRAGMENT_SHADER:t.indexOf("vert")>=0?VERTEX_SHADER:void 0}function deleteProgramAndShaders(e,t,r){const a=e.getAttachedShaders(t);for(const t of a)r.has(t)&&e.deleteShader(t);e.deleteProgram(t)}const wait=(e=0)=>new Promise(t=>setTimeout(t,e));function createProgramNoCheck(e,t,r){const a=e.createProgram(),{attribLocations:n,transformFeedbackVaryings:o,transformFeedbackMode:i}=getProgramOptions(r);for(let r=0;r<t.length;++r){let n=t[r];if("string"==typeof n){const t=getElementById(n),o=t?t.text:n;let i=e[defaultShaderType[r]];t&&t.type&&(i=getShaderTypeFromScriptType(e,t.type)||i),n=e.createShader(i),e.shaderSource(n,prepShaderSource(o).shaderSource),e.compileShader(n),e.attachShader(a,n)}}Object.entries(n).forEach(([t,r])=>e.bindAttribLocation(a,r,t));{let t=o;t&&(t.attribs&&(t=t.attribs),Array.isArray(t)||(t=Object.keys(t)),e.transformFeedbackVaryings(a,t,i||SEPARATE_ATTRIBS))}return e.linkProgram(a),a}function createProgram(e,t,r,a,n){const o=getProgramOptions(r,a,n),i=new Set(t),s=createProgramNoCheck(e,t,o);function l(e,t){const r=getProgramErrors(e,t,o.errorCallback);return r&&deleteProgramAndShaders(e,t,i),r}if(!o.callback)return l(e,s)?void 0:s;waitForProgramLinkCompletionAsync(e,s).then(()=>{const t=l(e,s);o.callback(t,t?void 0:s)})}function wrapCallbackFnToAsyncFn(e){return function(t,r,...a){return new Promise((n,o)=>{const i=getProgramOptions(...a);i.callback=(e,t)=>{e?o(e):n(t)},e(t,r,i)})}}const createProgramAsync=wrapCallbackFnToAsyncFn(createProgram),createProgramInfoAsync=wrapCallbackFnToAsyncFn(createProgramInfo);async function waitForProgramLinkCompletionAsync(e,t){const r=e.getExtension("KHR_parallel_shader_compile"),a=r?(e,t)=>e.getProgramParameter(t,r.COMPLETION_STATUS_KHR):()=>!0;let n=0;do{await wait(n),n=1e3/60}while(!a(e,t))}async function waitForAllProgramsLinkCompletionAsync(e,t){for(const r of Object.values(t))await waitForProgramLinkCompletionAsync(e,r)}function getProgramErrors(e,t,r){r=r||error;if(!e.getProgramParameter(t,LINK_STATUS)){const a=e.getProgramInfoLog(t);r(`Error in program linking: ${a}`);return`${a}\n${e.getAttachedShaders(t).map(t=>checkShaderStatus(e,e.getShaderParameter(t,e.SHADER_TYPE),t,r)).filter(e=>e).join("\n")}`}}function createProgramFromScripts(e,t,r,a,n){const o=getProgramOptions(r,a,n),i=[];for(const e of t){const t=getElementById(e);if(!t)return reportError(o,`unknown script element: ${e}`);i.push(t.text)}return createProgram(e,i,o)}function createProgramFromSources(e,t,r,a,n){return createProgram(e,t,r,a,n)}function isBuiltIn(e){const t=e.name;return t.startsWith("gl_")||t.startsWith("webgl_")}const tokenRE=/(\.|\[|]|\w+)/g,isDigit=e=>e>="0"&&e<="9";function addSetterToUniformTree(e,t,r,a){const n=e.split(tokenRE).filter(e=>""!==e);let o=0,i="";for(;;){const e=n[o++];i+=e;const s=isDigit(e[0]),l=s?parseInt(e):e;s&&(i+=n[o++]);if(o===n.length){r[l]=t;break}{const e=n[o++],t="["===e,s=r[l]||(t?[]:{});r[l]=s,r=s,a[i]=a[i]||function(e){return function(t){setUniformTree(e,t)}}(s),i+=e}}}function createUniformSetters(e,t){let r=0;function a(t,a,n){const o=a.name.endsWith("[0]"),i=a.type,s=typeMap[i];if(!s)throw new Error(`unknown type: 0x${i.toString(16)}`);let l;if(s.bindPoint){const t=r;r+=a.size,l=o?s.arraySetter(e,i,t,n,a.size):s.setter(e,i,t,n,a.size)}else l=s.arraySetter&&o?s.arraySetter(e,n):s.setter(e,n);return l.location=n,l}const n={},o={},i=e.getProgramParameter(t,ACTIVE_UNIFORMS);for(let r=0;r<i;++r){const i=e.getActiveUniform(t,r);if(isBuiltIn(i))continue;let s=i.name;s.endsWith("[0]")&&(s=s.substr(0,s.length-3));const l=e.getUniformLocation(t,i.name);if(l){const e=a(0,i,l);n[s]=e,addSetterToUniformTree(s,e,o,n)}}return n}function createTransformFeedbackInfo(e,t){const r={},a=e.getProgramParameter(t,TRANSFORM_FEEDBACK_VARYINGS);for(let n=0;n<a;++n){const a=e.getTransformFeedbackVarying(t,n);r[a.name]={index:n,type:a.type,size:a.size}}return r}function bindTransformFeedbackInfo(e,t,r){t.transformFeedbackInfo&&(t=t.transformFeedbackInfo),r.attribs&&(r=r.attribs);for(const a in r){const n=t[a];if(n){const t=r[a];t.offset?e.bindBufferRange(TRANSFORM_FEEDBACK_BUFFER,n.index,t.buffer,t.offset,t.size):e.bindBufferBase(TRANSFORM_FEEDBACK_BUFFER,n.index,t.buffer)}}}function createTransformFeedback(e,t,r){const a=e.createTransformFeedback();return e.bindTransformFeedback(TRANSFORM_FEEDBACK,a),e.useProgram(t.program),bindTransformFeedbackInfo(e,t,r),e.bindTransformFeedback(TRANSFORM_FEEDBACK,null),a}function createUniformBlockSpecFromProgram(e,t){const r=e.getProgramParameter(t,ACTIVE_UNIFORMS),a=[],n=[];for(let o=0;o<r;++o){n.push(o),a.push({});const r=e.getActiveUniform(t,o);a[o].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach(function(r){const o=r[0],i=r[1];e.getActiveUniforms(t,n,e[o]).forEach(function(e,t){a[t][i]=e})});const o={},i=e.getProgramParameter(t,ACTIVE_UNIFORM_BLOCKS);for(let r=0;r<i;++r){const a=e.getActiveUniformBlockName(t,r),n={index:e.getUniformBlockIndex(t,a),usedByVertexShader:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),usedByFragmentShader:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),size:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_DATA_SIZE),uniformIndices:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES)};n.used=n.usedByVertexShader||n.usedByFragmentShader,o[a]=n}return{blockSpecs:o,uniformData:a}}const arraySuffixRE=/\[\d+\]\.$/,pad=(e,t)=>((e+(t-1))/t|0)*t;function createUniformBlockUniformSetter(e,t,r,a){if(t||r){a=a||1;const t=e.length/4;return function(r){let n=0,o=0;for(let i=0;i<t;++i){for(let t=0;t<a;++t)e[n++]=r[o++];n+=4-a}}}return function(t){t.length?e.set(t):e[0]=t}}function createUniformBlockInfoFromProgram(e,t,r,a){const n=r.blockSpecs,o=r.uniformData,i=n[a];if(!i)return warn("no uniform block object named:",a),{name:a,uniforms:{}};const s=new ArrayBuffer(i.size),l=e.createBuffer(),c=i.index;e.bindBuffer(UNIFORM_BUFFER,l),e.uniformBlockBinding(t,i.index,c);let u=a+".";arraySuffixRE.test(u)&&(u=u.replace(arraySuffixRE,"."));const d={},p={},f={};return i.uniformIndices.forEach(function(e){const t=o[e];let r=t.name;r.startsWith(u)&&(r=r.substr(u.length));const a=r.endsWith("[0]");a&&(r=r.substr(0,r.length-3));const n=typeMap[t.type],i=n.Type,l=a?pad(n.size,16)*t.size:n.size*t.size,c=new i(s,t.offset,l/i.BYTES_PER_ELEMENT);d[r]=c;const m=createUniformBlockUniformSetter(c,a,n.rows,n.cols);p[r]=m,addSetterToUniformTree(r,m,f,p)}),{name:a,array:s,asFloat:new Float32Array(s),buffer:l,uniforms:d,setters:p}}function createUniformBlockInfo(e,t,r){return createUniformBlockInfoFromProgram(e,t.program,t.uniformBlockSpec,r)}function bindUniformBlock(e,t,r){const a=(t.uniformBlockSpec||t).blockSpecs[r.name];if(a){const t=a.index;return e.bindBufferRange(UNIFORM_BUFFER,t,r.buffer,r.offset||0,r.array.byteLength),!0}return!1}function setUniformBlock(e,t,r){bindUniformBlock(e,t,r)&&e.bufferData(UNIFORM_BUFFER,r.array,DYNAMIC_DRAW)}function setBlockUniforms(e,t){const r=e.setters;for(const e in t){const a=r[e];if(a){a(t[e])}}}function setUniformTree(e,t){for(const r in t){const a=e[r];"function"==typeof a?a(t[r]):setUniformTree(e[r],t[r])}}function setUniforms(e,...t){const r=e.uniformSetters||e,a=t.length;for(let e=0;e<a;++e){const a=t[e];if(Array.isArray(a)){const e=a.length;for(let t=0;t<e;++t)setUniforms(r,a[t])}else for(const e in a){const t=r[e];t&&t(a[e])}}}const setUniformsAndBindTextures=setUniforms;function createAttributeSetters(e,t){const r={},a=e.getProgramParameter(t,ACTIVE_ATTRIBUTES);for(let n=0;n<a;++n){const a=e.getActiveAttrib(t,n);if(isBuiltIn(a))continue;const o=e.getAttribLocation(t,a.name),i=attrTypeMap[a.type],s=i.setter(e,o,i);s.location=o,r[a.name]=s}return r}function setAttributes(e,t){for(const r in t){const a=e[r];a&&a(t[r])}}function setBuffersAndAttributes(e,t,r){r.vertexArrayObject?e.bindVertexArray(r.vertexArrayObject):(setAttributes(t.attribSetters||t,r.attribs),r.indices&&e.bindBuffer(ELEMENT_ARRAY_BUFFER$1,r.indices))}function createProgramInfoFromProgram(e,t){const r={program:t,uniformSetters:createUniformSetters(e,t),attribSetters:createAttributeSetters(e,t)};return isWebGL2(e)&&(r.uniformBlockSpec=createUniformBlockSpecFromProgram(e,t),r.transformFeedbackInfo=createTransformFeedbackInfo(e,t)),r}const notIdRE=/\s|{|}|;/;function createProgramInfo(e,t,r,a,n){const o=getProgramOptions(r,a,n),i=[];if(t=t.map(function(e){if(!notIdRE.test(e)){const t=getElementById(e);if(t)e=t.text;else{const t=`no element with id: ${e}`;o.errorCallback(t),i.push(t)}}return e}),i.length)return reportError(o,"");const s=o.callback;s&&(o.callback=(t,r)=>{s(t,t?void 0:createProgramInfoFromProgram(e,r))});const l=createProgramFromSources(e,t,o);return l?createProgramInfoFromProgram(e,l):null}function checkAllPrograms(e,t,r,a,n){for(const[o,i]of Object.entries(t)){const s={...n},l=r[o];Array.isArray(l)||Object.assign(s,l);const c=getProgramErrors(e,i,s.errorCallback);if(c){for(const r of Object.values(t)){const t=e.getAttachedShaders(r);e.deleteProgram(r);for(const r of t)a.has(r)||e.deleteShader(r)}return c}}}function createPrograms(e,t,r={}){const a=new Set,n=Object.fromEntries(Object.entries(t).map(([t,n])=>{const o={...r},i=Array.isArray(n)?n:n.shaders;return Array.isArray(n)||Object.assign(o,n),i.forEach(a.add,a),[t,createProgramNoCheck(e,i,o)]}));if(r.callback)return void waitForAllProgramsLinkCompletionAsync(e,n).then(()=>{const o=checkAllPrograms(e,n,t,a,r);r.callback(o,o?void 0:n)});return checkAllPrograms(e,n,t,a,r)?void 0:n}function createProgramInfos(e,t,r){function a(e,t){return Object.fromEntries(Object.entries(t).map(([t,r])=>[t,createProgramInfoFromProgram(e,r)]))}const n=(r=getProgramOptions(r)).callback;n&&(r.callback=(t,r)=>{n(t,t?void 0:a(e,r))});const o=createPrograms(e,t,r);if(!n&&o)return a(e,o)}const createProgramsAsync=wrapCallbackFnToAsyncFn(createPrograms),createProgramInfosAsync=wrapCallbackFnToAsyncFn(createProgramInfos);var programs=Object.freeze({__proto__:null,createAttributeSetters:createAttributeSetters,createProgram:createProgram,createProgramAsync:createProgramAsync,createPrograms:createPrograms,createProgramsAsync:createProgramsAsync,createProgramFromScripts:createProgramFromScripts,createProgramFromSources:createProgramFromSources,createProgramInfo:createProgramInfo,createProgramInfoAsync:createProgramInfoAsync,createProgramInfos:createProgramInfos,createProgramInfosAsync:createProgramInfosAsync,createProgramInfoFromProgram:createProgramInfoFromProgram,createUniformSetters:createUniformSetters,createUniformBlockSpecFromProgram:createUniformBlockSpecFromProgram,createUniformBlockInfoFromProgram:createUniformBlockInfoFromProgram,createUniformBlockInfo:createUniformBlockInfo,createTransformFeedback:createTransformFeedback,createTransformFeedbackInfo:createTransformFeedbackInfo,bindTransformFeedbackInfo:bindTransformFeedbackInfo,setAttributes:setAttributes,setBuffersAndAttributes:setBuffersAndAttributes,setUniforms:setUniforms,setUniformsAndBindTextures:setUniformsAndBindTextures,setUniformBlock:setUniformBlock,setBlockUniforms:setBlockUniforms,bindUniformBlock:bindUniformBlock});const TRIANGLES=4,UNSIGNED_SHORT=5123;function drawBufferInfo(e,t,r,a,n,o){r=void 0===r?TRIANGLES:r;const i=t.indices,s=t.elementType,l=void 0===a?t.numElements:a;n=void 0===n?0:n,s||i?void 0!==o?e.drawElementsInstanced(r,l,void 0===s?UNSIGNED_SHORT:t.elementType,n,o):e.drawElements(r,l,void 0===s?UNSIGNED_SHORT:t.elementType,n):void 0!==o?e.drawArraysInstanced(r,n,l,o):e.drawArrays(r,n,l)}function drawObjectList(e,t){let r=null,a=null;t.forEach(function(t){if(!1===t.active)return;const n=t.programInfo,o=t.vertexArrayInfo||t.bufferInfo;let i=!1;const s=void 0===t.type?TRIANGLES:t.type;n!==r&&(r=n,e.useProgram(n.program),i=!0),(i||o!==a)&&(a&&a.vertexArrayObject&&!o.vertexArrayObject&&e.bindVertexArray(null),a=o,setBuffersAndAttributes(e,n,o)),setUniforms(n,t.uniforms),drawBufferInfo(e,o,s,t.count,t.offset,t.instanceCount)}),a&&a.vertexArrayObject&&e.bindVertexArray(null)}var draw=Object.freeze({__proto__:null,drawBufferInfo:drawBufferInfo,drawObjectList:drawObjectList});const FRAMEBUFFER=36160,RENDERBUFFER=36161,TEXTURE_2D=3553,UNSIGNED_BYTE=5121,DEPTH_COMPONENT=6402,RGBA=6408,DEPTH_COMPONENT24=33190,DEPTH_COMPONENT32F=36012,DEPTH24_STENCIL8=35056,DEPTH32F_STENCIL8=36013,RGBA4=32854,RGB5_A1=32855,RGB565=36194,DEPTH_COMPONENT16=33189,STENCIL_INDEX=6401,STENCIL_INDEX8=36168,DEPTH_STENCIL=34041,COLOR_ATTACHMENT0=36064,DEPTH_ATTACHMENT=36096,STENCIL_ATTACHMENT=36128,DEPTH_STENCIL_ATTACHMENT=33306,CLAMP_TO_EDGE=33071,LINEAR=9729,defaultAttachments=[{format:RGBA,type:UNSIGNED_BYTE,min:LINEAR,wrap:CLAMP_TO_EDGE},{format:DEPTH_STENCIL}],attachmentsByFormat={};function getAttachmentPointForFormat(e,t){return attachmentsByFormat[e]||attachmentsByFormat[t]}attachmentsByFormat[DEPTH_STENCIL]=DEPTH_STENCIL_ATTACHMENT,attachmentsByFormat[STENCIL_INDEX]=STENCIL_ATTACHMENT,attachmentsByFormat[STENCIL_INDEX8]=STENCIL_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT16]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT24]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT32F]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH24_STENCIL8]=DEPTH_STENCIL_ATTACHMENT,attachmentsByFormat[DEPTH32F_STENCIL8]=DEPTH_STENCIL_ATTACHMENT;const renderbufferFormats={};function isRenderbufferFormat(e){return renderbufferFormats[e]}renderbufferFormats[RGBA4]=!0,renderbufferFormats[RGB5_A1]=!0,renderbufferFormats[RGB565]=!0,renderbufferFormats[DEPTH_STENCIL]=!0,renderbufferFormats[DEPTH_COMPONENT16]=!0,renderbufferFormats[STENCIL_INDEX]=!0,renderbufferFormats[STENCIL_INDEX8]=!0;const MAX_COLOR_ATTACHMENT_POINTS=32;function isColorAttachmentPoint(e){return e>=COLOR_ATTACHMENT0&&e<COLOR_ATTACHMENT0+MAX_COLOR_ATTACHMENT_POINTS}function createFramebufferInfo(e,t,r,a){const n=FRAMEBUFFER,o=e.createFramebuffer();e.bindFramebuffer(n,o),r=r||e.drawingBufferWidth,a=a||e.drawingBufferHeight;const i=[],s={framebuffer:o,attachments:[],width:r,height:a};return(t=t||defaultAttachments).forEach(function(t,o){let l=t.attachment;const c=t.samples,u=t.format;let d=t.attachmentPoint||getAttachmentPointForFormat(u,t.internalFormat);if(d||(d=COLOR_ATTACHMENT0+o),isColorAttachmentPoint(d)&&i.push(d),!l)if(void 0!==c||isRenderbufferFormat(u))l=e.createRenderbuffer(),e.bindRenderbuffer(RENDERBUFFER,l),c>1?e.renderbufferStorageMultisample(RENDERBUFFER,c,u,r,a):e.renderbufferStorage(RENDERBUFFER,u,r,a);else{const n=Object.assign({},t);n.width=r,n.height=a,void 0===n.auto&&(n.auto=!1,n.min=n.min||n.minMag||LINEAR,n.mag=n.mag||n.minMag||LINEAR,n.wrapS=n.wrapS||n.wrap||CLAMP_TO_EDGE,n.wrapT=n.wrapT||n.wrap||CLAMP_TO_EDGE),l=createTexture(e,n)}if(isRenderbuffer(e,l))e.framebufferRenderbuffer(n,d,RENDERBUFFER,l);else{if(!isTexture(e,l))throw new Error("unknown attachment type");void 0!==t.layer?e.framebufferTextureLayer(n,d,l,t.level||0,t.layer):e.framebufferTexture2D(n,d,t.target||TEXTURE_2D,l,t.level||0)}s.attachments.push(l)}),e.drawBuffers&&e.drawBuffers(i),s}function resizeFramebufferInfo(e,t,r,a,n){a=a||e.drawingBufferWidth,n=n||e.drawingBufferHeight,t.width=a,t.height=n,(r=r||defaultAttachments).forEach(function(r,o){const i=t.attachments[o],s=r.format,l=r.samples;if(void 0!==l||isRenderbuffer(e,i))e.bindRenderbuffer(RENDERBUFFER,i),l>1?e.renderbufferStorageMultisample(RENDERBUFFER,l,s,a,n):e.renderbufferStorage(RENDERBUFFER,s,a,n);else{if(!isTexture(e,i))throw new Error("unknown attachment type");resizeTexture(e,i,r,a,n)}})}function bindFramebufferInfo(e,t,r){r=r||FRAMEBUFFER,t?(e.bindFramebuffer(r,t.framebuffer),e.viewport(0,0,t.width,t.height)):(e.bindFramebuffer(r,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight))}var framebuffers=Object.freeze({__proto__:null,bindFramebufferInfo:bindFramebufferInfo,createFramebufferInfo:createFramebufferInfo,resizeFramebufferInfo:resizeFramebufferInfo});const ELEMENT_ARRAY_BUFFER=34963;function createVertexArrayInfo(e,t,r){const a=e.createVertexArray();return e.bindVertexArray(a),t.length||(t=[t]),t.forEach(function(t){setBuffersAndAttributes(e,t,r)}),e.bindVertexArray(null),{numElements:r.numElements,elementType:r.elementType,vertexArrayObject:a}}function createVAOAndSetAttributes(e,t,r,a){const n=e.createVertexArray();return e.bindVertexArray(n),setAttributes(t,r),a&&e.bindBuffer(ELEMENT_ARRAY_BUFFER,a),e.bindVertexArray(null),n}function createVAOFromBufferInfo(e,t,r){return createVAOAndSetAttributes(e,t.attribSetters||t,r.attribs,r.indices)}var vertexArrays=Object.freeze({__proto__:null,createVertexArrayInfo:createVertexArrayInfo,createVAOAndSetAttributes:createVAOAndSetAttributes,createVAOFromBufferInfo:createVAOFromBufferInfo});const defaults={addExtensionsToContext:!0};function setDefaults(e){copyExistingProperties(e,defaults),setDefaults$2(e),setDefaults$1(e)}const prefixRE=/^(.*?)_/;function addExtensionToContext(e,t){glEnumToString(e,0);const r=e.getExtension(t);if(r){const a={},n=prefixRE.exec(t)[1],o="_"+n;for(const t in r){const i=r[t],s="function"==typeof i,l=s?n:o;let c=t;t.endsWith(l)&&(c=t.substring(0,t.length-l.length)),void 0!==e[c]?s||e[c]===i||warn$1(c,e[c],i,t):s?e[c]=function(e){return function(){return e.apply(r,arguments)}}(i):(e[c]=i,a[c]=i)}a.constructor={name:r.constructor.name},glEnumToString(a,0)}return r}const supportedExtensions=["ANGLE_instanced_arrays","EXT_blend_minmax","EXT_color_buffer_float","EXT_color_buffer_half_float","EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2","EXT_frag_depth","EXT_sRGB","EXT_shader_texture_lod","EXT_texture_filter_anisotropic","OES_element_index_uint","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_color_buffer_float","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb","WEBGL_depth_texture","WEBGL_draw_buffers"];function addExtensionsToContext(e){for(let t=0;t<supportedExtensions.length;++t)addExtensionToContext(e,supportedExtensions[t])}function create3DContext(e,t){const r=["webgl","experimental-webgl"];let a=null;for(let n=0;n<r.length;++n)if(a=e.getContext(r[n],t),a){defaults.addExtensionsToContext&&addExtensionsToContext(a);break}return a}function getWebGLContext(e,t){return create3DContext(e,t)}function createContext(e,t){const r=["webgl2","webgl","experimental-webgl"];let a=null;for(let n=0;n<r.length;++n)if(a=e.getContext(r[n],t),a){defaults.addExtensionsToContext&&addExtensionsToContext(a);break}return a}function getContext(e,t){return createContext(e,t)}function resizeCanvasToDisplaySize(e,t){t=t||1,t=Math.max(0,t);const r=e.clientWidth*t|0,a=e.clientHeight*t|0;return(e.width!==r||e.height!==a)&&(e.width=r,e.height=a,!0)}var twgl_module=Object.freeze({__proto__:null,addExtensionsToContext:addExtensionsToContext,attributes:attributes,bindFramebufferInfo:bindFramebufferInfo,bindTransformFeedbackInfo:bindTransformFeedbackInfo,bindUniformBlock:bindUniformBlock,canFilter:canFilter,canGenerateMipmap:canGenerateMipmap,createAttribsFromArrays:createAttribsFromArrays,createAttributeSetters:createAttributeSetters,createBufferFromArray:createBufferFromArray,createBufferFromTypedArray:createBufferFromTypedArray,createBufferInfoFromArrays:createBufferInfoFromArrays,createBuffersFromArrays:createBuffersFromArrays,createFramebufferInfo:createFramebufferInfo,createProgram:createProgram,createProgramAsync:createProgramAsync,createProgramFromScripts:createProgramFromScripts,createProgramFromSources:createProgramFromSources,createProgramInfo:createProgramInfo,createProgramInfoAsync:createProgramInfoAsync,createProgramInfoFromProgram:createProgramInfoFromProgram,createProgramInfos:createProgramInfos,createProgramInfosAsync:createProgramInfosAsync,createPrograms:createPrograms,createProgramsAsync:createProgramsAsync,createSampler:createSampler,createSamplers:createSamplers,createTexture:createTexture,createTextures:createTextures,createTransformFeedback:createTransformFeedback,createTransformFeedbackInfo:createTransformFeedbackInfo,createUniformBlockInfo:createUniformBlockInfo,createUniformBlockInfoFromProgram:createUniformBlockInfoFromProgram,createUniformBlockSpecFromProgram:createUniformBlockSpecFromProgram,createUniformSetters:createUniformSetters,createVAOAndSetAttributes:createVAOAndSetAttributes,createVAOFromBufferInfo:createVAOFromBufferInfo,createVertexArrayInfo:createVertexArrayInfo,draw:draw,drawBufferInfo:drawBufferInfo,drawObjectList:drawObjectList,framebuffers:framebuffers,getArray_:getArray,getBytesPerElementForInternalFormat:getBytesPerElementForInternalFormat,getContext:getContext,getFormatAndTypeForInternalFormat:getFormatAndTypeForInternalFormat,getGLTypeForTypedArray:getGLTypeForTypedArray,getGLTypeForTypedArrayType:getGLTypeForTypedArrayType,getNumComponentsForFormat:getNumComponentsForFormat,getNumComponents_:getNumComponents,getTypedArrayTypeForGLType:getTypedArrayTypeForGLType,getWebGLContext:getWebGLContext,glEnumToString:glEnumToString,isArrayBuffer:isArrayBuffer$1,isWebGL1:isWebGL1,isWebGL2:isWebGL2,loadTextureFromUrl:loadTextureFromUrl,programs:programs,resizeCanvasToDisplaySize:resizeCanvasToDisplaySize,resizeFramebufferInfo:resizeFramebufferInfo,resizeTexture:resizeTexture,setAttribInfoBufferFromArray:setAttribInfoBufferFromArray,setAttributeDefaults_:setDefaults$2,setAttributePrefix:setAttributePrefix,setAttributes:setAttributes,setBlockUniforms:setBlockUniforms,setBuffersAndAttributes:setBuffersAndAttributes,setDefaultTextureColor:setDefaultTextureColor,setDefaults:setDefaults,setEmptyTexture:setEmptyTexture,setSamplerParameters:setSamplerParameters,setTextureDefaults_:setDefaults$1,setTextureFilteringForSize:setTextureFilteringForSize,setTextureFromArray:setTextureFromArray,setTextureFromElement:setTextureFromElement,setTextureParameters:setTextureParameters,setUniformBlock:setUniformBlock,setUniforms:setUniforms,setUniformsAndBindTextures:setUniformsAndBindTextures,textures:textures,typedarrays:typedarrays,utils:utils,vertexArrays:vertexArrays});function earcut(e,t,r=2){const a=t&&t.length,n=a?t[0]*r:e.length;let o=linkedList(e,0,n,r,!0);const i=[];if(!o||o.next===o.prev)return i;let s,l,c;if(a&&(o=eliminateHoles(e,t,o,r)),e.length>80*r){s=e[0],l=e[1];let t=s,a=l;for(let o=r;o<n;o+=r){const r=e[o],n=e[o+1];r<s&&(s=r),n<l&&(l=n),r>t&&(t=r),n>a&&(a=n)}c=Math.max(t-s,a-l),c=0!==c?32767/c:0}return earcutLinked(o,i,r,s,l,c,0),i}function linkedList(e,t,r,a,n){let o;if(n===signedArea(e,t,r,a)>0)for(let n=t;n<r;n+=a)o=insertNode(n/a|0,e[n],e[n+1],o);else for(let n=r-a;n>=t;n-=a)o=insertNode(n/a|0,e[n],e[n+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);let r,a=e;do{if(r=!1,a.steiner||!equals(a,a.next)&&0!==area(a.prev,a,a.next))a=a.next;else{if(removeNode(a),a=t=a.prev,a===a.next)break;r=!0}}while(r||a!==t);return t}function earcutLinked(e,t,r,a,n,o,i){if(!e)return;!i&&o&&indexCurve(e,a,n,o);let s=e;for(;e.prev!==e.next;){const l=e.prev,c=e.next;if(o?isEarHashed(e,a,n,o):isEar(e))t.push(l.i,e.i,c.i),removeNode(e),e=c.next,s=c.next;else if((e=c)===s){i?1===i?earcutLinked(e=cureLocalIntersections(filterPoints(e),t),t,r,a,n,o,2):2===i&&splitEarcut(e,t,r,a,n,o):earcutLinked(filterPoints(e),t,r,a,n,o,1);break}}}function isEar(e){const t=e.prev,r=e,a=e.next;if(area(t,r,a)>=0)return!1;const n=t.x,o=r.x,i=a.x,s=t.y,l=r.y,c=a.y,u=Math.min(n,o,i),d=Math.min(s,l,c),p=Math.max(n,o,i),f=Math.max(s,l,c);let m=a.next;for(;m!==t;){if(m.x>=u&&m.x<=p&&m.y>=d&&m.y<=f&&pointInTriangleExceptFirst(n,s,o,l,i,c,m.x,m.y)&&area(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function isEarHashed(e,t,r,a){const n=e.prev,o=e,i=e.next;if(area(n,o,i)>=0)return!1;const s=n.x,l=o.x,c=i.x,u=n.y,d=o.y,p=i.y,f=Math.min(s,l,c),m=Math.min(u,d,p),y=Math.max(s,l,c),g=Math.max(u,d,p),x=zOrder(f,m,t,r,a),A=zOrder(y,g,t,r,a);let T=e.prevZ,h=e.nextZ;for(;T&&T.z>=x&&h&&h.z<=A;){if(T.x>=f&&T.x<=y&&T.y>=m&&T.y<=g&&T!==n&&T!==i&&pointInTriangleExceptFirst(s,u,l,d,c,p,T.x,T.y)&&area(T.prev,T,T.next)>=0)return!1;if(T=T.prevZ,h.x>=f&&h.x<=y&&h.y>=m&&h.y<=g&&h!==n&&h!==i&&pointInTriangleExceptFirst(s,u,l,d,c,p,h.x,h.y)&&area(h.prev,h,h.next)>=0)return!1;h=h.nextZ}for(;T&&T.z>=x;){if(T.x>=f&&T.x<=y&&T.y>=m&&T.y<=g&&T!==n&&T!==i&&pointInTriangleExceptFirst(s,u,l,d,c,p,T.x,T.y)&&area(T.prev,T,T.next)>=0)return!1;T=T.prevZ}for(;h&&h.z<=A;){if(h.x>=f&&h.x<=y&&h.y>=m&&h.y<=g&&h!==n&&h!==i&&pointInTriangleExceptFirst(s,u,l,d,c,p,h.x,h.y)&&area(h.prev,h,h.next)>=0)return!1;h=h.nextZ}return!0}function cureLocalIntersections(e,t){let r=e;do{const a=r.prev,n=r.next.next;!equals(a,n)&&intersects(a,r,r.next,n)&&locallyInside(a,n)&&locallyInside(n,a)&&(t.push(a.i,r.i,n.i),removeNode(r),removeNode(r.next),r=e=n),r=r.next}while(r!==e);return filterPoints(r)}function splitEarcut(e,t,r,a,n,o){let i=e;do{let e=i.next.next;for(;e!==i.prev;){if(i.i!==e.i&&isValidDiagonal(i,e)){let s=splitPolygon(i,e);return i=filterPoints(i,i.next),s=filterPoints(s,s.next),earcutLinked(i,t,r,a,n,o,0),void earcutLinked(s,t,r,a,n,o,0)}e=e.next}i=i.next}while(i!==e)}function eliminateHoles(e,t,r,a){const n=[];for(let r=0,o=t.length;r<o;r++){const i=linkedList(e,t[r]*a,r<o-1?t[r+1]*a:e.length,a,!1);i===i.next&&(i.steiner=!0),n.push(getLeftmost(i))}n.sort(compareXYSlope);for(let e=0;e<n.length;e++)r=eliminateHole(n[e],r);return r}function compareXYSlope(e,t){let r=e.x-t.x;if(0===r&&(r=e.y-t.y,0===r)){r=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return r}function eliminateHole(e,t){const r=findHoleBridge(e,t);if(!r)return t;const a=splitPolygon(r,e);return filterPoints(a,a.next),filterPoints(r,r.next)}function findHoleBridge(e,t){let r=t;const a=e.x,n=e.y;let o,i=-1/0;if(equals(e,r))return r;do{if(equals(e,r.next))return r.next;if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){const e=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=a&&e>i&&(i=e,o=r.x<r.next.x?r:r.next,e===a))return o}r=r.next}while(r!==t);if(!o)return null;const s=o,l=o.x,c=o.y;let u=1/0;r=o;do{if(a>=r.x&&r.x>=l&&a!==r.x&&pointInTriangle(n<c?a:i,n,l,c,n<c?i:a,n,r.x,r.y)){const t=Math.abs(n-r.y)/(a-r.x);locallyInside(r,e)&&(t<u||t===u&&(r.x>o.x||r.x===o.x&&sectorContainsSector(o,r)))&&(o=r,u=t)}r=r.next}while(r!==s);return o}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,r,a){let n=e;do{0===n.z&&(n.z=zOrder(n.x,n.y,t,r,a)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,sortLinked(n)}function sortLinked(e){let t,r=1;do{let a,n=e;e=null;let o=null;for(t=0;n;){t++;let i=n,s=0;for(let e=0;e<r&&(s++,i=i.nextZ,i);e++);let l=r;for(;s>0||l>0&&i;)0!==s&&(0===l||!i||n.z<=i.z)?(a=n,n=n.nextZ,s--):(a=i,i=i.nextZ,l--),o?o.nextZ=a:e=a,a.prevZ=o,o=a;n=i}o.nextZ=null,r*=2}while(t>1);return e}function zOrder(e,t,r,a,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-a)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function pointInTriangle(e,t,r,a,n,o,i,s){return(n-i)*(t-s)>=(e-i)*(o-s)&&(e-i)*(a-s)>=(r-i)*(t-s)&&(r-i)*(o-s)>=(n-i)*(a-s)}function pointInTriangleExceptFirst(e,t,r,a,n,o,i,s){return!(e===i&&t===s)&&pointInTriangle(e,t,r,a,n,o,i,s)}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,r,a){const n=sign(area(e,t,r)),o=sign(area(e,t,a)),i=sign(area(r,a,e)),s=sign(area(r,a,t));return n!==o&&i!==s||(!(0!==n||!onSegment(e,r,t))||(!(0!==o||!onSegment(e,a,t))||(!(0!==i||!onSegment(r,e,a))||!(0!==s||!onSegment(r,t,a)))))}function onSegment(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){let r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){let r=e,a=!1;const n=(e.x+t.x)/2,o=(e.y+t.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(a=!a),r=r.next}while(r!==e);return a}function splitPolygon(e,t){const r=createNode(e.i,e.x,e.y),a=createNode(t.i,t.x,t.y),n=e.next,o=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,a.next=r,r.prev=a,o.next=a,a.prev=o,a}function insertNode(e,t,r,a){const n=createNode(e,t,r);return a?(n.next=a.next,n.prev=a,a.next.prev=n,a.next=n):(n.prev=n,n.next=n),n}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function createNode(e,t,r){return{i:e,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function signedArea(e,t,r,a){let n=0;for(let o=t,i=r-a;o<r;o+=a)n+=(e[i]-e[o])*(e[o+1]+e[i+1]),i=o;return n}var earcut$1=Object.freeze({__proto__:null,default:earcut});const _handlers=[(e,t)=>{},(e,t,r,a,n,o)=>t.fillRect(r,a,n,o),(e,t,r,a,n,o)=>t.strokeRect(r,a,n,o),(e,t)=>t.beginPath(),(e,t)=>t.closePath(),(e,t,r,a)=>t.moveTo(r,a),(e,t,r,a)=>t.lineTo(r,a),(e,t)=>t.fill(),(e,t,r,a,n,o)=>t.rect(r,a,n,o),(e,t)=>t.stroke(),(e,t,r,a,n,o,i,s)=>t.arc(r,a,n,o,i,!s),(e,t,r,a,n,o)=>t.quadraticCurveTo(r,a,n,o),(e,t,r,a,n,o,i,s)=>t.bezierCurveTo(r,a,n,o,i,s),(e,t,r,a,n)=>t.fillText(r,a,n),(e,t,r,a,n)=>t.strokeText(r,a,n),null,(e,t,r)=>{t.fillStyle=r},(e,t,r)=>{t.strokeStyle=r},(e,t,r)=>{t.lineWidth=r},(e,t,r)=>{t.lineCap=r},(e,t,r)=>{t.lineJoin=r},(e,t,r)=>{t.miterLimit=r},(e,t,r)=>{t.font=r},(e,t)=>{t.save()},(e,t)=>{t.restore()},(e,t,r,a)=>{t.translate(r,a)},(e,t,r)=>{t.rotate(r)},(e,t,r,a)=>{t.scale(r,a)},(e,t)=>{t.clip()},(e,t,r)=>{t.globalAlpha=r},(e,t,r)=>{t.textAlign=r},(e,t,r)=>{t.textBaseline=r},(e,t,...r)=>{t.setLineDash(r)},(e,t,r)=>{t.lineDashOffset=r},(e,t,r,a,n,o)=>{t.clearRect(r,a,n,o)},(e,t,r,a,n,o,i)=>{t.arcTo(r,a,n,o,i)},(e,t,r,a,n,o,i)=>{t.roundRect(r,a,n,o,i)},(e,t,r,a,n,o,i,s)=>{t.transform(r,a,n,o,i,s)},(e,t,r,a,n,o,i,s)=>{t.setTransform(r,a,n,o,i,s)},(e,t)=>{t.resetTransform()},(e,t,r)=>{t.globalCompositeOperation=r},(e,t,r)=>{t.filter=r},(e,t,r)=>{t.imageSmoothingEnabled=!!r},(e,t,r)=>{t.imageSmoothingQuality=r},(e,t,r)=>{t.shadowOffsetX=r},(e,t,r)=>{t.shadowOffsetY=r},(e,t,r)=>{t.shadowBlur=r},(e,t,r)=>{t.shadowColor=r},(e,t,r,a,n,o,i,s,l)=>{e.set(l,t.createLinearGradient(r,a,n,o))},(e,t,r,a,n,o,i,s,l)=>{e.set(l,t.createRadialGradient(r,a,n,o,i,s))},(e,t,r,a,n,o,i,s,l)=>{e.set(l,t.createConicGradient(r,a,n))},(e,t,r,a,n)=>{e.get(r).addColorStop(a,n)},(e,t,r)=>{t.fillStyle=e.get(r)},(e,t,r)=>{t.strokeStyle=e.get(r)},(e,t,r,a,n,o,i)=>{if(!loadedImages.has(r))return loadImage(r);t.drawImage(loadedImages.get(r).img,a,n,o,i)}];var loadedImages=new Map;async function loadImage(e){const t={global:{stack:{}},offscreen:!0};console.warn("Requested image");const r=await interpretate(["FrontEndExecutable","'"+e+"'"],t),a=await createImageBitmap(r);r.remove(),t.img=a,loadedImages.set(e,t)}async function runOptcodes(e,t,r){let a=(t instanceof NumericArrayObject?t.buffer:t).flat(),n=0;for(let t=0,o=a.length;t<o;t+=7){const o=a[t],i=a[t+1],s=a[t+2],l=a[t+3],c=a[t+4],u=a[t+5],d=a[t+6];if(0==o)break;const p=_handlers[o],f=p(r,e,i,s,l,c,u,d,n);f&&(await f,p(r,e,i,s,l,c,u,d,n)),n++}}var canvas2d=Object.freeze({__proto__:null,runOptcodes:runOptcodes});
