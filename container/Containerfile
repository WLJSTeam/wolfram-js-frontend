# syntax=docker/dockerfile:1
FROM docker.io/wolframresearch/wolframengine AS deps

USER root
RUN apt-get update && apt-get install -y ffmpeg
User wolframengine


WORKDIR /workspace

RUN --mount=type=secret,id=wolfram_license,env=WOLFRAMSCRIPT_ENTITLEMENTID,required=true wolframscript -script Scripts/update.wls


FROM wolframresearch/wolframengine:14.2 AS final

USER root

RUN useradd -m wljs

ENV DEBIAN_FRONTEND=noninteractive

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      ffmpeg ca-certificates gnupg curl git nginx expect \
      build-essential cmake ninja-build pkg-config clang lld lldb; \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# NodeSource setup + nodejs (separate chunk, with no cached .debs kept)
RUN set -eux; \
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -; \
    apt-get update; \
    apt-get install -y --no-install-recommends -o APT::Keep-Downloaded-Packages=false nodejs; \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

COPY container/wljs-routes /etc/nginx/sites-available/default
COPY container/proxy-snippet.conf /etc/nginx/snippets/proxy.conf

RUN mkdir -p /wljs
COPY ./ /wljs/

COPY container/run.sh /run.sh
RUN chmod +x /run.sh

CMD /run.sh